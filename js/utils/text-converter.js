/**
 * 文字轉換工具
 * 處理簡繁轉換和標點符號移除
 */

import { opencc } from './opencc-lite.js';

export class TextConverter {
    constructor() {
        // 簡體字到繁體字的映射表（常用字）
        this.s2tMap = {
            // 常用字
            '爱': '愛', '国': '國', '会': '會', '这': '這', '对': '對',
            '开': '開', '关': '關', '门': '門', '时': '時', '个': '個',
            '来': '來', '为': '為', '发': '發', '说': '說', '经': '經',
            '济': '濟', '长': '長', '现': '現', '实': '實', '进': '進',
            '间': '間', '将': '將', '无': '無', '点': '點', '机': '機',
            '电': '電', '业': '業', '过': '過', '达': '達', '车': '車',
            '见': '見', '动': '動', '运': '運', '转': '轉', '让': '讓',
            '给': '給', '听': '聽', '话': '話', '语': '語', '读': '讀',
            '写': '寫', '认': '認', '识': '識', '该': '該', '当': '當',
            '应': '應', '场': '場', '号': '號', '组': '組', '织': '織',
            '统': '統', '传': '傳', '设': '設', '备': '備', '内': '內',
            '两': '兩', '连': '連', '从': '從', '东': '東', '华': '華',
            '单': '單', '买': '買', '卖': '賣', '产': '產', '众': '眾',
            '优': '優', '页': '頁', '头': '頭', '条': '條', '达': '達',
            '马': '馬', '专': '專', '带': '帶', '领': '領', '导': '導',
            '争': '爭', '战': '戰', '结': '結', '构': '構', '总': '總',
            '报': '報', '划': '劃', '现': '現', '表': '錶', '几': '幾',
            '气': '氣', '决': '決', '况': '況', '准': '準', '备': '備',
            '复': '複', '杂': '雜', '错': '錯', '网': '網', '罗': '羅',
            '钟': '鐘', '钱': '錢', '针': '針', '铁': '鐵', '钢': '鋼',
            '银': '銀', '导': '導', '创': '創', '务': '務', '责': '責',
            '师': '師', '帅': '帥', '广': '廣', '庄': '莊', '库': '庫',
            '应': '應', '张': '張', '强': '強', '归': '歸', '录': '錄',
            '彻': '徹', '态': '態', '志': '誌', '忆': '憶', '怀': '懷',
            '忧': '憂', '怎': '怎', '总': '總', '恶': '惡', '惊': '驚',
            '愿': '願', '慢': '慢', '懂': '懂', '战': '戰', '戏': '戲',
            '护': '護', '报': '報', '拟': '擬', '拥': '擁', '择': '擇',
            '换': '換', '损': '損', '摄': '攝', '搜': '搜', '摇': '搖'
        };
        
        // 建立更完整的映射
        this.initializeFullMapping();
    }
    
    /**
     * 初始化完整的簡繁對照表
     */
    initializeFullMapping() {
        // 擴充映射表
        const additionalMappings = {
            // 數字
            '万': '萬', '亿': '億',
            // 動詞
            '看': '看', '学': '學', '觉': '覺', '变': '變', '离': '離',
            '选': '選', '适': '適', '达': '達', '办': '辦', '帮': '幫',
            // 名詞
            '书': '書', '画': '畫', '区': '區', '医': '醫', '历': '歷',
            '台': '臺', '湾': '灣', '岛': '島', '乐': '樂', '药': '藥',
            // 形容詞
            '难': '難', '旧': '舊', '远': '遠', '热': '熱', '乱': '亂',
            // 其他
            '与': '與', '并': '並', '丽': '麗', '尽': '盡', '虽': '雖',
            '属': '屬', '层': '層', '岁': '歲', '币': '幣', '帮': '幫',
            '干': '幹', '并': '並', '广': '廣', '庆': '慶', '床': '床',
            '库': '庫', '应': '應', '庙': '廟', '府': '府', '废': '廢',
            '度': '度', '座': '座', '建': '建', '开': '開', '异': '異',
            '弃': '棄', '张': '張', '弯': '彎', '当': '當', '录': '錄',
            '彩': '彩', '形': '形', '彦': '彥', '影': '影', '径': '徑'
        };
        
        Object.assign(this.s2tMap, additionalMappings);
    }
    
    /**
     * 簡體轉繁體
     */
    simplifiedToTraditional(text) {
        if (!text) return text;
        
        // 使用 OpenCC 進行轉換
        return opencc.convert(text);
    }
    
    /**
     * 移除標點符號
     */
    removePunctuation(text) {
        if (!text) return text;
        
        // 定義要移除的標點符號
        const punctuationRegex = /[，。！？；：、,\.!?;:]/g;
        
        // 移除標點符號，但保留空格
        return text.replace(punctuationRegex, ' ').replace(/\s+/g, ' ').trim();
    }
    
    /**
     * 處理轉譯結果
     */
    processTranscriptionText(text, options = {}) {
        let result = text;
        
        // 簡轉繁
        if (options.convertToTraditional !== false) {
            result = this.simplifiedToTraditional(result);
        }
        
        // 移除標點
        if (options.removePunctuation !== false) {
            result = this.removePunctuation(result);
        }
        
        return result;
    }
    
    /**
     * 處理分段結果
     */
    processSegments(segments, options = {}) {
        if (!segments || !Array.isArray(segments)) return segments;
        
        return segments.map(segment => ({
            ...segment,
            text: this.processTranscriptionText(segment.text, options)
        }));
    }
}

// 匯出單例
export const textConverter = new TextConverter();