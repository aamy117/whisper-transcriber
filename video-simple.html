<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>簡化視訊播放器</title>
    <link rel="stylesheet" href="css/shared.css">
    <link rel="stylesheet" href="css/video.css">
</head>
<body>
    <div class="container">
        <h1>視訊播放器（簡化版）</h1>
        
        <!-- 上傳區域 -->
        <div id="videoUploadArea" class="upload-area">
            <div class="upload-content">
                <div class="upload-icon">📁</div>
                <h2>選擇視訊檔案</h2>
                <p>拖放視訊檔案到這裡，或點擊選擇檔案</p>
                <input type="file" id="fileInput" accept="video/*" style="display: none;">
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                    選擇檔案
                </button>
                <button class="btn btn-secondary" onclick="loadSampleVideo()">
                    載入範例視訊
                </button>
            </div>
        </div>
        
        <!-- 視訊播放器 -->
        <div id="videoWrapper" class="video-wrapper hidden">
            <div id="videoPlayerContainer" class="video-player-container">
                <video id="videoPlayer" class="video-element"></video>
                
                <!-- 載入中指示器 -->
                <div id="videoLoading" class="video-loading hidden">
                    <div class="spinner"></div>
                </div>
                
                <!-- 控制列 -->
                <div id="videoControls" class="video-controls">
                    <!-- 進度條 -->
                    <div id="progressContainer" class="progress-container">
                        <input type="range" id="progressSlider" class="progress-slider" value="0" min="0" max="100" step="0.1">
                        <div id="progressPlayed" class="progress-played" style="width: 0%"></div>
                        <div id="progressBuffered" class="progress-buffered" style="width: 0%"></div>
                    </div>
                    
                    <!-- 控制按鈕 -->
                    <div class="controls-row">
                        <div class="controls-left">
                            <button id="playPauseBtn" class="control-btn">
                                <span class="icon-play">▶</span>
                                <span class="icon-pause hidden">⏸</span>
                            </button>
                            <button id="skipBackBtn" class="control-btn" title="後退 5 秒">⏪</button>
                            <button id="skipForwardBtn" class="control-btn" title="前進 5 秒">⏩</button>
                            <span class="time-display">
                                <span id="currentTime">00:00</span> / <span id="totalTime">00:00</span>
                            </span>
                        </div>
                        
                        <div class="controls-right">
                            <button id="muteBtn" class="control-btn">
                                <span class="icon-volume">🔊</span>
                                <span class="icon-mute hidden">🔇</span>
                            </button>
                            <input type="range" id="volumeSlider" class="volume-slider" value="100" min="0" max="100">
                            <button id="speedBtn" class="control-btn">
                                <span class="speed-text">1x</span>
                            </button>
                            <div id="speedMenu" class="speed-menu hidden">
                                <div class="speed-option" data-speed="0.5">0.5x</div>
                                <div class="speed-option" data-speed="0.75">0.75x</div>
                                <div class="speed-option selected" data-speed="1">1x</div>
                                <div class="speed-option" data-speed="1.25">1.25x</div>
                                <div class="speed-option" data-speed="1.5">1.5x</div>
                                <div class="speed-option" data-speed="2">2x</div>
                            </div>
                            <button id="fullscreenBtn" class="control-btn">
                                <span class="icon-expand">⛶</span>
                                <span class="icon-compress hidden">⛶</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 檔案資訊 -->
            <div class="file-info">
                <h3>檔案資訊</h3>
                <div id="videoFileName">檔案名稱: -</div>
                <div id="videoFileSize">檔案大小: -</div>
                <div id="videoDuration">視訊長度: -</div>
                <div id="videoResolution">視訊解析度: -</div>
            </div>
        </div>
    </div>
    
    <script type="module">
        import domReadyManager from './js/video/dom-ready-manager.js';
        import { VideoPlayer } from './js/video/video-player.js';
        import { VideoUI } from './js/video/video-ui.js';
        
        let player = null;
        let ui = null;
        
        async function init() {
            try {
                // 等待 DOM 就緒
                await domReadyManager.waitForReady();
                
                const videoElement = document.getElementById('videoPlayer');
                player = new VideoPlayer(videoElement);
                ui = new VideoUI(player);
                
                // 初始化 UI
                const result = await ui.initialize();
                if (!result.success) {
                    console.error('UI 初始化失敗:', result.error);
                    return;
                }
                
                console.log('視訊播放器初始化成功');
                
                // 設置檔案選擇
                const fileInput = document.getElementById('fileInput');
                const uploadArea = document.getElementById('videoUploadArea');
                
                fileInput.addEventListener('change', handleFileSelect);
                
                // 拖放支援
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('drag-over');
                });
                
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('drag-over');
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('drag-over');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        handleFile(files[0]);
                    }
                });
                
            } catch (error) {
                console.error('初始化失敗:', error);
                alert('視訊播放器初始化失敗: ' + error.message);
            }
        }
        
        async function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                await handleFile(file);
            }
        }
        
        async function handleFile(file) {
            try {
                console.log('開始載入檔案:', file.name);
                
                // 顯示載入中
                ui.showLoading();
                
                // 載入視訊
                await player.loadFile(file);
                
                // 顯示播放器
                ui.showPlayer();
                
                // 隱藏載入中
                ui.hideLoading();
                
                console.log('檔案載入成功');
                
            } catch (error) {
                console.error('載入失敗:', error);
                ui.hideLoading();
                alert('載入視訊失敗: ' + error.message);
            }
        }
        
        // 載入範例視訊
        window.loadSampleVideo = async function() {
            try {
                console.log('載入範例視訊...');
                const response = await fetch('https://www.w3schools.com/html/mov_bbb.mp4');
                const blob = await response.blob();
                const file = new File([blob], 'big_buck_bunny.mp4', { type: 'video/mp4' });
                await handleFile(file);
            } catch (error) {
                console.error('載入範例失敗:', error);
                alert('載入範例視訊失敗: ' + error.message);
            }
        };
        
        // 啟動
        init();
    </script>
</body>
</html>