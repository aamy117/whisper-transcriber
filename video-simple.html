<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç°¡åŒ–è¦–è¨Šæ’­æ”¾å™¨</title>
    <link rel="stylesheet" href="css/shared.css">
    <link rel="stylesheet" href="css/video.css">
</head>
<body>
    <div class="container">
        <h1>è¦–è¨Šæ’­æ”¾å™¨ï¼ˆç°¡åŒ–ç‰ˆï¼‰</h1>
        
        <!-- ä¸Šå‚³å€åŸŸ -->
        <div id="videoUploadArea" class="upload-area">
            <div class="upload-content">
                <div class="upload-icon">ğŸ“</div>
                <h2>é¸æ“‡è¦–è¨Šæª”æ¡ˆ</h2>
                <p>æ‹–æ”¾è¦–è¨Šæª”æ¡ˆåˆ°é€™è£¡ï¼Œæˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ</p>
                <input type="file" id="fileInput" accept="video/*" style="display: none;">
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                    é¸æ“‡æª”æ¡ˆ
                </button>
                <button class="btn btn-secondary" onclick="loadSampleVideo()">
                    è¼‰å…¥ç¯„ä¾‹è¦–è¨Š
                </button>
            </div>
        </div>
        
        <!-- è¦–è¨Šæ’­æ”¾å™¨ -->
        <div id="videoWrapper" class="video-wrapper hidden">
            <div id="videoPlayerContainer" class="video-player-container">
                <video id="videoPlayer" class="video-element"></video>
                
                <!-- è¼‰å…¥ä¸­æŒ‡ç¤ºå™¨ -->
                <div id="videoLoading" class="video-loading hidden">
                    <div class="spinner"></div>
                </div>
                
                <!-- æ§åˆ¶åˆ— -->
                <div id="videoControls" class="video-controls">
                    <!-- é€²åº¦æ¢ -->
                    <div id="progressContainer" class="progress-container">
                        <input type="range" id="progressSlider" class="progress-slider" value="0" min="0" max="100" step="0.1">
                        <div id="progressPlayed" class="progress-played" style="width: 0%"></div>
                        <div id="progressBuffered" class="progress-buffered" style="width: 0%"></div>
                    </div>
                    
                    <!-- æ§åˆ¶æŒ‰éˆ• -->
                    <div class="controls-row">
                        <div class="controls-left">
                            <button id="playPauseBtn" class="control-btn">
                                <span class="icon-play">â–¶</span>
                                <span class="icon-pause hidden">â¸</span>
                            </button>
                            <button id="skipBackBtn" class="control-btn" title="å¾Œé€€ 5 ç§’">âª</button>
                            <button id="skipForwardBtn" class="control-btn" title="å‰é€² 5 ç§’">â©</button>
                            <span class="time-display">
                                <span id="currentTime">00:00</span> / <span id="totalTime">00:00</span>
                            </span>
                        </div>
                        
                        <div class="controls-right">
                            <button id="muteBtn" class="control-btn">
                                <span class="icon-volume">ğŸ”Š</span>
                                <span class="icon-mute hidden">ğŸ”‡</span>
                            </button>
                            <input type="range" id="volumeSlider" class="volume-slider" value="100" min="0" max="100">
                            <button id="speedBtn" class="control-btn">
                                <span class="speed-text">1x</span>
                            </button>
                            <div id="speedMenu" class="speed-menu hidden">
                                <div class="speed-option" data-speed="0.5">0.5x</div>
                                <div class="speed-option" data-speed="0.75">0.75x</div>
                                <div class="speed-option selected" data-speed="1">1x</div>
                                <div class="speed-option" data-speed="1.25">1.25x</div>
                                <div class="speed-option" data-speed="1.5">1.5x</div>
                                <div class="speed-option" data-speed="2">2x</div>
                            </div>
                            <button id="fullscreenBtn" class="control-btn">
                                <span class="icon-expand">â›¶</span>
                                <span class="icon-compress hidden">â›¶</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æª”æ¡ˆè³‡è¨Š -->
            <div class="file-info">
                <h3>æª”æ¡ˆè³‡è¨Š</h3>
                <div id="videoFileName">æª”æ¡ˆåç¨±: -</div>
                <div id="videoFileSize">æª”æ¡ˆå¤§å°: -</div>
                <div id="videoDuration">è¦–è¨Šé•·åº¦: -</div>
                <div id="videoResolution">è¦–è¨Šè§£æåº¦: -</div>
            </div>
        </div>
    </div>
    
    <script type="module">
        import domReadyManager from './js/video/dom-ready-manager.js';
        import { VideoPlayer } from './js/video/video-player.js';
        import { VideoUI } from './js/video/video-ui.js';
        
        let player = null;
        let ui = null;
        
        async function init() {
            try {
                // ç­‰å¾… DOM å°±ç·’
                await domReadyManager.waitForReady();
                
                const videoElement = document.getElementById('videoPlayer');
                player = new VideoPlayer(videoElement);
                ui = new VideoUI(player);
                
                // åˆå§‹åŒ– UI
                const result = await ui.initialize();
                if (!result.success) {
                    console.error('UI åˆå§‹åŒ–å¤±æ•—:', result.error);
                    return;
                }
                
                console.log('è¦–è¨Šæ’­æ”¾å™¨åˆå§‹åŒ–æˆåŠŸ');
                
                // è¨­ç½®æª”æ¡ˆé¸æ“‡
                const fileInput = document.getElementById('fileInput');
                const uploadArea = document.getElementById('videoUploadArea');
                
                fileInput.addEventListener('change', handleFileSelect);
                
                // æ‹–æ”¾æ”¯æ´
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('drag-over');
                });
                
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('drag-over');
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('drag-over');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        handleFile(files[0]);
                    }
                });
                
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±æ•—:', error);
                alert('è¦–è¨Šæ’­æ”¾å™¨åˆå§‹åŒ–å¤±æ•—: ' + error.message);
            }
        }
        
        async function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                await handleFile(file);
            }
        }
        
        async function handleFile(file) {
            try {
                console.log('é–‹å§‹è¼‰å…¥æª”æ¡ˆ:', file.name);
                
                // é¡¯ç¤ºè¼‰å…¥ä¸­
                ui.showLoading();
                
                // è¼‰å…¥è¦–è¨Š
                await player.loadFile(file);
                
                // é¡¯ç¤ºæ’­æ”¾å™¨
                ui.showPlayer();
                
                // éš±è—è¼‰å…¥ä¸­
                ui.hideLoading();
                
                console.log('æª”æ¡ˆè¼‰å…¥æˆåŠŸ');
                
            } catch (error) {
                console.error('è¼‰å…¥å¤±æ•—:', error);
                ui.hideLoading();
                alert('è¼‰å…¥è¦–è¨Šå¤±æ•—: ' + error.message);
            }
        }
        
        // è¼‰å…¥ç¯„ä¾‹è¦–è¨Š
        window.loadSampleVideo = async function() {
            try {
                console.log('è¼‰å…¥ç¯„ä¾‹è¦–è¨Š...');
                const response = await fetch('https://www.w3schools.com/html/mov_bbb.mp4');
                const blob = await response.blob();
                const file = new File([blob], 'big_buck_bunny.mp4', { type: 'video/mp4' });
                await handleFile(file);
            } catch (error) {
                console.error('è¼‰å…¥ç¯„ä¾‹å¤±æ•—:', error);
                alert('è¼‰å…¥ç¯„ä¾‹è¦–è¨Šå¤±æ•—: ' + error.message);
            }
        };
        
        // å•Ÿå‹•
        init();
    </script>
</body>
</html>