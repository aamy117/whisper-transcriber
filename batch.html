<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰¹æ¬¡è½‰è­¯ - Whisper å·¥å…·</title>
    <link rel="stylesheet" href="css/shared.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* æ‰¹æ¬¡è™•ç†å°ˆç”¨æ¨£å¼ */
        .batch-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--spacing-lg);
        }
        
        .batch-header {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            margin-bottom: var(--spacing-lg);
        }
        
        .batch-controls {
            display: flex;
            gap: var(--spacing-md);
            align-items: center;
            flex-wrap: wrap;
        }
        
        .file-drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-xl);
            text-align: center;
            background: var(--bg-tertiary);
            transition: all 0.3s;
            cursor: pointer;
            margin-bottom: var(--spacing-lg);
        }
        
        .file-drop-zone:hover,
        .file-drop-zone.dragover {
            border-color: var(--primary-color);
            background: rgba(37, 99, 235, 0.1);
        }
        
        .file-queue {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            max-height: 400px;
            overflow-y: auto;
        }
        
        .queue-item {
            display: flex;
            align-items: center;
            padding: var(--spacing-md);
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            margin-bottom: var(--spacing-sm);
            transition: all 0.2s;
        }
        
        .queue-item.processing {
            border-color: var(--primary-color);
            background: rgba(37, 99, 235, 0.05);
        }
        
        .queue-item.completed {
            border-color: var(--success-color);
            background: rgba(16, 185, 129, 0.05);
        }
        
        .queue-item.error {
            border-color: var(--danger-color);
            background: rgba(239, 68, 68, 0.05);
        }
        
        .queue-item-info {
            flex: 1;
            margin-right: var(--spacing-md);
        }
        
        .queue-item-name {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .queue-item-size {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .queue-item-status {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }
        
        .status-icon {
            width: 20px;
            height: 20px;
        }
        
        .progress-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }
        
        .stat-card {
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            padding: var(--spacing-md);
            text-align: center;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: var(--spacing-xs);
        }
        
        .batch-progress {
            background: var(--bg-tertiary);
            border-radius: var(--radius-full);
            height: 8px;
            overflow: hidden;
            margin-bottom: var(--spacing-md);
        }
        
        .batch-progress-fill {
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s ease;
        }
        
        .empty-state {
            text-align: center;
            padding: var(--spacing-xl);
            color: var(--text-tertiary);
        }
        
        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: var(--spacing-md);
        }
    </style>
</head>
<body>
    <!-- å°èˆªåˆ— -->
    <nav class="app-navigation">
        <div class="nav-container">
            <div class="nav-brand">
                <h1 class="nav-title">Whisper å·¥å…·</h1>
            </div>
            <div class="nav-links">
                <a href="index.html" class="nav-link">
                    <span class="nav-icon">ğŸµ</span>
                    <span>éŸ³è¨Šå·¥å…·</span>
                </a>
                <a href="batch.html" class="nav-link active">
                    <span class="nav-icon">ğŸ“</span>
                    <span>æ‰¹æ¬¡è½‰è­¯</span>
                </a>
                <a href="video.html" class="nav-link">
                    <span class="nav-icon">ğŸ¬</span>
                    <span>è¦–è¨Šå·¥å…·</span>
                </a>
            </div>
        </div>
    </nav>
    
    <div class="batch-container">
        <div class="batch-header">
            <h2>æ‰¹æ¬¡è½‰è­¯</h2>
            <p>ä¸€æ¬¡è™•ç†å¤šå€‹éŸ³è¨Šæª”æ¡ˆï¼Œæ”¯æ´å¤§æª”æ¡ˆè‡ªå‹•åˆ†å‰²å’Œå£“ç¸®</p>
        </div>
        
        <!-- æª”æ¡ˆé¸æ“‡å€ -->
        <div class="file-drop-zone" id="dropZone">
            <div class="empty-state-icon">ğŸ“</div>
            <p>æ‹–æ”¾éŸ³è¨Šæª”æ¡ˆåˆ°é€™è£¡ï¼Œæˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ</p>
            <p class="text-secondary">æ”¯æ´ MP3ã€M4Aã€WAVã€MP4ã€MOV ç­‰æ ¼å¼</p>
            <input type="file" id="fileInput" multiple accept="audio/*,video/*" style="display: none;">
        </div>
        
        <!-- é€²åº¦çµ±è¨ˆ -->
        <div class="progress-stats" id="progressStats" style="display: none;">
            <div class="stat-card">
                <div class="stat-value" id="statTotal">0</div>
                <div class="stat-label">ç¸½è¨ˆ</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statCompleted">0</div>
                <div class="stat-label">å·²å®Œæˆ</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statProcessing">0</div>
                <div class="stat-label">è™•ç†ä¸­</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statPending">0</div>
                <div class="stat-label">ç­‰å¾…ä¸­</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statFailed">0</div>
                <div class="stat-label">å¤±æ•—</div>
            </div>
        </div>
        
        <!-- ç¸½é€²åº¦æ¢ -->
        <div class="batch-progress" id="batchProgress" style="display: none;">
            <div class="batch-progress-fill" id="batchProgressFill" style="width: 0%"></div>
        </div>
        
        <!-- æ§åˆ¶æŒ‰éˆ• -->
        <div class="batch-controls" id="batchControls" style="display: none;">
            <button class="btn btn-primary" id="startBtn">é–‹å§‹è™•ç†</button>
            <button class="btn btn-secondary" id="pauseBtn" disabled>æš«åœ</button>
            <button class="btn btn-secondary" id="stopBtn" disabled>åœæ­¢</button>
            <button class="btn btn-secondary" id="clearBtn">æ¸…ç©ºåˆ—è¡¨</button>
            <button class="btn btn-secondary" id="exportBtn" disabled>åŒ¯å‡ºçµæœ</button>
            
            <div style="margin-left: auto;">
                <label>
                    <input type="checkbox" id="continueOnError" checked>
                    é‡åˆ°éŒ¯èª¤æ™‚ç¹¼çºŒ
                </label>
            </div>
        </div>
        
        <!-- æª”æ¡ˆä½‡åˆ— -->
        <div class="file-queue" id="fileQueue">
            <div class="empty-state">
                <p>å°šæœªæ·»åŠ ä»»ä½•æª”æ¡ˆ</p>
            </div>
        </div>
    </div>
    
    <!-- è¨­å®šæ¨¡æ…‹æ¡† -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>è¨­å®š</h2>
                <button class="close-btn" id="settingsCloseBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="apiKeyInput">OpenAI API Key</label>
                    <input type="password" id="apiKeyInput" placeholder="sk-..." class="form-control">
                    <small class="form-hint">æ‚¨çš„ API Key å°‡å®‰å…¨åœ°å„²å­˜åœ¨æœ¬åœ°</small>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="saveSettingsBtn">å„²å­˜</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        import Config from './js/config.js';
        import { WhisperAPI } from './js/api.js';
        import { createBatchProcessor } from './js/batch-processor.js';
        import { notify } from './js/notification.js';
        import { dialog } from './js/dialog.js';
        
        // åˆå§‹åŒ–
        let whisperAPI = null;
        let batchProcessor = null;
        
        // DOM å…ƒç´ 
        const elements = {
            dropZone: document.getElementById('dropZone'),
            fileInput: document.getElementById('fileInput'),
            fileQueue: document.getElementById('fileQueue'),
            progressStats: document.getElementById('progressStats'),
            batchProgress: document.getElementById('batchProgress'),
            batchProgressFill: document.getElementById('batchProgressFill'),
            batchControls: document.getElementById('batchControls'),
            startBtn: document.getElementById('startBtn'),
            pauseBtn: document.getElementById('pauseBtn'),
            stopBtn: document.getElementById('stopBtn'),
            clearBtn: document.getElementById('clearBtn'),
            exportBtn: document.getElementById('exportBtn'),
            continueOnError: document.getElementById('continueOnError'),
            settingsModal: document.getElementById('settingsModal'),
            apiKeyInput: document.getElementById('apiKeyInput'),
            saveSettingsBtn: document.getElementById('saveSettingsBtn'),
            settingsCloseBtn: document.getElementById('settingsCloseBtn')
        };
        
        // åˆå§‹åŒ– API
        function initAPI() {
            const apiKey = localStorage.getItem(Config.storage.prefix + 'apiKey');
            if (apiKey) {
                whisperAPI = new WhisperAPI();
                batchProcessor = createBatchProcessor(whisperAPI);
                
                // ç¶å®šäº‹ä»¶
                batchProcessor.on('progress', updateProgress);
                batchProcessor.on('itemComplete', updateQueueItem);
                batchProcessor.on('error', handleError);
                batchProcessor.on('complete', handleComplete);
                
                elements.apiKeyInput.value = apiKey;
                return true;
            }
            return false;
        }
        
        // æª¢æŸ¥ API Key
        if (!initAPI()) {
            notify.warning('è«‹å…ˆè¨­å®š API Key');
            showModal(elements.settingsModal);
        }
        
        // æª”æ¡ˆé¸æ“‡
        elements.dropZone.addEventListener('click', () => {
            elements.fileInput.click();
        });
        
        elements.fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });
        
        // æ‹–æ”¾è™•ç†
        elements.dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            elements.dropZone.classList.add('dragover');
        });
        
        elements.dropZone.addEventListener('dragleave', () => {
            elements.dropZone.classList.remove('dragover');
        });
        
        elements.dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            elements.dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });
        
        // æ§åˆ¶æŒ‰éˆ•
        elements.startBtn.addEventListener('click', () => {
            batchProcessor.options.continueOnError = elements.continueOnError.checked;
            batchProcessor.start();
            updateControlButtons('processing');
        });
        
        elements.pauseBtn.addEventListener('click', () => {
            if (batchProcessor.isPaused) {
                batchProcessor.resume();
                elements.pauseBtn.textContent = 'æš«åœ';
            } else {
                batchProcessor.pause();
                elements.pauseBtn.textContent = 'ç¹¼çºŒ';
            }
        });
        
        elements.stopBtn.addEventListener('click', () => {
            batchProcessor.stop();
            updateControlButtons('stopped');
        });
        
        elements.clearBtn.addEventListener('click', async () => {
            const confirmed = await dialog.confirm({
                title: 'æ¸…ç©ºåˆ—è¡¨',
                message: 'ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æª”æ¡ˆå—ï¼Ÿ',
                type: 'warning'
            });
            
            if (confirmed) {
                batchProcessor.clear();
                renderQueue();
                hideProgressUI();
            }
        });
        
        elements.exportBtn.addEventListener('click', () => {
            const format = 'json'; // å¯ä»¥è®“ä½¿ç”¨è€…é¸æ“‡
            batchProcessor.exportResults(format);
        });
        
        // è¨­å®šç›¸é—œ
        elements.saveSettingsBtn.addEventListener('click', () => {
            const apiKey = elements.apiKeyInput.value.trim();
            if (apiKey) {
                localStorage.setItem(Config.storage.prefix + 'apiKey', apiKey);
                if (!whisperAPI) {
                    initAPI();
                }
                hideModal(elements.settingsModal);
                notify.success('è¨­å®šå·²å„²å­˜');
            } else {
                notify.error('è«‹è¼¸å…¥æœ‰æ•ˆçš„ API Key');
            }
        });
        
        elements.settingsCloseBtn.addEventListener('click', () => {
            hideModal(elements.settingsModal);
        });
        
        // è™•ç†æª”æ¡ˆ
        function handleFiles(files) {
            if (!batchProcessor) {
                notify.error('è«‹å…ˆè¨­å®š API Key');
                showModal(elements.settingsModal);
                return;
            }
            
            const count = batchProcessor.addFiles(files);
            if (count > 0) {
                notify.success(`å·²æ·»åŠ  ${count} å€‹æª”æ¡ˆåˆ°ä½‡åˆ—`);
                renderQueue();
                showProgressUI();
            }
        }
        
        // æ¸²æŸ“ä½‡åˆ—
        function renderQueue() {
            const queue = batchProcessor.queue;
            
            if (queue.length === 0) {
                elements.fileQueue.innerHTML = `
                    <div class="empty-state">
                        <p>å°šæœªæ·»åŠ ä»»ä½•æª”æ¡ˆ</p>
                    </div>
                `;
                return;
            }
            
            elements.fileQueue.innerHTML = queue.map(item => `
                <div class="queue-item ${item.status}" data-id="${item.id}">
                    <div class="queue-item-info">
                        <div class="queue-item-name">${item.file.name}</div>
                        <div class="queue-item-size">${formatFileSize(item.file.size)}</div>
                    </div>
                    <div class="queue-item-status">
                        ${getStatusIcon(item.status)}
                        ${getStatusText(item.status)}
                    </div>
                </div>
            `).join('');
        }
        
        // æ›´æ–°é€²åº¦
        function updateProgress(progress) {
            elements.statTotal.textContent = progress.total;
            elements.statCompleted.textContent = progress.completed;
            elements.statProcessing.textContent = progress.processing;
            elements.statPending.textContent = progress.pending;
            elements.statFailed.textContent = progress.failed;
            
            elements.batchProgressFill.style.width = `${progress.percentage}%`;
            
            renderQueue();
        }
        
        // æ›´æ–°ä½‡åˆ—é …ç›®
        function updateQueueItem(item) {
            const itemEl = elements.fileQueue.querySelector(`[data-id="${item.id}"]`);
            if (itemEl) {
                itemEl.className = `queue-item ${item.status}`;
                itemEl.querySelector('.queue-item-status').innerHTML = `
                    ${getStatusIcon(item.status)}
                    ${getStatusText(item.status)}
                `;
            }
        }
        
        // è™•ç†éŒ¯èª¤
        function handleError({ item, error }) {
            notify.error(`æª”æ¡ˆ ${item.file.name} è™•ç†å¤±æ•—ï¼š${error.message}`);
        }
        
        // è™•ç†å®Œæˆ
        function handleComplete(results) {
            notify.success(`æ‰¹æ¬¡è™•ç†å®Œæˆï¼å…±è™•ç† ${results.length} å€‹æª”æ¡ˆ`);
            updateControlButtons('completed');
            elements.exportBtn.disabled = false;
        }
        
        // æ›´æ–°æ§åˆ¶æŒ‰éˆ•ç‹€æ…‹
        function updateControlButtons(state) {
            switch (state) {
                case 'processing':
                    elements.startBtn.disabled = true;
                    elements.pauseBtn.disabled = false;
                    elements.stopBtn.disabled = false;
                    break;
                case 'stopped':
                case 'completed':
                    elements.startBtn.disabled = false;
                    elements.pauseBtn.disabled = true;
                    elements.stopBtn.disabled = true;
                    elements.pauseBtn.textContent = 'æš«åœ';
                    break;
            }
        }
        
        // é¡¯ç¤º/éš±è—é€²åº¦ UI
        function showProgressUI() {
            elements.progressStats.style.display = 'grid';
            elements.batchProgress.style.display = 'block';
            elements.batchControls.style.display = 'flex';
        }
        
        function hideProgressUI() {
            elements.progressStats.style.display = 'none';
            elements.batchProgress.style.display = 'none';
            elements.batchControls.style.display = 'none';
        }
        
        // å·¥å…·å‡½æ•¸
        function getStatusIcon(status) {
            const icons = {
                pending: 'â³',
                processing: 'ğŸ”„',
                completed: 'âœ…',
                error: 'âŒ'
            };
            return `<span class="status-icon">${icons[status] || ''}</span>`;
        }
        
        function getStatusText(status) {
            const texts = {
                pending: 'ç­‰å¾…ä¸­',
                processing: 'è™•ç†ä¸­...',
                completed: 'å·²å®Œæˆ',
                error: 'å¤±æ•—'
            };
            return texts[status] || status;
        }
        
        function formatFileSize(bytes) {
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return `${(bytes / Math.pow(1024, i)).toFixed(1)} ${sizes[i]}`;
        }
        
        function showModal(modal) {
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }
        
        function hideModal(modal) {
            modal.classList.remove('show');
            document.body.style.overflow = '';
        }
    </script>
</body>
</html>