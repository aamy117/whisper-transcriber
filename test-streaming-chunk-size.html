<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>串流分塊大小測試</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h2 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-top: 0;
        }
        
        .chunk-size-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        .chunk-option {
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .chunk-option:hover {
            border-color: #007bff;
            background: #f8f9fa;
        }
        
        .chunk-option.selected {
            border-color: #007bff;
            background: #007bff;
            color: white;
        }
        
        .test-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .result-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        
        .result-card h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        
        .result-value {
            font-size: 20px;
            font-weight: bold;
            color: #007bff;
        }
        
        .performance-chart {
            width: 100%;
            height: 200px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }
        
        .chart-bar {
            position: absolute;
            bottom: 0;
            width: 80px;
            background: #007bff;
            transition: height 0.3s;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            color: white;
            font-size: 12px;
            padding-bottom: 5px;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .log-area {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-loading { background: #ffc107; }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
    </style>
</head>
<body>
    <h1>🧪 串流分塊大小測試</h1>
    
    <div class="test-section">
        <h2>選擇分塊大小</h2>
        <div class="chunk-size-options">
            <div class="chunk-option" data-size="65536">
                <div class="result-value">64 KB</div>
                <small>最小分塊</small>
            </div>
            <div class="chunk-option" data-size="262144">
                <div class="result-value">256 KB</div>
                <small>小分塊</small>
            </div>
            <div class="chunk-option" data-size="524288">
                <div class="result-value">512 KB</div>
                <small>中等分塊</small>
            </div>
            <div class="chunk-option selected" data-size="1048576">
                <div class="result-value">1 MB</div>
                <small>預設分塊</small>
            </div>
            <div class="chunk-option" data-size="2097152">
                <div class="result-value">2 MB</div>
                <small>大分塊</small>
            </div>
            <div class="chunk-option" data-size="4194304">
                <div class="result-value">4 MB</div>
                <small>超大分塊</small>
            </div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>測試控制</h2>
        <input type="file" id="fileInput" accept="video/*">
        <button onclick="startTest()">開始測試</button>
        <button onclick="stopTest()">停止測試</button>
        <button onclick="clearResults()">清除結果</button>
    </div>
    
    <div class="test-section">
        <h2>測試結果</h2>
        <div class="test-results">
            <div class="result-card">
                <h4>載入時間</h4>
                <div class="result-value" id="loadTime">-</div>
            </div>
            <div class="result-card">
                <h4>傳輸速度</h4>
                <div class="result-value" id="transferSpeed">-</div>
            </div>
            <div class="result-card">
                <h4>記憶體使用</h4>
                <div class="result-value" id="memoryUsage">-</div>
            </div>
            <div class="result-card">
                <h4>分塊數量</h4>
                <div class="result-value" id="chunkCount">-</div>
            </div>
        </div>
        
        <h3>效能比較</h3>
        <div class="performance-chart" id="performanceChart"></div>
    </div>
    
    <div class="test-section">
        <h2>測試日誌</h2>
        <div class="log-area" id="testLog">等待測試開始...</div>
    </div>
    
    <!-- 隱藏的視訊元素 -->
    <video id="testVideo" style="display: none;"></video>
    
    <script type="module">
        import { StreamingLoader } from './js/video/video-streaming.js';
        
        let currentChunkSize = 1048576; // 預設 1MB
        let testResults = {};
        let currentTest = null;
        
        // 初始化
        document.querySelectorAll('.chunk-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.chunk-option').forEach(o => o.classList.remove('selected'));
                this.classList.add('selected');
                currentChunkSize = parseInt(this.dataset.size);
                log(`選擇分塊大小: ${formatFileSize(currentChunkSize)}`);
            });
        });
        
        function log(message) {
            const logArea = document.getElementById('testLog');
            const timestamp = new Date().toLocaleTimeString();
            logArea.textContent += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        window.startTest = async function() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('請先選擇一個視訊檔案');
                return;
            }
            
            log(`開始測試檔案: ${file.name} (${formatFileSize(file.size)})`);
            log(`使用分塊大小: ${formatFileSize(currentChunkSize)}`);
            
            // 清除舊結果
            updateResult('loadTime', '-');
            updateResult('transferSpeed', '-');
            updateResult('memoryUsage', '-');
            updateResult('chunkCount', '-');
            
            try {
                const video = document.getElementById('testVideo');
                const loader = new StreamingLoader(video);
                loader.chunkSize = currentChunkSize;
                
                currentTest = {
                    loader: loader,
                    startTime: performance.now(),
                    bytesLoaded: 0,
                    chunksLoaded: 0
                };
                
                // 監聽進度
                video.addEventListener('video:streaming:progress', handleProgress);
                video.addEventListener('video:streaming:complete', handleComplete);
                video.addEventListener('video:streaming:error', handleError);
                
                // 開始載入
                await loader.loadFile(file);
                
            } catch (error) {
                log(`測試錯誤: ${error.message}`);
                handleError({ detail: error });
            }
        };
        
        function handleProgress(event) {
            const { loaded, total, percentage } = event.detail;
            currentTest.chunksLoaded = loaded;
            currentTest.bytesLoaded = Math.min(loaded * currentChunkSize, currentTest.loader.file.size);
            
            // 更新進度
            const elapsed = (performance.now() - currentTest.startTime) / 1000;
            const speed = currentTest.bytesLoaded / elapsed;
            
            updateResult('transferSpeed', formatFileSize(speed) + '/s');
            updateResult('chunkCount', `${loaded}/${total}`);
            
            // 記憶體使用
            if (performance.memory) {
                const memoryMB = (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(1);
                updateResult('memoryUsage', memoryMB + ' MB');
            }
        }
        
        function handleComplete(event) {
            const elapsed = (performance.now() - currentTest.startTime) / 1000;
            updateResult('loadTime', elapsed.toFixed(2) + ' 秒');
            
            log(`✅ 測試完成！總時間: ${elapsed.toFixed(2)} 秒`);
            
            // 儲存結果
            const sizeKey = formatFileSize(currentChunkSize);
            testResults[sizeKey] = {
                time: elapsed,
                speed: currentTest.bytesLoaded / elapsed,
                chunks: currentTest.chunksLoaded
            };
            
            // 更新圖表
            updateChart();
        }
        
        function handleError(event) {
            log(`❌ 錯誤: ${event.detail.message || event.detail}`);
        }
        
        window.stopTest = function() {
            if (currentTest && currentTest.loader) {
                currentTest.loader.destroy();
                currentTest = null;
                log('測試已停止');
            }
        };
        
        window.clearResults = function() {
            testResults = {};
            updateChart();
            document.getElementById('testLog').textContent = '結果已清除\n';
        };
        
        function updateResult(id, value) {
            document.getElementById(id).textContent = value;
        }
        
        function updateChart() {
            const chart = document.getElementById('performanceChart');
            chart.innerHTML = '';
            
            let index = 0;
            const maxTime = Math.max(...Object.values(testResults).map(r => r.time), 1);
            
            for (const [size, result] of Object.entries(testResults)) {
                const bar = document.createElement('div');
                bar.className = 'chart-bar';
                bar.style.left = (index * 100) + 'px';
                bar.style.height = (result.time / maxTime * 180) + 'px';
                bar.textContent = size;
                bar.title = `${size}: ${result.time.toFixed(2)}秒`;
                chart.appendChild(bar);
                index++;
            }
        }
        
        function formatFileSize(bytes) {
            const sizes = ['B', 'KB', 'MB', 'GB'];
            if (bytes === 0) return '0 B';
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return (bytes / Math.pow(1024, i)).toFixed(2) + ' ' + sizes[i];
        }
        
        // 清理
        window.addEventListener('beforeunload', () => {
            if (currentTest && currentTest.loader) {
                currentTest.loader.destroy();
            }
        });
    </script>
</body>
</html>