<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>取消操作功能測試</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
        }
        
        .test-section h3 {
            margin-top: 0;
            color: var(--primary-color);
        }
        
        .test-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .test-output {
            font-family: 'Courier New', monospace;
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
            min-height: 100px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: var(--bg-secondary);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s ease;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-idle { background: #6c757d; }
        .status-running { background: #28a745; }
        .status-cancelled { background: #ffc107; }
        .status-error { background: #dc3545; }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <h1>取消操作功能測試</h1>
            <p>測試轉譯過程中的取消功能</p>
        </header>

        <div class="test-container">
            <!-- 測試 1: 基本取消功能 -->
            <div class="test-section">
                <h3>測試 1: 基本取消功能</h3>
                <div class="test-controls">
                    <button id="test1Start" class="btn btn-primary">開始長時間操作</button>
                    <button id="test1Cancel" class="btn btn-secondary" disabled>取消操作</button>
                    <span class="status-indicator status-idle"></span>
                    <span id="test1Status">就緒</span>
                </div>
                <div class="progress-bar">
                    <div id="test1Progress" class="progress-fill" style="width: 0%"></div>
                </div>
                <div id="test1Output" class="test-output">等待測試...</div>
            </div>

            <!-- 測試 2: API 請求取消 -->
            <div class="test-section">
                <h3>測試 2: API 請求取消</h3>
                <div class="test-controls">
                    <input type="file" id="test2File" accept="audio/*" class="form-control">
                    <button id="test2Start" class="btn btn-primary" disabled>開始轉譯</button>
                    <button id="test2Cancel" class="btn btn-secondary" disabled>取消轉譯</button>
                </div>
                <div class="progress-bar">
                    <div id="test2Progress" class="progress-fill" style="width: 0%"></div>
                </div>
                <div id="test2Output" class="test-output">請選擇音訊檔案...</div>
            </div>

            <!-- 測試 3: 音訊處理取消 -->
            <div class="test-section">
                <h3>測試 3: 音訊處理取消（壓縮/分割）</h3>
                <div class="test-controls">
                    <input type="file" id="test3File" accept="audio/*" class="form-control">
                    <select id="test3Method" class="form-control">
                        <option value="compress">壓縮</option>
                        <option value="split">分割</option>
                    </select>
                    <button id="test3Start" class="btn btn-primary" disabled>開始處理</button>
                    <button id="test3Cancel" class="btn btn-secondary" disabled>取消處理</button>
                </div>
                <div class="progress-bar">
                    <div id="test3Progress" class="progress-fill" style="width: 0%"></div>
                </div>
                <div id="test3Output" class="test-output">請選擇音訊檔案...</div>
            </div>

            <!-- 測試 4: WASM 轉譯取消 -->
            <div class="test-section">
                <h3>測試 4: WASM 本地轉譯取消</h3>
                <div class="test-controls">
                    <input type="file" id="test4File" accept="audio/*" class="form-control">
                    <button id="test4Start" class="btn btn-primary" disabled>開始本地轉譯</button>
                    <button id="test4Cancel" class="btn btn-secondary" disabled>取消轉譯</button>
                </div>
                <div class="progress-bar">
                    <div id="test4Progress" class="progress-fill" style="width: 0%"></div>
                </div>
                <div id="test4Output" class="test-output">請選擇音訊檔案...</div>
            </div>
        </div>
    </div>

    <!-- 載入必要的模組 -->
    <script type="module">
        import CancellationToken from '../js/utils/cancellation-token.js';
        import { WhisperAPI } from '../js/api.js';
        import { audioCompressor } from '../js/audio-compressor.js';
        import { audioSplitter } from '../js/audio-splitter.js';
        import { WhisperWASMManager } from '../js/wasm/whisper-wasm-manager.js';

        // 測試 1: 基本取消功能
        const test1 = {
            token: null,
            
            async start() {
                const output = document.getElementById('test1Output');
                const progressBar = document.getElementById('test1Progress');
                const status = document.getElementById('test1Status');
                const indicator = document.querySelector('.test-section:nth-child(1) .status-indicator');
                
                // 創建取消令牌
                this.token = new CancellationToken();
                
                // 更新 UI
                document.getElementById('test1Start').disabled = true;
                document.getElementById('test1Cancel').disabled = false;
                indicator.className = 'status-indicator status-running';
                status.textContent = '運行中';
                output.textContent = '開始長時間操作...\n';
                
                try {
                    // 模擬長時間操作
                    for (let i = 0; i <= 100; i++) {
                        // 檢查是否已取消
                        this.token.throwIfCancelled();
                        
                        await new Promise(resolve => setTimeout(resolve, 50));
                        progressBar.style.width = i + '%';
                        
                        if (i % 10 === 0) {
                            output.textContent += `進度: ${i}%\n`;
                        }
                    }
                    
                    output.textContent += '操作完成！\n';
                    indicator.className = 'status-indicator status-idle';
                    status.textContent = '完成';
                    
                } catch (error) {
                    if (error.name === 'CancellationError') {
                        output.textContent += `操作已取消: ${error.message}\n`;
                        indicator.className = 'status-indicator status-cancelled';
                        status.textContent = '已取消';
                    } else {
                        output.textContent += `錯誤: ${error.message}\n`;
                        indicator.className = 'status-indicator status-error';
                        status.textContent = '錯誤';
                    }
                } finally {
                    document.getElementById('test1Start').disabled = false;
                    document.getElementById('test1Cancel').disabled = true;
                    this.token = null;
                }
            },
            
            cancel() {
                if (this.token) {
                    this.token.cancel('使用者手動取消');
                }
            }
        };

        // 測試 2: API 請求取消
        const test2 = {
            api: null,
            token: null,
            
            async start() {
                const file = document.getElementById('test2File').files[0];
                if (!file) return;
                
                const output = document.getElementById('test2Output');
                const progressBar = document.getElementById('test2Progress');
                
                // 初始化 API
                if (!this.api) {
                    this.api = new WhisperAPI();
                    // 使用測試 API Key
                    this.api.setApiKey('sk-test-api-key');
                }
                
                // 創建取消令牌
                this.token = new CancellationToken();
                
                // 更新 UI
                document.getElementById('test2Start').disabled = true;
                document.getElementById('test2Cancel').disabled = false;
                output.textContent = '正在上傳並轉譯...\n';
                progressBar.style.width = '50%';
                
                try {
                    const result = await this.api.transcribe(file, {
                        language: 'zh',
                        signal: this.token.signal
                    });
                    
                    output.textContent += '轉譯完成！\n';
                    output.textContent += `結果: ${result.text.substring(0, 100)}...\n`;
                    progressBar.style.width = '100%';
                    
                } catch (error) {
                    if (error.message.includes('取消')) {
                        output.textContent += '轉譯已取消\n';
                        progressBar.style.width = '0%';
                    } else {
                        output.textContent += `錯誤: ${error.message}\n`;
                    }
                } finally {
                    document.getElementById('test2Start').disabled = false;
                    document.getElementById('test2Cancel').disabled = true;
                    this.token = null;
                }
            },
            
            cancel() {
                if (this.token) {
                    this.token.cancel('使用者取消轉譯');
                }
                if (this.api) {
                    this.api.cancel();
                }
            }
        };

        // 測試 3: 音訊處理取消
        const test3 = {
            token: null,
            
            async start() {
                const file = document.getElementById('test3File').files[0];
                if (!file) return;
                
                const method = document.getElementById('test3Method').value;
                const output = document.getElementById('test3Output');
                const progressBar = document.getElementById('test3Progress');
                
                // 創建取消令牌
                this.token = new CancellationToken();
                
                // 更新 UI
                document.getElementById('test3Start').disabled = true;
                document.getElementById('test3Cancel').disabled = false;
                output.textContent = `正在${method === 'compress' ? '壓縮' : '分割'}音訊...\n`;
                
                try {
                    let result;
                    
                    if (method === 'compress') {
                        result = await audioCompressor.compressAudioFile(file, {
                            cancellationToken: this.token,
                            onProgress: (progress) => {
                                progressBar.style.width = progress.percentage + '%';
                                output.textContent += `${progress.stage} - ${progress.percentage}%\n`;
                            }
                        });
                        
                        output.textContent += `壓縮完成！原始大小: ${(file.size / 1024 / 1024).toFixed(2)}MB, `;
                        output.textContent += `壓縮後: ${(result.compressedSize / 1024 / 1024).toFixed(2)}MB\n`;
                        
                    } else {
                        result = await audioSplitter.splitAudioFile(file, {
                            cancellationToken: this.token,
                            onProgress: (progress) => {
                                progressBar.style.width = progress.percentage + '%';
                                output.textContent += `處理第 ${progress.current}/${progress.total} 段\n`;
                            }
                        });
                        
                        output.textContent += `分割完成！共 ${result.segments.length} 個片段\n`;
                    }
                    
                } catch (error) {
                    if (error.name === 'CancellationError') {
                        output.textContent += '處理已取消\n';
                        progressBar.style.width = '0%';
                    } else {
                        output.textContent += `錯誤: ${error.message}\n`;
                    }
                } finally {
                    document.getElementById('test3Start').disabled = false;
                    document.getElementById('test3Cancel').disabled = true;
                    this.token = null;
                    
                    // 清理資源
                    audioCompressor.cleanup();
                    audioSplitter.cleanup();
                }
            },
            
            cancel() {
                if (this.token) {
                    this.token.cancel('使用者取消音訊處理');
                }
            }
        };

        // 測試 4: WASM 轉譯取消
        const test4 = {
            token: null,
            wasmManager: null,
            
            async start() {
                const file = document.getElementById('test4File').files[0];
                if (!file) return;
                
                const output = document.getElementById('test4Output');
                const progressBar = document.getElementById('test4Progress');
                
                // 創建取消令牌
                this.token = new CancellationToken();
                
                // 更新 UI
                document.getElementById('test4Start').disabled = true;
                document.getElementById('test4Cancel').disabled = false;
                output.textContent = '正在初始化 WASM...\n';
                
                try {
                    // 初始化 WASM
                    if (!this.wasmManager) {
                        this.wasmManager = new WhisperWASMManager();
                        this.wasmManager.ENABLE_REAL_WASM = false; // 使用模擬模式
                        await this.wasmManager.initialize('tiny');
                    }
                    
                    output.textContent += '開始本地轉譯...\n';
                    
                    const result = await this.wasmManager.transcribe(file, {
                        cancellationToken: this.token,
                        onProgress: (progress) => {
                            progressBar.style.width = progress.percentage + '%';
                            output.textContent = `本地轉譯中: ${progress.message}\n`;
                        }
                    });
                    
                    output.textContent += '轉譯完成！\n';
                    output.textContent += `結果: ${result.text.substring(0, 100)}...\n`;
                    
                } catch (error) {
                    if (error.message.includes('取消')) {
                        output.textContent += '轉譯已取消\n';
                        progressBar.style.width = '0%';
                    } else {
                        output.textContent += `錯誤: ${error.message}\n`;
                    }
                } finally {
                    document.getElementById('test4Start').disabled = false;
                    document.getElementById('test4Cancel').disabled = true;
                    this.token = null;
                }
            },
            
            cancel() {
                if (this.token) {
                    this.token.cancel('使用者取消 WASM 轉譯');
                }
            }
        };

        // 綁定事件
        document.getElementById('test1Start').onclick = () => test1.start();
        document.getElementById('test1Cancel').onclick = () => test1.cancel();

        document.getElementById('test2File').onchange = (e) => {
            document.getElementById('test2Start').disabled = !e.target.files[0];
        };
        document.getElementById('test2Start').onclick = () => test2.start();
        document.getElementById('test2Cancel').onclick = () => test2.cancel();

        document.getElementById('test3File').onchange = (e) => {
            document.getElementById('test3Start').disabled = !e.target.files[0];
        };
        document.getElementById('test3Start').onclick = () => test3.start();
        document.getElementById('test3Cancel').onclick = () => test3.cancel();

        document.getElementById('test4File').onchange = (e) => {
            document.getElementById('test4Start').disabled = !e.target.files[0];
        };
        document.getElementById('test4Start').onclick = () => test4.start();
        document.getElementById('test4Cancel').onclick = () => test4.cancel();
    </script>
</body>
</html>