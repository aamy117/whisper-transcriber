<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA 功能測試 - Whisper 聽打工具</title>
    
    <!-- PWA 支援 -->
    <link rel="manifest" href="../manifest.json">
    <meta name="theme-color" content="#0066cc">
    
    <!-- 樣式 -->
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/pwa.css">
    
    <style>
        .test-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
        }
        
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid var(--border-color, #e0e0e0);
            border-radius: 8px;
            background: var(--bg-secondary, #f8f9fa);
        }
        
        .test-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0 0 16px 0;
            color: var(--primary-color, #0066cc);
        }
        
        .test-controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin: 16px 0;
        }
        
        .test-btn {
            padding: 10px 20px;
            background: var(--primary-color, #0066cc);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .test-btn:hover {
            background: var(--primary-hover, #0052a3);
            transform: translateY(-1px);
        }
        
        .test-btn.secondary {
            background: var(--bg-primary, #fff);
            color: var(--text-primary, #333);
            border: 1px solid var(--border-color, #ddd);
        }
        
        .test-output {
            background: var(--bg-primary, #fff);
            border: 1px solid var(--border-color, #e0e0e0);
            border-radius: 4px;
            padding: 12px;
            margin: 12px 0;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-indicator.success {
            background: #28a745;
        }
        
        .status-indicator.error {
            background: #dc3545;
        }
        
        .status-indicator.warning {
            background: #ffc107;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>PWA 功能測試</h1>
        <p>測試 Whisper 聽打工具的 PWA 功能實現</p>
        
        <!-- Service Worker 測試 -->
        <div class="test-section">
            <h2 class="test-title">🔧 Service Worker</h2>
            <p>測試 Service Worker 註冊、更新、通訊功能</p>
            
            <div class="test-controls">
                <button class="test-btn" onclick="testServiceWorkerRegistration()">測試註冊</button>
                <button class="test-btn" onclick="testServiceWorkerUpdate()">檢查更新</button>
                <button class="test-btn" onclick="testServiceWorkerMessage()">測試通訊</button>
                <button class="test-btn secondary" onclick="unregisterServiceWorker()">取消註冊</button>
            </div>
            
            <div id="swOutput" class="test-output">等待測試...</div>
        </div>
        
        <!-- 快取測試 -->
        <div class="test-section">
            <h2 class="test-title">💾 快取管理</h2>
            <p>測試快取功能、資源管理、離線支援</p>
            
            <div class="test-controls">
                <button class="test-btn" onclick="testCacheInfo()">查看快取</button>
                <button class="test-btn" onclick="testCacheResources()">快取資源</button>
                <button class="test-btn" onclick="testOfflineMode()">模擬離線</button>
                <button class="test-btn secondary" onclick="clearAllCaches()">清除快取</button>
            </div>
            
            <div id="cacheOutput" class="test-output">等待測試...</div>
        </div>
        
        <!-- 安裝測試 -->
        <div class="test-section">
            <h2 class="test-title">📱 應用安裝</h2>
            <p>測試 PWA 安裝提示、狀態檢測、用戶體驗</p>
            
            <div class="test-controls">
                <button class="test-btn" onclick="testInstallPrompt()">測試安裝提示</button>
                <button class="test-btn" onclick="testInstallStatus()">檢查安裝狀態</button>
                <button class="test-btn" onclick="showPWASettings()">PWA 設定</button>
            </div>
            
            <div id="installOutput" class="test-output">等待測試...</div>
        </div>
        
        <!-- 通知測試 -->
        <div class="test-section">
            <h2 class="test-title">🔔 通知系統</h2>
            <p>測試各種通知類型、權限管理、用戶互動</p>
            
            <div class="test-controls">
                <button class="test-btn" onclick="testInstallBanner()">安裝橫幅</button>
                <button class="test-btn" onclick="testUpdateNotification()">更新通知</button>
                <button class="test-btn" onclick="testNetworkStatus()">網路狀態</button>
                <button class="test-btn secondary" onclick="clearNotifications()">清除通知</button>
            </div>
            
            <div id="notificationOutput" class="test-output">等待測試...</div>
        </div>
        
        <!-- 狀態面板 -->
        <div class="test-section">
            <h2 class="test-title">📊 即時狀態</h2>
            <div id="statusPanel">載入中...</div>
        </div>
    </div>
    
    <!-- 載入 PWA 模組 -->
    <script type="module" src="../js/pwa-manager.js"></script>
    <script type="module" src="../js/pwa-settings.js"></script>
    
    <script>
        // 等待 PWA 管理器載入
        window.addEventListener('load', () => {
            setTimeout(updateStatusPanel, 1000);
            setInterval(updateStatusPanel, 5000); // 每 5 秒更新狀態
        });
        
        // 更新狀態面板
        async function updateStatusPanel() {
            const panel = document.getElementById('statusPanel');
            
            if (window.pwaManager) {
                const status = window.pwaManager.getStatus();
                const cacheInfo = await window.pwaManager.getCacheInfo();
                const totalFiles = Object.values(cacheInfo).reduce((sum, count) => sum + count, 0);
                
                panel.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div>
                            <strong>📲 安裝狀態</strong><br>
                            <span class="status-indicator ${status.isInstalled ? 'success' : 'warning'}"></span>
                            ${status.isInstalled ? '已安裝' : '未安裝'}
                        </div>
                        <div>
                            <strong>🌐 網路狀態</strong><br>
                            <span class="status-indicator ${status.isOnline ? 'success' : 'error'}"></span>
                            ${status.isOnline ? '已連線' : '離線'}
                        </div>
                        <div>
                            <strong>⚙️ Service Worker</strong><br>
                            <span class="status-indicator ${status.hasServiceWorker ? 'success' : 'error'}"></span>
                            ${status.hasServiceWorker ? '已啟用' : '未啟用'}
                        </div>
                        <div>
                            <strong>💾 快取檔案</strong><br>
                            <span class="status-indicator ${totalFiles > 0 ? 'success' : 'warning'}"></span>
                            ${totalFiles} 個檔案
                        </div>
                    </div>
                `;
            } else {
                panel.innerHTML = '<span style="color: #dc3545;">PWA 管理器未載入</span>';
            }
        }
        
        // Service Worker 測試
        async function testServiceWorkerRegistration() {
            const output = document.getElementById('swOutput');
            output.textContent = '正在測試 Service Worker 註冊...\n';
            
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('../sw.js');
                    output.textContent += `✅ 註冊成功\n`;
                    output.textContent += `作用域: ${registration.scope}\n`;
                    output.textContent += `狀態: ${registration.active?.state || '載入中'}\n`;
                } catch (error) {
                    output.textContent += `❌ 註冊失敗: ${error.message}\n`;
                }
            } else {
                output.textContent += '❌ 瀏覽器不支援 Service Worker\n';
            }
        }
        
        async function testServiceWorkerUpdate() {
            const output = document.getElementById('swOutput');
            output.textContent += '正在檢查更新...\n';
            
            if (window.pwaManager) {
                await window.pwaManager.checkForUpdates();
                output.textContent += '✅ 更新檢查完成\n';
            } else {
                output.textContent += '❌ PWA 管理器未載入\n';
            }
        }
        
        async function testServiceWorkerMessage() {
            const output = document.getElementById('swOutput');
            
            if (navigator.serviceWorker.controller) {
                const messageChannel = new MessageChannel();
                messageChannel.port1.onmessage = (event) => {
                    output.textContent += `✅ 收到回應: ${JSON.stringify(event.data)}\n`;
                };
                
                navigator.serviceWorker.controller.postMessage(
                    { type: 'GET_VERSION' },
                    [messageChannel.port2]
                );
                output.textContent += '📤 已發送測試訊息\n';
            } else {
                output.textContent += '❌ 沒有活躍的 Service Worker\n';
            }
        }
        
        async function unregisterServiceWorker() {
            const output = document.getElementById('swOutput');
            
            try {
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (const registration of registrations) {
                    await registration.unregister();
                }
                output.textContent += '✅ Service Worker 已取消註冊\n';
            } catch (error) {
                output.textContent += `❌ 取消註冊失敗: ${error.message}\n`;
            }
        }
        
        // 快取測試
        async function testCacheInfo() {
            const output = document.getElementById('cacheOutput');
            output.textContent = '正在查看快取資訊...\n';
            
            if (window.pwaManager) {
                const cacheInfo = await window.pwaManager.getCacheInfo();
                output.textContent += JSON.stringify(cacheInfo, null, 2) + '\n';
            } else {
                output.textContent += '❌ PWA 管理器未載入\n';
            }
        }
        
        async function testCacheResources() {
            const output = document.getElementById('cacheOutput');
            output.textContent += '正在快取測試資源...\n';
            
            const testUrls = [
                '/test/test-pwa.html',
                '../css/style.css',
                '../css/pwa.css'
            ];
            
            if (window.pwaManager) {
                await window.pwaManager.precacheResources(testUrls);
                output.textContent += '✅ 資源已快取\n';
            } else {
                output.textContent += '❌ PWA 管理器未載入\n';
            }
        }
        
        function testOfflineMode() {
            const output = document.getElementById('cacheOutput');
            output.textContent += '模擬離線狀態...\n';
            
            // 觸發離線事件
            window.dispatchEvent(new Event('offline'));
            output.textContent += '📡 已觸發離線事件\n';
            
            setTimeout(() => {
                window.dispatchEvent(new Event('online'));
                output.textContent += '🌐 已恢復線上狀態\n';
            }, 3000);
        }
        
        async function clearAllCaches() {
            const output = document.getElementById('cacheOutput');
            output.textContent += '正在清除所有快取...\n';
            
            if (window.pwaManager) {
                await window.pwaManager.clearCache();
                output.textContent += '✅ 快取已清除\n';
            } else {
                output.textContent += '❌ PWA 管理器未載入\n';
            }
        }
        
        // 安裝測試
        function testInstallPrompt() {
            const output = document.getElementById('installOutput');
            output.textContent = '測試安裝提示...\n';
            
            if (window.pwaManager) {
                window.pwaManager.promptInstall();
                output.textContent += '📱 安裝提示已觸發\n';
            } else {
                output.textContent += '❌ PWA 管理器未載入\n';
            }
        }
        
        function testInstallStatus() {
            const output = document.getElementById('installOutput');
            
            if (window.pwaManager) {
                const status = window.pwaManager.getStatus();
                output.textContent = JSON.stringify(status, null, 2) + '\n';
            } else {
                output.textContent = '❌ PWA 管理器未載入\n';
            }
        }
        
        function showPWASettings() {
            if (window.PWASettings) {
                const settings = new window.PWASettings();
                settings.show();
            } else {
                alert('PWA 設定模組未載入');
            }
        }
        
        // 通知測試
        function testInstallBanner() {
            const output = document.getElementById('notificationOutput');
            output.textContent = '顯示安裝橫幅...\n';
            
            if (window.pwaManager) {
                window.pwaManager.showInstallBanner();
                output.textContent += '📢 安裝橫幅已顯示\n';
            } else {
                output.textContent += '❌ PWA 管理器未載入\n';
            }
        }
        
        function testUpdateNotification() {
            const output = document.getElementById('notificationOutput');
            output.textContent += '顯示更新通知...\n';
            
            if (window.pwaManager) {
                window.pwaManager.showUpdateAvailableNotification();
                output.textContent += '🔄 更新通知已顯示\n';
            } else {
                output.textContent += '❌ PWA 管理器未載入\n';
            }
        }
        
        function testNetworkStatus() {
            const output = document.getElementById('notificationOutput');
            output.textContent += '測試網路狀態通知...\n';
            
            if (window.pwaManager) {
                window.pwaManager.showNetworkStatusNotification('測試訊息', 'success');
                output.textContent += '📡 網路狀態通知已顯示\n';
            } else {
                output.textContent += '❌ PWA 管理器未載入\n';
            }
        }
        
        function clearNotifications() {
            // 清除所有通知元素
            document.querySelectorAll('.pwa-install-banner, .pwa-update-notification, .pwa-offline-indicator').forEach(el => {
                el.remove();
            });
            
            const output = document.getElementById('notificationOutput');
            output.textContent += '🧹 所有通知已清除\n';
        }
    </script>
</body>
</html>