<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA åŠŸèƒ½æ¸¬è©¦ - Whisper è½æ‰“å·¥å…·</title>
    
    <!-- PWA æ”¯æ´ -->
    <link rel="manifest" href="../manifest.json">
    <meta name="theme-color" content="#0066cc">
    
    <!-- æ¨£å¼ -->
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/pwa.css">
    
    <style>
        .test-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
        }
        
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid var(--border-color, #e0e0e0);
            border-radius: 8px;
            background: var(--bg-secondary, #f8f9fa);
        }
        
        .test-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0 0 16px 0;
            color: var(--primary-color, #0066cc);
        }
        
        .test-controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin: 16px 0;
        }
        
        .test-btn {
            padding: 10px 20px;
            background: var(--primary-color, #0066cc);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .test-btn:hover {
            background: var(--primary-hover, #0052a3);
            transform: translateY(-1px);
        }
        
        .test-btn.secondary {
            background: var(--bg-primary, #fff);
            color: var(--text-primary, #333);
            border: 1px solid var(--border-color, #ddd);
        }
        
        .test-output {
            background: var(--bg-primary, #fff);
            border: 1px solid var(--border-color, #e0e0e0);
            border-radius: 4px;
            padding: 12px;
            margin: 12px 0;
            font-family: monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-indicator.success {
            background: #28a745;
        }
        
        .status-indicator.error {
            background: #dc3545;
        }
        
        .status-indicator.warning {
            background: #ffc107;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>PWA åŠŸèƒ½æ¸¬è©¦</h1>
        <p>æ¸¬è©¦ Whisper è½æ‰“å·¥å…·çš„ PWA åŠŸèƒ½å¯¦ç¾</p>
        
        <!-- Service Worker æ¸¬è©¦ -->
        <div class="test-section">
            <h2 class="test-title">ğŸ”§ Service Worker</h2>
            <p>æ¸¬è©¦ Service Worker è¨»å†Šã€æ›´æ–°ã€é€šè¨ŠåŠŸèƒ½</p>
            
            <div class="test-controls">
                <button class="test-btn" onclick="testServiceWorkerRegistration()">æ¸¬è©¦è¨»å†Š</button>
                <button class="test-btn" onclick="testServiceWorkerUpdate()">æª¢æŸ¥æ›´æ–°</button>
                <button class="test-btn" onclick="testServiceWorkerMessage()">æ¸¬è©¦é€šè¨Š</button>
                <button class="test-btn secondary" onclick="unregisterServiceWorker()">å–æ¶ˆè¨»å†Š</button>
            </div>
            
            <div id="swOutput" class="test-output">ç­‰å¾…æ¸¬è©¦...</div>
        </div>
        
        <!-- å¿«å–æ¸¬è©¦ -->
        <div class="test-section">
            <h2 class="test-title">ğŸ’¾ å¿«å–ç®¡ç†</h2>
            <p>æ¸¬è©¦å¿«å–åŠŸèƒ½ã€è³‡æºç®¡ç†ã€é›¢ç·šæ”¯æ´</p>
            
            <div class="test-controls">
                <button class="test-btn" onclick="testCacheInfo()">æŸ¥çœ‹å¿«å–</button>
                <button class="test-btn" onclick="testCacheResources()">å¿«å–è³‡æº</button>
                <button class="test-btn" onclick="testOfflineMode()">æ¨¡æ“¬é›¢ç·š</button>
                <button class="test-btn secondary" onclick="clearAllCaches()">æ¸…é™¤å¿«å–</button>
            </div>
            
            <div id="cacheOutput" class="test-output">ç­‰å¾…æ¸¬è©¦...</div>
        </div>
        
        <!-- å®‰è£æ¸¬è©¦ -->
        <div class="test-section">
            <h2 class="test-title">ğŸ“± æ‡‰ç”¨å®‰è£</h2>
            <p>æ¸¬è©¦ PWA å®‰è£æç¤ºã€ç‹€æ…‹æª¢æ¸¬ã€ç”¨æˆ¶é«”é©—</p>
            
            <div class="test-controls">
                <button class="test-btn" onclick="testInstallPrompt()">æ¸¬è©¦å®‰è£æç¤º</button>
                <button class="test-btn" onclick="testInstallStatus()">æª¢æŸ¥å®‰è£ç‹€æ…‹</button>
                <button class="test-btn" onclick="showPWASettings()">PWA è¨­å®š</button>
            </div>
            
            <div id="installOutput" class="test-output">ç­‰å¾…æ¸¬è©¦...</div>
        </div>
        
        <!-- é€šçŸ¥æ¸¬è©¦ -->
        <div class="test-section">
            <h2 class="test-title">ğŸ”” é€šçŸ¥ç³»çµ±</h2>
            <p>æ¸¬è©¦å„ç¨®é€šçŸ¥é¡å‹ã€æ¬Šé™ç®¡ç†ã€ç”¨æˆ¶äº’å‹•</p>
            
            <div class="test-controls">
                <button class="test-btn" onclick="testInstallBanner()">å®‰è£æ©«å¹…</button>
                <button class="test-btn" onclick="testUpdateNotification()">æ›´æ–°é€šçŸ¥</button>
                <button class="test-btn" onclick="testNetworkStatus()">ç¶²è·¯ç‹€æ…‹</button>
                <button class="test-btn secondary" onclick="clearNotifications()">æ¸…é™¤é€šçŸ¥</button>
            </div>
            
            <div id="notificationOutput" class="test-output">ç­‰å¾…æ¸¬è©¦...</div>
        </div>
        
        <!-- ç‹€æ…‹é¢æ¿ -->
        <div class="test-section">
            <h2 class="test-title">ğŸ“Š å³æ™‚ç‹€æ…‹</h2>
            <div id="statusPanel">è¼‰å…¥ä¸­...</div>
        </div>
    </div>
    
    <!-- è¼‰å…¥ PWA æ¨¡çµ„ -->
    <script type="module" src="../js/pwa-manager.js"></script>
    <script type="module" src="../js/pwa-settings.js"></script>
    
    <script>
        // ç­‰å¾… PWA ç®¡ç†å™¨è¼‰å…¥
        window.addEventListener('load', () => {
            setTimeout(updateStatusPanel, 1000);
            setInterval(updateStatusPanel, 5000); // æ¯ 5 ç§’æ›´æ–°ç‹€æ…‹
        });
        
        // æ›´æ–°ç‹€æ…‹é¢æ¿
        async function updateStatusPanel() {
            const panel = document.getElementById('statusPanel');
            
            if (window.pwaManager) {
                const status = window.pwaManager.getStatus();
                const cacheInfo = await window.pwaManager.getCacheInfo();
                const totalFiles = Object.values(cacheInfo).reduce((sum, count) => sum + count, 0);
                
                panel.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        <div>
                            <strong>ğŸ“² å®‰è£ç‹€æ…‹</strong><br>
                            <span class="status-indicator ${status.isInstalled ? 'success' : 'warning'}"></span>
                            ${status.isInstalled ? 'å·²å®‰è£' : 'æœªå®‰è£'}
                        </div>
                        <div>
                            <strong>ğŸŒ ç¶²è·¯ç‹€æ…‹</strong><br>
                            <span class="status-indicator ${status.isOnline ? 'success' : 'error'}"></span>
                            ${status.isOnline ? 'å·²é€£ç·š' : 'é›¢ç·š'}
                        </div>
                        <div>
                            <strong>âš™ï¸ Service Worker</strong><br>
                            <span class="status-indicator ${status.hasServiceWorker ? 'success' : 'error'}"></span>
                            ${status.hasServiceWorker ? 'å·²å•Ÿç”¨' : 'æœªå•Ÿç”¨'}
                        </div>
                        <div>
                            <strong>ğŸ’¾ å¿«å–æª”æ¡ˆ</strong><br>
                            <span class="status-indicator ${totalFiles > 0 ? 'success' : 'warning'}"></span>
                            ${totalFiles} å€‹æª”æ¡ˆ
                        </div>
                    </div>
                `;
            } else {
                panel.innerHTML = '<span style="color: #dc3545;">PWA ç®¡ç†å™¨æœªè¼‰å…¥</span>';
            }
        }
        
        // Service Worker æ¸¬è©¦
        async function testServiceWorkerRegistration() {
            const output = document.getElementById('swOutput');
            output.textContent = 'æ­£åœ¨æ¸¬è©¦ Service Worker è¨»å†Š...\n';
            
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('../sw.js');
                    output.textContent += `âœ… è¨»å†ŠæˆåŠŸ\n`;
                    output.textContent += `ä½œç”¨åŸŸ: ${registration.scope}\n`;
                    output.textContent += `ç‹€æ…‹: ${registration.active?.state || 'è¼‰å…¥ä¸­'}\n`;
                } catch (error) {
                    output.textContent += `âŒ è¨»å†Šå¤±æ•—: ${error.message}\n`;
                }
            } else {
                output.textContent += 'âŒ ç€è¦½å™¨ä¸æ”¯æ´ Service Worker\n';
            }
        }
        
        async function testServiceWorkerUpdate() {
            const output = document.getElementById('swOutput');
            output.textContent += 'æ­£åœ¨æª¢æŸ¥æ›´æ–°...\n';
            
            if (window.pwaManager) {
                await window.pwaManager.checkForUpdates();
                output.textContent += 'âœ… æ›´æ–°æª¢æŸ¥å®Œæˆ\n';
            } else {
                output.textContent += 'âŒ PWA ç®¡ç†å™¨æœªè¼‰å…¥\n';
            }
        }
        
        async function testServiceWorkerMessage() {
            const output = document.getElementById('swOutput');
            
            if (navigator.serviceWorker.controller) {
                const messageChannel = new MessageChannel();
                messageChannel.port1.onmessage = (event) => {
                    output.textContent += `âœ… æ”¶åˆ°å›æ‡‰: ${JSON.stringify(event.data)}\n`;
                };
                
                navigator.serviceWorker.controller.postMessage(
                    { type: 'GET_VERSION' },
                    [messageChannel.port2]
                );
                output.textContent += 'ğŸ“¤ å·²ç™¼é€æ¸¬è©¦è¨Šæ¯\n';
            } else {
                output.textContent += 'âŒ æ²’æœ‰æ´»èºçš„ Service Worker\n';
            }
        }
        
        async function unregisterServiceWorker() {
            const output = document.getElementById('swOutput');
            
            try {
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (const registration of registrations) {
                    await registration.unregister();
                }
                output.textContent += 'âœ… Service Worker å·²å–æ¶ˆè¨»å†Š\n';
            } catch (error) {
                output.textContent += `âŒ å–æ¶ˆè¨»å†Šå¤±æ•—: ${error.message}\n`;
            }
        }
        
        // å¿«å–æ¸¬è©¦
        async function testCacheInfo() {
            const output = document.getElementById('cacheOutput');
            output.textContent = 'æ­£åœ¨æŸ¥çœ‹å¿«å–è³‡è¨Š...\n';
            
            if (window.pwaManager) {
                const cacheInfo = await window.pwaManager.getCacheInfo();
                output.textContent += JSON.stringify(cacheInfo, null, 2) + '\n';
            } else {
                output.textContent += 'âŒ PWA ç®¡ç†å™¨æœªè¼‰å…¥\n';
            }
        }
        
        async function testCacheResources() {
            const output = document.getElementById('cacheOutput');
            output.textContent += 'æ­£åœ¨å¿«å–æ¸¬è©¦è³‡æº...\n';
            
            const testUrls = [
                '/test/test-pwa.html',
                '../css/style.css',
                '../css/pwa.css'
            ];
            
            if (window.pwaManager) {
                await window.pwaManager.precacheResources(testUrls);
                output.textContent += 'âœ… è³‡æºå·²å¿«å–\n';
            } else {
                output.textContent += 'âŒ PWA ç®¡ç†å™¨æœªè¼‰å…¥\n';
            }
        }
        
        function testOfflineMode() {
            const output = document.getElementById('cacheOutput');
            output.textContent += 'æ¨¡æ“¬é›¢ç·šç‹€æ…‹...\n';
            
            // è§¸ç™¼é›¢ç·šäº‹ä»¶
            window.dispatchEvent(new Event('offline'));
            output.textContent += 'ğŸ“¡ å·²è§¸ç™¼é›¢ç·šäº‹ä»¶\n';
            
            setTimeout(() => {
                window.dispatchEvent(new Event('online'));
                output.textContent += 'ğŸŒ å·²æ¢å¾©ç·šä¸Šç‹€æ…‹\n';
            }, 3000);
        }
        
        async function clearAllCaches() {
            const output = document.getElementById('cacheOutput');
            output.textContent += 'æ­£åœ¨æ¸…é™¤æ‰€æœ‰å¿«å–...\n';
            
            if (window.pwaManager) {
                await window.pwaManager.clearCache();
                output.textContent += 'âœ… å¿«å–å·²æ¸…é™¤\n';
            } else {
                output.textContent += 'âŒ PWA ç®¡ç†å™¨æœªè¼‰å…¥\n';
            }
        }
        
        // å®‰è£æ¸¬è©¦
        function testInstallPrompt() {
            const output = document.getElementById('installOutput');
            output.textContent = 'æ¸¬è©¦å®‰è£æç¤º...\n';
            
            if (window.pwaManager) {
                window.pwaManager.promptInstall();
                output.textContent += 'ğŸ“± å®‰è£æç¤ºå·²è§¸ç™¼\n';
            } else {
                output.textContent += 'âŒ PWA ç®¡ç†å™¨æœªè¼‰å…¥\n';
            }
        }
        
        function testInstallStatus() {
            const output = document.getElementById('installOutput');
            
            if (window.pwaManager) {
                const status = window.pwaManager.getStatus();
                output.textContent = JSON.stringify(status, null, 2) + '\n';
            } else {
                output.textContent = 'âŒ PWA ç®¡ç†å™¨æœªè¼‰å…¥\n';
            }
        }
        
        function showPWASettings() {
            if (window.PWASettings) {
                const settings = new window.PWASettings();
                settings.show();
            } else {
                alert('PWA è¨­å®šæ¨¡çµ„æœªè¼‰å…¥');
            }
        }
        
        // é€šçŸ¥æ¸¬è©¦
        function testInstallBanner() {
            const output = document.getElementById('notificationOutput');
            output.textContent = 'é¡¯ç¤ºå®‰è£æ©«å¹…...\n';
            
            if (window.pwaManager) {
                window.pwaManager.showInstallBanner();
                output.textContent += 'ğŸ“¢ å®‰è£æ©«å¹…å·²é¡¯ç¤º\n';
            } else {
                output.textContent += 'âŒ PWA ç®¡ç†å™¨æœªè¼‰å…¥\n';
            }
        }
        
        function testUpdateNotification() {
            const output = document.getElementById('notificationOutput');
            output.textContent += 'é¡¯ç¤ºæ›´æ–°é€šçŸ¥...\n';
            
            if (window.pwaManager) {
                window.pwaManager.showUpdateAvailableNotification();
                output.textContent += 'ğŸ”„ æ›´æ–°é€šçŸ¥å·²é¡¯ç¤º\n';
            } else {
                output.textContent += 'âŒ PWA ç®¡ç†å™¨æœªè¼‰å…¥\n';
            }
        }
        
        function testNetworkStatus() {
            const output = document.getElementById('notificationOutput');
            output.textContent += 'æ¸¬è©¦ç¶²è·¯ç‹€æ…‹é€šçŸ¥...\n';
            
            if (window.pwaManager) {
                window.pwaManager.showNetworkStatusNotification('æ¸¬è©¦è¨Šæ¯', 'success');
                output.textContent += 'ğŸ“¡ ç¶²è·¯ç‹€æ…‹é€šçŸ¥å·²é¡¯ç¤º\n';
            } else {
                output.textContent += 'âŒ PWA ç®¡ç†å™¨æœªè¼‰å…¥\n';
            }
        }
        
        function clearNotifications() {
            // æ¸…é™¤æ‰€æœ‰é€šçŸ¥å…ƒç´ 
            document.querySelectorAll('.pwa-install-banner, .pwa-update-notification, .pwa-offline-indicator').forEach(el => {
                el.remove();
            });
            
            const output = document.getElementById('notificationOutput');
            output.textContent += 'ğŸ§¹ æ‰€æœ‰é€šçŸ¥å·²æ¸…é™¤\n';
        }
    </script>
</body>
</html>