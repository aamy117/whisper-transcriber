<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>批次編輯功能測試</title>
  <link rel="stylesheet" href="../css/style.css">
  <style>
    body {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .test-controls {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      padding: 20px;
      background: var(--secondary-bg);
      border-radius: 8px;
    }
    
    .batch-toolbar {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--primary-bg);
      border: 1px solid var(--border-color);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      display: none;
      z-index: 1000;
      transition: all 0.3s ease;
    }
    
    .batch-toolbar.show {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .batch-toolbar .selection-info {
      margin-right: 20px;
      font-weight: bold;
      color: var(--primary-color);
    }
    
    .batch-toolbar button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .batch-toolbar button:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    .batch-toolbar .btn-select {
      background: var(--secondary-bg);
      color: var(--text-color);
    }
    
    .batch-toolbar .btn-operation {
      background: var(--primary-color);
      color: white;
    }
    
    .batch-toolbar .btn-danger {
      background: #ef4444;
      color: white;
    }
    
    .stats {
      margin-top: 20px;
      padding: 15px;
      background: var(--secondary-bg);
      border-radius: 8px;
    }
    
    #editor-container {
      height: 600px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--primary-bg);
    }
  </style>
</head>
<body>
  <h1>批次編輯功能測試</h1>
  
  <div class="test-controls">
    <button onclick="generateTestData()">生成測試數據</button>
    <button onclick="toggleBatchMode()">切換批次選擇模式</button>
    <button onclick="showStats()">顯示統計</button>
  </div>
  
  <div id="editor-container"></div>
  
  <!-- 批次操作工具欄 -->
  <div class="batch-toolbar" id="batchToolbar">
    <span class="selection-info">已選擇 <span id="selectedCount">0</span> 個段落</span>
    
    <!-- 選擇操作 -->
    <button class="btn-select" onclick="editor.batchSelectAll()">全選</button>
    <button class="btn-select" onclick="editor.batchSelectNone()">取消全選</button>
    <button class="btn-select" onclick="editor.batchSelectInvert()">反選</button>
    <button class="btn-select" onclick="selectByLength()">按長度選擇</button>
    
    <!-- 批次操作 -->
    <button class="btn-operation" onclick="editor.executeBatchOperation('merge')">合併</button>
    <button class="btn-operation" onclick="editor.executeBatchOperation('split')">分割</button>
    <button class="btn-operation" onclick="editor.executeBatchOperation('findReplace')">尋找取代</button>
    <button class="btn-operation" onclick="editor.executeBatchOperation('adjustTime')">調整時間</button>
    <button class="btn-operation" onclick="exportSelected()">導出選中</button>
    <button class="btn-danger" onclick="editor.executeBatchOperation('delete')">刪除</button>
  </div>
  
  <div class="stats" id="stats"></div>
  
  <script type="module">
    import { TranscriptionEditor } from '../js/editor.js';
    import { notify } from '../js/notification.js';
    
    // 創建編輯器實例
    const container = document.getElementById('editor-container');
    window.editor = new TranscriptionEditor(container);
    
    // 生成測試數據
    window.generateTestData = function() {
      const segments = [];
      const texts = [
        '這是第一個測試段落，包含一些文字內容。',
        '第二個段落比較短。',
        '第三個段落有更多的內容，用來測試不同長度的段落處理。這裡有更多的文字來填充內容。',
        '簡短段落。',
        '這是一個中等長度的段落，包含了適量的文字內容。',
        '極短。',
        '這個段落包含了一些特殊字符：！@#$%^&*()_+{}[]|\\:";\'<>?,./~`',
        '測試標點符號的段落，包含中文標點：，。！？；：、',
        '這是一個包含數字的段落：1234567890',
        '最後一個測試段落，用來測試批次操作的效果。'
      ];
      
      let currentTime = 0;
      for (let i = 0; i < 50; i++) {
        const text = texts[i % texts.length] + ` (段落 ${i + 1})`;
        const duration = 2 + Math.random() * 3; // 2-5秒
        
        segments.push({
          id: i,
          start: currentTime,
          end: currentTime + duration,
          text: text,
          textWithPunctuation: text,
          textWithoutPunctuation: text.replace(/[，。！？；：、,\.!?;:'"'"（）\[\]{}【】]/g, ' ').trim(),
          edited: text,
          isEdited: false
        });
        
        currentTime += duration;
      }
      
      editor.loadTranscription({ segments });
      notify.success('已生成 50 個測試段落');
    };
    
    // 切換批次選擇模式
    window.toggleBatchMode = function() {
      const isEnabled = editor.toggleBatchSelectionMode();
      notify.info(isEnabled ? '已啟用批次選擇模式' : '已退出批次選擇模式');
    };
    
    // 顯示統計資訊
    window.showStats = function() {
      const status = editor.getBatchSelectionStatus();
      const virtualStats = editor.getVirtualScrollStats();
      
      const statsHtml = `
        <h3>編輯器統計</h3>
        <p>總段落數：${status.total}</p>
        <p>批次選擇模式：${status.enabled ? '開啟' : '關閉'}</p>
        <p>已選擇段落：${status.count}</p>
        ${virtualStats ? `
          <h4>虛擬滾動統計</h4>
          <p>虛擬滾動：${virtualStats.isVirtualMode ? '啟用' : '禁用'}</p>
          <p>可見範圍：${virtualStats.visibleStart} - ${virtualStats.visibleEnd}</p>
          <p>渲染數量：${virtualStats.renderedCount}</p>
        ` : '<p>虛擬滾動未啟用</p>'}
      `;
      
      document.getElementById('stats').innerHTML = statsHtml;
    };
    
    // 按長度選擇段落
    window.selectByLength = function() {
      const minLength = prompt('請輸入最小長度：', '10');
      if (!minLength) return;
      
      editor.batchSelectByCondition((segment) => {
        const text = segment.edited || segment.text;
        return text.length >= parseInt(minLength);
      });
    };
    
    // 導出選中的段落
    window.exportSelected = function() {
      if (!editor.batchEditor) return;
      
      const format = prompt('請輸入導出格式 (txt/srt/json)：', 'txt');
      if (!format) return;
      
      editor.batchEditor.exportSelected(format);
    };
    
    // 監聽批次選擇變化
    document.addEventListener('batchSelectionChanged', (e) => {
      const toolbar = document.getElementById('batchToolbar');
      const countEl = document.getElementById('selectedCount');
      
      if (e.detail.isSelectionMode) {
        toolbar.classList.add('show');
        countEl.textContent = e.detail.selectedCount;
      } else {
        toolbar.classList.remove('show');
      }
    });
    
    // 初始化
    generateTestData();
    showStats();
  </script>
</body>
</html>