<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çœŸå¯¦ WASM è½‰è­¯æ¸¬è©¦</title>
    
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/dialog.css">
    <link rel="stylesheet" href="css/notification.css">
    <link rel="stylesheet" href="css/preprocessing.css">
    
    <style>
        .test-container {
            max-width: 900px;
            margin: 2rem auto;
            padding: 2rem;
        }
        
        .test-header {
            text-align: center;
            padding: 2rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        
        .test-section {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .control-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 3rem;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            margin: 1rem 0;
        }
        
        .upload-area:hover {
            border-color: var(--primary-color);
            background: var(--bg-tertiary);
        }
        
        #fileInput {
            display: none;
        }
        
        .log-container {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 1rem;
            height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.85rem;
        }
        
        .log-entry {
            padding: 0.25rem 0;
            border-bottom: 1px solid var(--border-lighter);
        }
        
        .log-info { color: var(--text-secondary); }
        .log-success { color: var(--success-color); }
        .log-error { color: var(--error-color); }
        .log-warning { color: var(--warning-color); }
        
        .result-container {
            background: var(--bg-tertiary);
            padding: 1.5rem;
            border-radius: 6px;
            margin-top: 1rem;
            display: none;
        }
        
        .result-text {
            white-space: pre-wrap;
            line-height: 1.6;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-ready {
            background: var(--success-color);
            color: white;
        }
        
        .status-loading {
            background: var(--warning-color);
            color: white;
        }
        
        .status-error {
            background: var(--error-color);
            color: white;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>ğŸ¯ çœŸå¯¦ WASM è½‰è­¯æ¸¬è©¦</h1>
            <p>æ¸¬è©¦ Transformers.js å¯¦ç¾çš„æœ¬åœ°èªéŸ³è­˜åˆ¥</p>
            <div style="margin-top: 1rem;">
                <span class="status-badge" id="statusBadge">æœªåˆå§‹åŒ–</span>
            </div>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="test-section">
            <h3>æ§åˆ¶è¨­å®š</h3>
            <div class="control-panel">
                <div class="control-item">
                    <input type="checkbox" id="enableRealWASM" checked>
                    <label for="enableRealWASM">å•Ÿç”¨çœŸå¯¦ WASM</label>
                </div>
                <div class="control-item">
                    <label for="modelSelect">é¸æ“‡æ¨¡å‹ï¼š</label>
                    <select id="modelSelect">
                        <option value="tiny">Tiny (39MB)</option>
                        <option value="base">Base (74MB)</option>
                        <option value="small">Small (244MB)</option>
                    </select>
                </div>
                <div class="control-item">
                    <button class="btn btn-secondary" onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
                </div>
            </div>
        </div>

        <!-- æª”æ¡ˆä¸Šå‚³ -->
        <div class="test-section">
            <h3>ä¸Šå‚³éŸ³è¨Šæª”æ¡ˆ</h3>
            <div class="upload-area" id="uploadArea">
                <p>ğŸµ æ‹–æ”¾éŸ³è¨Šæª”æ¡ˆåˆ°æ­¤è™•</p>
                <p>æˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ</p>
                <input type="file" id="fileInput" accept="audio/*">
            </div>
            
            <div style="text-align: center; margin-top: 1rem;">
                <button class="btn btn-primary" id="transcribeBtn" disabled>
                    é–‹å§‹è½‰è­¯
                </button>
            </div>
        </div>

        <!-- è½‰è­¯çµæœ -->
        <div class="test-section">
            <h3>è½‰è­¯çµæœ</h3>
            <div class="result-container" id="resultContainer">
                <div class="result-text" id="resultText"></div>
            </div>
            <div id="noResult" style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                å°šç„¡è½‰è­¯çµæœ
            </div>
        </div>

        <!-- æ—¥èªŒ -->
        <div class="test-section">
            <h3>åŸ·è¡Œæ—¥èªŒ</h3>
            <div class="log-container" id="logContainer">
                <div class="log-entry log-info">ç³»çµ±å°±ç·’ï¼Œç­‰å¾…åˆå§‹åŒ–...</div>
            </div>
        </div>

        <!-- é€šçŸ¥å®¹å™¨ -->
        <div id="notification-container"></div>
    </div>

    <script type="module">
        import { transcriptionPreprocessor } from './js/transcription-preprocessor.js';
        import { notify } from './js/notification.js';
        
        let currentFile = null;
        let isInitialized = false;
        
        // æ—¥èªŒåŠŸèƒ½
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const time = new Date().toLocaleTimeString();
            entry.textContent = `[${time}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // æ¸…é™¤æ—¥èªŒ
        window.clearLog = function() {
            document.getElementById('logContainer').innerHTML = 
                '<div class="log-entry log-info">æ—¥èªŒå·²æ¸…é™¤</div>';
        };
        
        // æ›´æ–°ç‹€æ…‹å¾½ç« 
        function updateStatus(status, text) {
            const badge = document.getElementById('statusBadge');
            badge.className = `status-badge status-${status}`;
            badge.textContent = text;
        }
        
        // åˆå§‹åŒ–
        async function init() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const transcribeBtn = document.getElementById('transcribeBtn');
            
            // è¨­å®š WASM ç‹€æ…‹
            const enableRealWASM = document.getElementById('enableRealWASM');
            enableRealWASM.addEventListener('change', (e) => {
                transcriptionPreprocessor.ENABLE_WASM = e.target.checked;
                if (e.target.checked) {
                    // å•Ÿç”¨çœŸå¯¦ WASM
                    if (transcriptionPreprocessor.wasmManager) {
                        transcriptionPreprocessor.wasmManager.ENABLE_REAL_WASM = true;
                        log('å·²å•Ÿç”¨çœŸå¯¦ WASM æ¨¡å¼', 'success');
                    }
                } else {
                    log('å·²åˆ‡æ›åˆ°æ¨¡æ“¬æ¨¡å¼', 'warning');
                }
            });
            
            // æª”æ¡ˆä¸Šå‚³
            uploadArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileSelect);
            
            // æ‹–æ”¾
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                if (e.dataTransfer.files[0]) {
                    handleFile(e.dataTransfer.files[0]);
                }
            });
            
            // è½‰è­¯æŒ‰éˆ•
            transcribeBtn.addEventListener('click', startTranscription);
            
            // åˆå§‹åŒ– WASM
            await initializeWASM();
        }
        
        // åˆå§‹åŒ– WASM
        async function initializeWASM() {
            try {
                updateStatus('loading', 'æ­£åœ¨åˆå§‹åŒ–...');
                log('é–‹å§‹åˆå§‹åŒ– WASM ç’°å¢ƒ...');
                
                // ç¢ºä¿ transcriptionPreprocessor å·²è¨­å®š
                transcriptionPreprocessor.ENABLE_WASM = true;
                
                // é å…ˆåˆå§‹åŒ– WASM ç®¡ç†å™¨
                const { WhisperWASMManager } = await import('./js/wasm/whisper-wasm-manager.js');
                const wasmManager = new WhisperWASMManager();
                wasmManager.ENABLE_REAL_WASM = true; // å•Ÿç”¨çœŸå¯¦ WASM
                
                // å„²å­˜åˆ° preprocessor
                transcriptionPreprocessor.wasmManager = wasmManager;
                
                // åˆå§‹åŒ–é¸å®šçš„æ¨¡å‹
                const modelName = document.getElementById('modelSelect').value;
                log(`æ­£åœ¨è¼‰å…¥ ${modelName} æ¨¡å‹...`);
                
                await wasmManager.initialize(modelName);
                
                isInitialized = true;
                updateStatus('ready', 'å°±ç·’');
                log('WASM åˆå§‹åŒ–å®Œæˆï¼', 'success');
                
                // å•Ÿç”¨è½‰è­¯æŒ‰éˆ•
                if (currentFile) {
                    document.getElementById('transcribeBtn').disabled = false;
                }
                
            } catch (error) {
                updateStatus('error', 'åˆå§‹åŒ–å¤±æ•—');
                log(`åˆå§‹åŒ–å¤±æ•—: ${error.message}`, 'error');
                console.error('åˆå§‹åŒ–éŒ¯èª¤:', error);
            }
        }
        
        // è™•ç†æª”æ¡ˆé¸æ“‡
        function handleFileSelect(event) {
            if (event.target.files[0]) {
                handleFile(event.target.files[0]);
            }
        }
        
        // è™•ç†æª”æ¡ˆ
        function handleFile(file) {
            currentFile = file;
            log(`å·²é¸æ“‡æª”æ¡ˆ: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
            
            if (isInitialized) {
                document.getElementById('transcribeBtn').disabled = false;
            }
            
            notify.success(`å·²è¼‰å…¥: ${file.name}`);
        }
        
        // é–‹å§‹è½‰è­¯
        async function startTranscription() {
            if (!currentFile) return;
            
            const transcribeBtn = document.getElementById('transcribeBtn');
            const resultContainer = document.getElementById('resultContainer');
            const resultText = document.getElementById('resultText');
            const noResult = document.getElementById('noResult');
            
            try {
                transcribeBtn.disabled = true;
                transcribeBtn.textContent = 'è½‰è­¯ä¸­...';
                updateStatus('loading', 'è½‰è­¯ä¸­...');
                
                log('é–‹å§‹è½‰è­¯æµç¨‹...');
                
                // æ¨¡æ“¬é¸æ“‡æœ¬åœ°è½‰è­¯
                const originalShowMethod = transcriptionPreprocessor.showTranscriptionMethodChoice;
                transcriptionPreprocessor.showTranscriptionMethodChoice = async () => {
                    log('è‡ªå‹•é¸æ“‡æœ¬åœ°è½‰è­¯æ¨¡å¼');
                    return 'local';
                };
                
                // åŸ·è¡Œè½‰è­¯
                const result = await transcriptionPreprocessor.prepareForTranscription(currentFile);
                
                log('é è™•ç†å®Œæˆï¼Œé–‹å§‹å¯¦éš›è½‰è­¯...');
                
                // å¦‚æœæœ‰ WASM ç®¡ç†å™¨ï¼ŒåŸ·è¡Œè½‰è­¯
                if (result.wasmManager) {
                    // ç›£è½é€²åº¦äº‹ä»¶
                    const progressHandler = (event) => {
                        const progress = event.detail;
                        log(`è½‰è­¯é€²åº¦: ${progress.message}`);
                    };
                    window.addEventListener('whisper-progress', progressHandler);
                    
                    try {
                        const transcriptionResult = await result.wasmManager.transcribe(currentFile, {
                            language: 'zh-TW' // ä½¿ç”¨ç¹é«”ä¸­æ–‡
                        });
                        
                        // é¡¯ç¤ºçµæœ
                        resultText.textContent = transcriptionResult.text || 'ï¼ˆç„¡è½‰è­¯çµæœï¼‰';
                        resultContainer.style.display = 'block';
                        noResult.style.display = 'none';
                        
                        log('è½‰è­¯å®Œæˆï¼', 'success');
                        updateStatus('ready', 'å®Œæˆ');
                        
                        // é¡¯ç¤ºæ®µè½è³‡è¨Š
                        if (transcriptionResult.segments) {
                            log(`å…± ${transcriptionResult.segments.length} å€‹æ®µè½`);
                        }
                    } finally {
                        // ç§»é™¤é€²åº¦ç›£è½å™¨
                        window.removeEventListener('whisper-progress', progressHandler);
                    }
                }
                
                // æ¢å¾©åŸæ–¹æ³•
                transcriptionPreprocessor.showTranscriptionMethodChoice = originalShowMethod;
                
            } catch (error) {
                log(`è½‰è­¯å¤±æ•—: ${error.message}`, 'error');
                updateStatus('error', 'è½‰è­¯å¤±æ•—');
                notify.error(`è½‰è­¯å¤±æ•—: ${error.message}`);
            } finally {
                transcribeBtn.disabled = false;
                transcribeBtn.textContent = 'é–‹å§‹è½‰è­¯';
            }
        }
        
        // æ¨¡å‹è®Šæ›´
        document.getElementById('modelSelect').addEventListener('change', async () => {
            if (isInitialized) {
                log('æ¨¡å‹è®Šæ›´ï¼Œé‡æ–°åˆå§‹åŒ–...');
                await initializeWASM();
            }
        });
        
        // å•Ÿå‹•
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>