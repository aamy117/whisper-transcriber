<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASM ä¸»ç¨‹å¼æ•´åˆæ¸¬è©¦</title>
    
    <!-- å¼•å…¥ä¸»ç¨‹å¼æ‰€éœ€çš„æ¨£å¼ -->
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/dialog.css">
    <link rel="stylesheet" href="../css/notification.css">
    <link rel="stylesheet" href="../css/preprocessing.css">
    <link rel="stylesheet" href="../css/progress.css">
    
    <style>
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .test-section {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        
        .test-controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        
        .log {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 1rem;
            height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.85rem;
        }
        
        .log-entry {
            margin-bottom: 0.25rem;
            padding: 0.25rem;
        }
        
        .log-success { color: var(--success-color); }
        .log-error { color: var(--error-color); }
        .log-info { color: var(--text-secondary); }
        .log-warning { color: var(--warning-color); }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .status-card {
            background: var(--bg-primary);
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        
        .status-ok { color: var(--success-color); }
        .status-error { color: var(--error-color); }
        
        #audioFile {
            display: none;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ§ª WASM ä¸»ç¨‹å¼æ•´åˆæ¸¬è©¦</h1>
        <p>æ¸¬è©¦ä¸»ç¨‹å¼èˆ‡ WASM è½‰è­¯åŠŸèƒ½çš„æ•´åˆ</p>
        
        <!-- ç‹€æ…‹é¡¯ç¤º -->
        <div class="test-section">
            <h2>ç³»çµ±ç‹€æ…‹</h2>
            <div class="status-grid">
                <div class="status-card">
                    <h4>ä¸»ç¨‹å¼ç‹€æ…‹</h4>
                    <div id="appStatus">æœªè¼‰å…¥</div>
                </div>
                <div class="status-card">
                    <h4>WASM ç®¡ç†å™¨</h4>
                    <div id="wasmStatus">æœªåˆå§‹åŒ–</div>
                </div>
                <div class="status-card">
                    <h4>é è™•ç†å™¨</h4>
                    <div id="preprocessorStatus">æœªè¼‰å…¥</div>
                </div>
                <div class="status-card">
                    <h4>å–æ¶ˆä»¤ç‰Œ</h4>
                    <div id="tokenStatus">æœªå‰µå»º</div>
                </div>
            </div>
        </div>
        
        <!-- æ¸¬è©¦æ§åˆ¶ -->
        <div class="test-section">
            <h2>æ¸¬è©¦åŠŸèƒ½</h2>
            <div class="test-controls">
                <button class="btn btn-primary" onclick="testInit()">åˆå§‹åŒ–ç³»çµ±</button>
                <button class="btn btn-secondary" onclick="testPreprocessor()">æ¸¬è©¦é è™•ç†å™¨</button>
                <button class="btn btn-secondary" onclick="testWASMDirect()">ç›´æ¥æ¸¬è©¦ WASM</button>
                <label class="btn btn-primary">
                    é¸æ“‡éŸ³è¨Šæª”æ¡ˆ
                    <input type="file" id="audioFile" accept="audio/*" onchange="testFullFlow(this.files[0])">
                </label>
                <button class="btn btn-warning" onclick="testCancel()">æ¸¬è©¦å–æ¶ˆåŠŸèƒ½</button>
                <button class="btn btn-secondary" onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
            </div>
        </div>
        
        <!-- æ¸¬è©¦æ—¥èªŒ -->
        <div class="test-section">
            <h2>æ¸¬è©¦æ—¥èªŒ</h2>
            <div class="log" id="testLog"></div>
        </div>
    </div>
    
    <!-- è¼‰å…¥ä¾è³´ -->
    <script src="../js/config.js"></script>
    <script type="module">
        // åŒ¯å…¥å¿…è¦çš„æ¨¡çµ„
        import { WhisperApp } from '../js/main.js';
        import { WhisperWASMManager } from '../js/wasm/whisper-wasm-manager.js';
        import { transcriptionPreprocessor } from '../js/transcription-preprocessor.js';
        import { CancellationToken } from '../js/utils/cancellation-token.js';
        import { notify } from '../js/notification.js';
        import { progressManager } from '../js/progress-manager.js';
        
        let app = null;
        let cancellationToken = null;
        
        // æ—¥èªŒåŠŸèƒ½
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type}]`, message);
        }
        
        // æ›´æ–°ç‹€æ…‹
        function updateStatus(id, text, isOk = true) {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = text;
                el.className = isOk ? 'status-ok' : 'status-error';
            }
        }
        
        // åˆå§‹åŒ–ç³»çµ±
        window.testInit = async function() {
            try {
                log('é–‹å§‹åˆå§‹åŒ–ç³»çµ±...');
                
                // å‰µå»ºä¸»ç¨‹å¼å¯¦ä¾‹
                log('å‰µå»º WhisperApp å¯¦ä¾‹...');
                window.whisperApp = app = new WhisperApp();
                await app.init();
                updateStatus('appStatus', 'å·²åˆå§‹åŒ–', true);
                log('ä¸»ç¨‹å¼åˆå§‹åŒ–æˆåŠŸ', 'success');
                
                // æª¢æŸ¥ WASM ç®¡ç†å™¨
                if (app.wasmManager) {
                    updateStatus('wasmStatus', 'å·²å‰µå»º', true);
                    log('WASM ç®¡ç†å™¨å·²å‰µå»º', 'success');
                } else {
                    updateStatus('wasmStatus', 'æœªå‰µå»º', false);
                    log('WASM ç®¡ç†å™¨æœªå‰µå»º', 'warning');
                }
                
                // æª¢æŸ¥é è™•ç†å™¨
                if (transcriptionPreprocessor) {
                    updateStatus('preprocessorStatus', 'å·²è¼‰å…¥', true);
                    log('é è™•ç†å™¨å·²è¼‰å…¥', 'success');
                } else {
                    updateStatus('preprocessorStatus', 'è¼‰å…¥å¤±æ•—', false);
                    log('é è™•ç†å™¨è¼‰å…¥å¤±æ•—', 'error');
                }
                
                notify.success('ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
                
            } catch (error) {
                log(`åˆå§‹åŒ–å¤±æ•—: ${error.message}`, 'error');
                updateStatus('appStatus', 'åˆå§‹åŒ–å¤±æ•—', false);
                notify.error(`åˆå§‹åŒ–å¤±æ•—: ${error.message}`);
            }
        };
        
        // æ¸¬è©¦é è™•ç†å™¨
        window.testPreprocessor = async function() {
            try {
                log('æ¸¬è©¦é è™•ç†å™¨...');
                
                // å‰µå»ºæ¸¬è©¦æª”æ¡ˆï¼ˆ30MBï¼Œè§¸ç™¼å¤§æª”æ¡ˆè™•ç†ï¼‰
                const size = 30 * 1024 * 1024;
                const buffer = new ArrayBuffer(size);
                const blob = new Blob([buffer], { type: 'audio/wav' });
                const file = new File([blob], 'test-large.wav', { type: 'audio/wav' });
                
                log(`å‰µå»ºæ¸¬è©¦æª”æ¡ˆ: ${file.name} (${(file.size/1024/1024).toFixed(1)}MB)`);
                
                // å‰µå»ºå–æ¶ˆä»¤ç‰Œ
                cancellationToken = new CancellationToken();
                updateStatus('tokenStatus', 'å·²å‰µå»º', true);
                
                // èª¿ç”¨é è™•ç†å™¨
                log('èª¿ç”¨ prepareForTranscription...');
                const result = await transcriptionPreprocessor.prepareForTranscription(file, {
                    cancellationToken: cancellationToken
                });
                
                log(`é è™•ç†çµæœ:`, 'success');
                log(`- ç­–ç•¥: ${result.strategy}`);
                log(`- æª”æ¡ˆæ•¸: ${result.files.length}`);
                if (result.wasmManager) {
                    log(`- WASM ç®¡ç†å™¨: å·²è¿”å›`);
                }
                
                notify.success('é è™•ç†å™¨æ¸¬è©¦å®Œæˆ');
                
            } catch (error) {
                if (error.message.includes('å–æ¶ˆ')) {
                    log('ä½¿ç”¨è€…å–æ¶ˆæ“ä½œ', 'warning');
                } else {
                    log(`é è™•ç†å™¨æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                    notify.error(`æ¸¬è©¦å¤±æ•—: ${error.message}`);
                }
            }
        };
        
        // ç›´æ¥æ¸¬è©¦ WASM
        window.testWASMDirect = async function() {
            try {
                log('ç›´æ¥æ¸¬è©¦ WASM ç®¡ç†å™¨...');
                
                if (!app || !app.wasmManager) {
                    log('è«‹å…ˆåˆå§‹åŒ–ç³»çµ±', 'error');
                    return;
                }
                
                // å‰µå»ºå°æ¸¬è©¦æª”æ¡ˆ
                const buffer = new ArrayBuffer(16000 * 5); // 5ç§’éŸ³è¨Š
                const blob = new Blob([buffer], { type: 'audio/wav' });
                const file = new File([blob], 'test-small.wav', { type: 'audio/wav' });
                
                log('åˆå§‹åŒ– WASM (tiny æ¨¡å‹)...');
                await app.wasmManager.initialize('tiny');
                updateStatus('wasmStatus', 'å·²åˆå§‹åŒ– (tiny)', true);
                
                log('åŸ·è¡Œè½‰è­¯...');
                const result = await app.wasmManager.transcribe(file, {
                    onProgress: (progress) => {
                        log(`é€²åº¦: ${progress.percentage}% - ${progress.message}`);
                    }
                });
                
                log('è½‰è­¯å®Œæˆ!', 'success');
                log(`- æ–¹æ³•: ${result.method}`);
                log(`- æ–‡å­—é•·åº¦: ${result.text ? result.text.length : 0}`);
                
                notify.success('WASM ç›´æ¥æ¸¬è©¦å®Œæˆ');
                
            } catch (error) {
                log(`WASM æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                notify.error(`æ¸¬è©¦å¤±æ•—: ${error.message}`);
            }
        };
        
        // æ¸¬è©¦å®Œæ•´æµç¨‹
        window.testFullFlow = async function(file) {
            if (!file) return;
            
            try {
                log(`æ¸¬è©¦å®Œæ•´æµç¨‹: ${file.name} (${(file.size/1024/1024).toFixed(2)}MB)`);
                
                if (!app) {
                    log('è‡ªå‹•åˆå§‹åŒ–ç³»çµ±...');
                    await testInit();
                }
                
                // å‰µå»ºå–æ¶ˆä»¤ç‰Œ
                cancellationToken = new CancellationToken();
                updateStatus('tokenStatus', 'å·²å‰µå»º', true);
                
                // èª¿ç”¨ä¸»ç¨‹å¼çš„è½‰è­¯åŠŸèƒ½
                log('èª¿ç”¨ä¸»ç¨‹å¼ startTranscription...');
                
                // è¨­ç½®æª”æ¡ˆåˆ°æ’­æ”¾å™¨ï¼ˆæ¨¡æ“¬æ­£å¸¸æµç¨‹ï¼‰
                if (app.player && app.player.loadFile) {
                    await app.player.loadFile(file);
                }
                
                // é–‹å§‹è½‰è­¯
                await app.startTranscription();
                
                log('è½‰è­¯æµç¨‹å®Œæˆ!', 'success');
                notify.success('å®Œæ•´æµç¨‹æ¸¬è©¦å®Œæˆ');
                
            } catch (error) {
                log(`å®Œæ•´æµç¨‹æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                notify.error(`æ¸¬è©¦å¤±æ•—: ${error.message}`);
            }
        };
        
        // æ¸¬è©¦å–æ¶ˆåŠŸèƒ½
        window.testCancel = async function() {
            try {
                log('æ¸¬è©¦å–æ¶ˆåŠŸèƒ½...');
                
                // å‰µå»ºå¤§æª”æ¡ˆè§¸ç™¼è™•ç†é¸é …
                const size = 30 * 1024 * 1024;
                const buffer = new ArrayBuffer(size);
                const blob = new Blob([buffer], { type: 'audio/wav' });
                const file = new File([blob], 'test-cancel.wav', { type: 'audio/wav' });
                
                // å‰µå»ºå–æ¶ˆä»¤ç‰Œ
                cancellationToken = new CancellationToken();
                updateStatus('tokenStatus', 'å·²å‰µå»º', true);
                
                // è¨­ç½® 2 ç§’å¾Œå–æ¶ˆ
                setTimeout(() => {
                    log('è§¸ç™¼å–æ¶ˆ...', 'warning');
                    cancellationToken.cancel('æ¸¬è©¦å–æ¶ˆ');
                    updateStatus('tokenStatus', 'å·²å–æ¶ˆ', false);
                }, 2000);
                
                log('é–‹å§‹è™•ç†ï¼ˆ2ç§’å¾Œå°‡å–æ¶ˆï¼‰...');
                
                try {
                    const result = await transcriptionPreprocessor.prepareForTranscription(file, {
                        cancellationToken: cancellationToken
                    });
                    log('è™•ç†æœªè¢«å–æ¶ˆ!', 'error');
                } catch (error) {
                    if (error.message.includes('å–æ¶ˆ')) {
                        log('æˆåŠŸæ•ç²å–æ¶ˆäº‹ä»¶!', 'success');
                        notify.success('å–æ¶ˆåŠŸèƒ½æ¸¬è©¦é€šé');
                    } else {
                        throw error;
                    }
                }
                
            } catch (error) {
                log(`å–æ¶ˆæ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                notify.error(`æ¸¬è©¦å¤±æ•—: ${error.message}`);
            }
        };
        
        // æ¸…é™¤æ—¥èªŒ
        window.clearLog = function() {
            document.getElementById('testLog').innerHTML = '';
            log('æ—¥èªŒå·²æ¸…é™¤');
        };
        
        // é é¢è¼‰å…¥å®Œæˆ
        document.addEventListener('DOMContentLoaded', () => {
            log('WASM ä¸»ç¨‹å¼æ•´åˆæ¸¬è©¦é é¢å·²è¼‰å…¥');
            log('é»æ“Š"åˆå§‹åŒ–ç³»çµ±"é–‹å§‹æ¸¬è©¦');
            
            // é¡¯ç¤ºåˆå§‹ç‹€æ…‹
            updateStatus('appStatus', 'æœªè¼‰å…¥', false);
            updateStatus('wasmStatus', 'æœªåˆå§‹åŒ–', false);
            updateStatus('preprocessorStatus', 'æœªè¼‰å…¥', false);
            updateStatus('tokenStatus', 'æœªå‰µå»º', false);
        });
    </script>
</body>
</html>