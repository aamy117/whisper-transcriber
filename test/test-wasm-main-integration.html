<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASM 主程式整合測試</title>
    
    <!-- 引入主程式所需的樣式 -->
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/dialog.css">
    <link rel="stylesheet" href="../css/notification.css">
    <link rel="stylesheet" href="../css/preprocessing.css">
    <link rel="stylesheet" href="../css/progress.css">
    
    <style>
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .test-section {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        
        .test-controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        
        .log {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 1rem;
            height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.85rem;
        }
        
        .log-entry {
            margin-bottom: 0.25rem;
            padding: 0.25rem;
        }
        
        .log-success { color: var(--success-color); }
        .log-error { color: var(--error-color); }
        .log-info { color: var(--text-secondary); }
        .log-warning { color: var(--warning-color); }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .status-card {
            background: var(--bg-primary);
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        
        .status-ok { color: var(--success-color); }
        .status-error { color: var(--error-color); }
        
        #audioFile {
            display: none;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🧪 WASM 主程式整合測試</h1>
        <p>測試主程式與 WASM 轉譯功能的整合</p>
        
        <!-- 狀態顯示 -->
        <div class="test-section">
            <h2>系統狀態</h2>
            <div class="status-grid">
                <div class="status-card">
                    <h4>主程式狀態</h4>
                    <div id="appStatus">未載入</div>
                </div>
                <div class="status-card">
                    <h4>WASM 管理器</h4>
                    <div id="wasmStatus">未初始化</div>
                </div>
                <div class="status-card">
                    <h4>預處理器</h4>
                    <div id="preprocessorStatus">未載入</div>
                </div>
                <div class="status-card">
                    <h4>取消令牌</h4>
                    <div id="tokenStatus">未創建</div>
                </div>
            </div>
        </div>
        
        <!-- 測試控制 -->
        <div class="test-section">
            <h2>測試功能</h2>
            <div class="test-controls">
                <button class="btn btn-primary" onclick="testInit()">初始化系統</button>
                <button class="btn btn-secondary" onclick="testPreprocessor()">測試預處理器</button>
                <button class="btn btn-secondary" onclick="testWASMDirect()">直接測試 WASM</button>
                <label class="btn btn-primary">
                    選擇音訊檔案
                    <input type="file" id="audioFile" accept="audio/*" onchange="testFullFlow(this.files[0])">
                </label>
                <button class="btn btn-warning" onclick="testCancel()">測試取消功能</button>
                <button class="btn btn-secondary" onclick="clearLog()">清除日誌</button>
            </div>
        </div>
        
        <!-- 測試日誌 -->
        <div class="test-section">
            <h2>測試日誌</h2>
            <div class="log" id="testLog"></div>
        </div>
    </div>
    
    <!-- 載入依賴 -->
    <script src="../js/config.js"></script>
    <script type="module">
        // 匯入必要的模組
        import { WhisperApp } from '../js/main.js';
        import { WhisperWASMManager } from '../js/wasm/whisper-wasm-manager.js';
        import { transcriptionPreprocessor } from '../js/transcription-preprocessor.js';
        import { CancellationToken } from '../js/utils/cancellation-token.js';
        import { notify } from '../js/notification.js';
        import { progressManager } from '../js/progress-manager.js';
        
        let app = null;
        let cancellationToken = null;
        
        // 日誌功能
        function log(message, type = 'info') {
            const logDiv = document.getElementById('testLog');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type}]`, message);
        }
        
        // 更新狀態
        function updateStatus(id, text, isOk = true) {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = text;
                el.className = isOk ? 'status-ok' : 'status-error';
            }
        }
        
        // 初始化系統
        window.testInit = async function() {
            try {
                log('開始初始化系統...');
                
                // 創建主程式實例
                log('創建 WhisperApp 實例...');
                window.whisperApp = app = new WhisperApp();
                await app.init();
                updateStatus('appStatus', '已初始化', true);
                log('主程式初始化成功', 'success');
                
                // 檢查 WASM 管理器
                if (app.wasmManager) {
                    updateStatus('wasmStatus', '已創建', true);
                    log('WASM 管理器已創建', 'success');
                } else {
                    updateStatus('wasmStatus', '未創建', false);
                    log('WASM 管理器未創建', 'warning');
                }
                
                // 檢查預處理器
                if (transcriptionPreprocessor) {
                    updateStatus('preprocessorStatus', '已載入', true);
                    log('預處理器已載入', 'success');
                } else {
                    updateStatus('preprocessorStatus', '載入失敗', false);
                    log('預處理器載入失敗', 'error');
                }
                
                notify.success('系統初始化完成');
                
            } catch (error) {
                log(`初始化失敗: ${error.message}`, 'error');
                updateStatus('appStatus', '初始化失敗', false);
                notify.error(`初始化失敗: ${error.message}`);
            }
        };
        
        // 測試預處理器
        window.testPreprocessor = async function() {
            try {
                log('測試預處理器...');
                
                // 創建測試檔案（30MB，觸發大檔案處理）
                const size = 30 * 1024 * 1024;
                const buffer = new ArrayBuffer(size);
                const blob = new Blob([buffer], { type: 'audio/wav' });
                const file = new File([blob], 'test-large.wav', { type: 'audio/wav' });
                
                log(`創建測試檔案: ${file.name} (${(file.size/1024/1024).toFixed(1)}MB)`);
                
                // 創建取消令牌
                cancellationToken = new CancellationToken();
                updateStatus('tokenStatus', '已創建', true);
                
                // 調用預處理器
                log('調用 prepareForTranscription...');
                const result = await transcriptionPreprocessor.prepareForTranscription(file, {
                    cancellationToken: cancellationToken
                });
                
                log(`預處理結果:`, 'success');
                log(`- 策略: ${result.strategy}`);
                log(`- 檔案數: ${result.files.length}`);
                if (result.wasmManager) {
                    log(`- WASM 管理器: 已返回`);
                }
                
                notify.success('預處理器測試完成');
                
            } catch (error) {
                if (error.message.includes('取消')) {
                    log('使用者取消操作', 'warning');
                } else {
                    log(`預處理器測試失敗: ${error.message}`, 'error');
                    notify.error(`測試失敗: ${error.message}`);
                }
            }
        };
        
        // 直接測試 WASM
        window.testWASMDirect = async function() {
            try {
                log('直接測試 WASM 管理器...');
                
                if (!app || !app.wasmManager) {
                    log('請先初始化系統', 'error');
                    return;
                }
                
                // 創建小測試檔案
                const buffer = new ArrayBuffer(16000 * 5); // 5秒音訊
                const blob = new Blob([buffer], { type: 'audio/wav' });
                const file = new File([blob], 'test-small.wav', { type: 'audio/wav' });
                
                log('初始化 WASM (tiny 模型)...');
                await app.wasmManager.initialize('tiny');
                updateStatus('wasmStatus', '已初始化 (tiny)', true);
                
                log('執行轉譯...');
                const result = await app.wasmManager.transcribe(file, {
                    onProgress: (progress) => {
                        log(`進度: ${progress.percentage}% - ${progress.message}`);
                    }
                });
                
                log('轉譯完成!', 'success');
                log(`- 方法: ${result.method}`);
                log(`- 文字長度: ${result.text ? result.text.length : 0}`);
                
                notify.success('WASM 直接測試完成');
                
            } catch (error) {
                log(`WASM 測試失敗: ${error.message}`, 'error');
                notify.error(`測試失敗: ${error.message}`);
            }
        };
        
        // 測試完整流程
        window.testFullFlow = async function(file) {
            if (!file) return;
            
            try {
                log(`測試完整流程: ${file.name} (${(file.size/1024/1024).toFixed(2)}MB)`);
                
                if (!app) {
                    log('自動初始化系統...');
                    await testInit();
                }
                
                // 創建取消令牌
                cancellationToken = new CancellationToken();
                updateStatus('tokenStatus', '已創建', true);
                
                // 調用主程式的轉譯功能
                log('調用主程式 startTranscription...');
                
                // 設置檔案到播放器（模擬正常流程）
                if (app.player && app.player.loadFile) {
                    await app.player.loadFile(file);
                }
                
                // 開始轉譯
                await app.startTranscription();
                
                log('轉譯流程完成!', 'success');
                notify.success('完整流程測試完成');
                
            } catch (error) {
                log(`完整流程測試失敗: ${error.message}`, 'error');
                notify.error(`測試失敗: ${error.message}`);
            }
        };
        
        // 測試取消功能
        window.testCancel = async function() {
            try {
                log('測試取消功能...');
                
                // 創建大檔案觸發處理選項
                const size = 30 * 1024 * 1024;
                const buffer = new ArrayBuffer(size);
                const blob = new Blob([buffer], { type: 'audio/wav' });
                const file = new File([blob], 'test-cancel.wav', { type: 'audio/wav' });
                
                // 創建取消令牌
                cancellationToken = new CancellationToken();
                updateStatus('tokenStatus', '已創建', true);
                
                // 設置 2 秒後取消
                setTimeout(() => {
                    log('觸發取消...', 'warning');
                    cancellationToken.cancel('測試取消');
                    updateStatus('tokenStatus', '已取消', false);
                }, 2000);
                
                log('開始處理（2秒後將取消）...');
                
                try {
                    const result = await transcriptionPreprocessor.prepareForTranscription(file, {
                        cancellationToken: cancellationToken
                    });
                    log('處理未被取消!', 'error');
                } catch (error) {
                    if (error.message.includes('取消')) {
                        log('成功捕獲取消事件!', 'success');
                        notify.success('取消功能測試通過');
                    } else {
                        throw error;
                    }
                }
                
            } catch (error) {
                log(`取消測試失敗: ${error.message}`, 'error');
                notify.error(`測試失敗: ${error.message}`);
            }
        };
        
        // 清除日誌
        window.clearLog = function() {
            document.getElementById('testLog').innerHTML = '';
            log('日誌已清除');
        };
        
        // 頁面載入完成
        document.addEventListener('DOMContentLoaded', () => {
            log('WASM 主程式整合測試頁面已載入');
            log('點擊"初始化系統"開始測試');
            
            // 顯示初始狀態
            updateStatus('appStatus', '未載入', false);
            updateStatus('wasmStatus', '未初始化', false);
            updateStatus('preprocessorStatus', '未載入', false);
            updateStatus('tokenStatus', '未創建', false);
        });
    </script>
</body>
</html>