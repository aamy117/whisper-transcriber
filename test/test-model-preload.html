<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>模型預載入測試</title>
  <link rel="stylesheet" href="../css/style.css">
  <style>
    body {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .test-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .test-section h2 {
      margin-top: 0;
      color: var(--primary-color);
    }
    
    .test-controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    
    .test-button {
      padding: 8px 16px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    
    .test-button:hover {
      opacity: 0.8;
    }
    
    .test-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .test-button.secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
    }
    
    .test-output {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 15px;
      min-height: 200px;
      max-height: 400px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.9rem;
      white-space: pre-wrap;
    }
    
    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .status-card {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 15px;
    }
    
    .status-card h3 {
      margin-top: 0;
      font-size: 1rem;
      color: var(--text-secondary);
    }
    
    .status-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--primary-color);
    }
    
    .model-card {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 15px;
      margin-bottom: 10px;
    }
    
    .model-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .model-name {
      font-weight: bold;
      text-transform: capitalize;
    }
    
    .model-status {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.85rem;
      background: var(--bg-secondary);
    }
    
    .model-status.loaded {
      background: var(--success-color);
      color: white;
    }
    
    .model-status.loading {
      background: var(--warning-color);
      color: white;
    }
    
    .model-status.error {
      background: var(--error-color);
      color: white;
    }
    
    .progress-bar {
      height: 8px;
      background: var(--bg-secondary);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 5px;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--primary-color);
      transition: width 0.3s ease;
    }
    
    .log-entry {
      padding: 5px 0;
      border-bottom: 1px solid var(--border-color);
    }
    
    .log-entry:last-child {
      border-bottom: none;
    }
    
    .log-time {
      color: var(--text-secondary);
      font-size: 0.85rem;
    }
    
    .log-message {
      margin-left: 10px;
    }
    
    .test-input {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background: var(--bg-primary);
      color: var(--text-primary);
      margin-bottom: 10px;
    }
    
    .config-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .config-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .config-item label {
      font-weight: 500;
    }
    
    .config-item input[type="checkbox"] {
      width: 20px;
      height: 20px;
    }
    
    .config-item input[type="number"] {
      width: 80px;
      padding: 4px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background: var(--bg-primary);
      color: var(--text-primary);
    }
  </style>
</head>
<body>
  <h1>模型預載入功能測試</h1>
  
  <!-- 基本功能測試 -->
  <div class="test-section">
    <h2>基本功能測試</h2>
    <div class="test-controls">
      <button class="test-button" onclick="testInitialize()">初始化管理器</button>
      <button class="test-button" onclick="testPreloadTiny()">預載入 Tiny 模型</button>
      <button class="test-button" onclick="testPreloadBase()">預載入 Base 模型</button>
      <button class="test-button" onclick="testPreloadSmall()">預載入 Small 模型</button>
      <button class="test-button secondary" onclick="testCancelPreload()">取消當前預載入</button>
      <button class="test-button secondary" onclick="testClearCache()">清除所有快取</button>
    </div>
    <div class="test-output" id="basicOutput"></div>
  </div>
  
  <!-- 狀態監控 -->
  <div class="test-section">
    <h2>狀態監控</h2>
    <div class="status-grid">
      <div class="status-card">
        <h3>預載入狀態</h3>
        <div class="status-value" id="preloadingStatus">未啟動</div>
      </div>
      <div class="status-card">
        <h3>佇列長度</h3>
        <div class="status-value" id="queueLength">0</div>
      </div>
      <div class="status-card">
        <h3>已載入模型</h3>
        <div class="status-value" id="loadedCount">0</div>
      </div>
      <div class="status-card">
        <h3>記憶體使用</h3>
        <div class="status-value" id="memoryUsage">- MB</div>
      </div>
    </div>
    
    <h3>模型狀態</h3>
    <div id="modelStatus">
      <div class="model-card" data-model="tiny">
        <div class="model-header">
          <span class="model-name">Tiny (39MB)</span>
          <span class="model-status">未載入</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: 0%"></div>
        </div>
        <div class="model-info">進度: 0%</div>
      </div>
      
      <div class="model-card" data-model="base">
        <div class="model-header">
          <span class="model-name">Base (74MB)</span>
          <span class="model-status">未載入</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: 0%"></div>
        </div>
        <div class="model-info">進度: 0%</div>
      </div>
      
      <div class="model-card" data-model="small">
        <div class="model-header">
          <span class="model-name">Small (244MB)</span>
          <span class="model-status">未載入</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" style="width: 0%"></div>
        </div>
        <div class="model-info">進度: 0%</div>
      </div>
    </div>
  </div>
  
  <!-- 進階設定 -->
  <div class="test-section">
    <h2>進階設定</h2>
    <div class="config-grid">
      <div class="config-item">
        <label for="autoPreload">自動預載入</label>
        <input type="checkbox" id="autoPreload" checked>
      </div>
      <div class="config-item">
        <label for="preloadOnIdle">空閒時預載入</label>
        <input type="checkbox" id="preloadOnIdle" checked>
      </div>
      <div class="config-item">
        <label for="memoryThreshold">記憶體閾值</label>
        <input type="number" id="memoryThreshold" value="80" min="0" max="100" step="10">%
      </div>
    </div>
    <div class="test-controls">
      <button class="test-button" onclick="testUpdateConfig()">更新設定</button>
      <button class="test-button" onclick="testAutoPreload()">測試自動預載入</button>
      <button class="test-button secondary" onclick="testGetStatus()">獲取詳細狀態</button>
    </div>
    <div class="test-output" id="advancedOutput"></div>
  </div>
  
  <!-- 事件日誌 -->
  <div class="test-section">
    <h2>事件日誌</h2>
    <div class="test-controls">
      <button class="test-button secondary" onclick="clearEventLog()">清除日誌</button>
    </div>
    <div class="test-output" id="eventLog"></div>
  </div>
  
  <!-- 效能測試 -->
  <div class="test-section">
    <h2>效能測試</h2>
    <div class="test-controls">
      <button class="test-button" onclick="testConcurrentPreload()">並行預載入測試</button>
      <button class="test-button" onclick="testMemoryPressure()">記憶體壓力測試</button>
      <button class="test-button" onclick="testNetworkInterruption()">網路中斷測試</button>
    </div>
    <div class="test-output" id="performanceOutput"></div>
  </div>
  
  <script type="module">
    import { WhisperWASMManager } from '../js/wasm/whisper-wasm-manager.js';
    import { modelPreloader } from '../js/wasm/model-preloader.js';
    import { preloadIndicator } from '../js/preload-indicator.js';
    
    let wasmManager = null;
    let statusInterval = null;
    
    // 基本輸出函數
    function output(elementId, message) {
      const element = document.getElementById(elementId);
      const timestamp = new Date().toLocaleTimeString('zh-TW');
      element.innerHTML += `<div class="log-entry"><span class="log-time">${timestamp}</span><span class="log-message">${message}</span></div>`;
      element.scrollTop = element.scrollHeight;
    }
    
    // 更新狀態顯示
    function updateStatus() {
      if (!wasmManager) return;
      
      const status = wasmManager.getPreloadStatus();
      
      document.getElementById('preloadingStatus').textContent = status.isPreloading ? '載入中' : '閒置';
      document.getElementById('queueLength').textContent = status.queueLength;
      document.getElementById('loadedCount').textContent = status.loadedModels.length;
      
      // 更新記憶體使用
      if (performance.memory) {
        const used = performance.memory.usedJSHeapSize / 1024 / 1024;
        document.getElementById('memoryUsage').textContent = `${used.toFixed(1)} MB`;
      }
      
      // 更新模型狀態
      ['tiny', 'base', 'small'].forEach(model => {
        const card = document.querySelector(`[data-model="${model}"]`);
        const statusEl = card.querySelector('.model-status');
        const progressBar = card.querySelector('.progress-fill');
        const infoEl = card.querySelector('.model-info');
        
        const progress = status.progress[model] || 0;
        const isLoaded = status.loadedModels.includes(model);
        const isLoading = status.currentPreload?.modelName === model;
        
        if (isLoaded) {
          statusEl.textContent = '已載入';
          statusEl.className = 'model-status loaded';
          progressBar.style.width = '100%';
          infoEl.textContent = '完成';
        } else if (isLoading) {
          statusEl.textContent = '載入中';
          statusEl.className = 'model-status loading';
          progressBar.style.width = `${progress}%`;
          infoEl.textContent = `進度: ${Math.round(progress)}%`;
        } else {
          statusEl.textContent = '未載入';
          statusEl.className = 'model-status';
          progressBar.style.width = '0%';
          infoEl.textContent = '進度: 0%';
        }
      });
    }
    
    // 初始化管理器
    window.testInitialize = async function() {
      try {
        output('basicOutput', '正在初始化 WASM 管理器...');
        
        wasmManager = new WhisperWASMManager();
        
        // 訂閱事件
        wasmManager.subscribeToPreload((event) => {
          const { event: eventType, data } = event;
          output('eventLog', `事件: ${eventType} - ${JSON.stringify(data)}`);
          
          // 更新預載入指示器
          switch (eventType) {
            case 'progress':
              preloadIndicator.updatePreloadItem(
                data.modelName,
                'loading',
                data.progress,
                wasmManager.getModelInfo(data.modelName)?.size
              );
              break;
            case 'completed':
              preloadIndicator.updatePreloadItem(data.modelName, 'complete', 100);
              break;
            case 'error':
              preloadIndicator.updatePreloadItem(data.modelName, 'error');
              break;
          }
        });
        
        // 設定預載入指示器事件
        preloadIndicator.setEventHandlers({
          onClearCache: async () => {
            await wasmManager.clearCache();
            preloadIndicator.clear();
            output('basicOutput', '快取已清除');
          },
          onCancelPreload: (modelName) => {
            wasmManager.cancelPreload(modelName);
            output('basicOutput', `已取消預載入: ${modelName}`);
          }
        });
        
        // 啟動狀態更新
        if (statusInterval) clearInterval(statusInterval);
        statusInterval = setInterval(updateStatus, 500);
        
        output('basicOutput', '✅ WASM 管理器初始化成功');
        updateStatus();
        
      } catch (error) {
        output('basicOutput', `❌ 初始化失敗: ${error.message}`);
      }
    };
    
    // 預載入模型測試
    window.testPreloadTiny = async function() {
      if (!wasmManager) {
        output('basicOutput', '請先初始化管理器');
        return;
      }
      
      try {
        output('basicOutput', '開始預載入 Tiny 模型...');
        
        await wasmManager.preloadModel('tiny', {
          priority: 'high',
          onProgress: (progress) => {
            output('basicOutput', `Tiny 進度: ${Math.round(progress.percent)}%`);
          },
          onComplete: () => {
            output('basicOutput', '✅ Tiny 模型預載入完成');
          },
          onError: (error) => {
            output('basicOutput', `❌ Tiny 預載入失敗: ${error.message}`);
          }
        });
        
      } catch (error) {
        output('basicOutput', `❌ 預載入失敗: ${error.message}`);
      }
    };
    
    window.testPreloadBase = async function() {
      if (!wasmManager) {
        output('basicOutput', '請先初始化管理器');
        return;
      }
      
      try {
        output('basicOutput', '開始預載入 Base 模型...');
        await wasmManager.preloadModel('base');
        output('basicOutput', '✅ Base 模型預載入完成');
      } catch (error) {
        output('basicOutput', `❌ 預載入失敗: ${error.message}`);
      }
    };
    
    window.testPreloadSmall = async function() {
      if (!wasmManager) {
        output('basicOutput', '請先初始化管理器');
        return;
      }
      
      try {
        output('basicOutput', '開始預載入 Small 模型...');
        await wasmManager.preloadModel('small');
        output('basicOutput', '✅ Small 模型預載入完成');
      } catch (error) {
        output('basicOutput', `❌ 預載入失敗: ${error.message}`);
      }
    };
    
    // 取消預載入
    window.testCancelPreload = function() {
      if (!wasmManager) {
        output('basicOutput', '請先初始化管理器');
        return;
      }
      
      const status = wasmManager.getPreloadStatus();
      if (status.currentPreload) {
        wasmManager.cancelPreload(status.currentPreload.modelName);
        output('basicOutput', `已取消預載入: ${status.currentPreload.modelName}`);
      } else {
        output('basicOutput', '沒有正在進行的預載入');
      }
    };
    
    // 清除快取
    window.testClearCache = async function() {
      if (!wasmManager) {
        output('basicOutput', '請先初始化管理器');
        return;
      }
      
      try {
        await modelPreloader.clearCache();
        output('basicOutput', '✅ 所有模型快取已清除');
        updateStatus();
      } catch (error) {
        output('basicOutput', `❌ 清除快取失敗: ${error.message}`);
      }
    };
    
    // 更新設定
    window.testUpdateConfig = function() {
      if (!wasmManager) {
        output('advancedOutput', '請先初始化管理器');
        return;
      }
      
      const config = {
        autoPreload: document.getElementById('autoPreload').checked,
        preloadOnIdle: document.getElementById('preloadOnIdle').checked,
        memoryThreshold: document.getElementById('memoryThreshold').value / 100
      };
      
      wasmManager.setPreloadConfig(config);
      output('advancedOutput', `設定已更新: ${JSON.stringify(config, null, 2)}`);
    };
    
    // 測試自動預載入
    window.testAutoPreload = function() {
      if (!wasmManager) {
        output('advancedOutput', '請先初始化管理器');
        return;
      }
      
      output('advancedOutput', '啟動自動預載入...');
      wasmManager.startAutoPreload();
    };
    
    // 獲取詳細狀態
    window.testGetStatus = function() {
      if (!wasmManager) {
        output('advancedOutput', '請先初始化管理器');
        return;
      }
      
      const status = wasmManager.getPreloadStatus();
      output('advancedOutput', `詳細狀態:\n${JSON.stringify(status, null, 2)}`);
    };
    
    // 清除事件日誌
    window.clearEventLog = function() {
      document.getElementById('eventLog').innerHTML = '';
    };
    
    // 並行預載入測試
    window.testConcurrentPreload = async function() {
      if (!wasmManager) {
        output('performanceOutput', '請先初始化管理器');
        return;
      }
      
      output('performanceOutput', '開始並行預載入測試...');
      const startTime = Date.now();
      
      try {
        // 同時預載入多個模型
        const promises = [
          wasmManager.preloadModel('tiny', { priority: 'high' }),
          wasmManager.preloadModel('base', { priority: 'normal' }),
          wasmManager.preloadModel('small', { priority: 'low' })
        ];
        
        await Promise.all(promises);
        
        const duration = Date.now() - startTime;
        output('performanceOutput', `✅ 並行預載入完成，耗時: ${duration}ms`);
        
      } catch (error) {
        output('performanceOutput', `❌ 並行預載入失敗: ${error.message}`);
      }
    };
    
    // 記憶體壓力測試
    window.testMemoryPressure = async function() {
      output('performanceOutput', '開始記憶體壓力測試...');
      
      // 創建大量資料佔用記憶體
      const arrays = [];
      try {
        for (let i = 0; i < 10; i++) {
          arrays.push(new ArrayBuffer(50 * 1024 * 1024)); // 50MB
          output('performanceOutput', `已分配 ${(i + 1) * 50}MB 記憶體`);
        }
        
        // 嘗試預載入
        if (wasmManager) {
          await wasmManager.preloadModel('tiny');
          output('performanceOutput', '✅ 在高記憶體壓力下仍能預載入');
        }
        
      } catch (error) {
        output('performanceOutput', `⚠️ 記憶體壓力測試: ${error.message}`);
      } finally {
        // 清理
        arrays.length = 0;
        if (global.gc) global.gc(); // 如果可用，觸發垃圾回收
      }
    };
    
    // 網路中斷測試
    window.testNetworkInterruption = async function() {
      output('performanceOutput', '網路中斷測試（模擬）...');
      
      // 模擬網路中斷
      output('performanceOutput', '模擬網路斷線...');
      window.dispatchEvent(new Event('offline'));
      
      setTimeout(() => {
        output('performanceOutput', '模擬網路恢復...');
        window.dispatchEvent(new Event('online'));
      }, 3000);
    };
    
    // 頁面載入時自動初始化
    document.addEventListener('DOMContentLoaded', () => {
      // 可以選擇自動初始化
      // testInitialize();
    });
  </script>
</body>
</html>