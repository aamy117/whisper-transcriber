<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>優化版 WASM 轉譯測試</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/progress.css">
  <style>
    body {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .test-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .config-section, .stats-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 20px;
    }
    
    .test-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .test-button {
      padding: 10px 20px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    
    .test-button:hover {
      opacity: 0.8;
    }
    
    .test-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .config-option {
      margin: 10px 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .config-option label {
      flex: 1;
    }
    
    .config-option input[type="checkbox"] {
      margin-left: 10px;
    }
    
    .config-option input[type="number"] {
      width: 80px;
      margin-left: 10px;
      padding: 5px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
    }
    
    .result-area {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 15px;
      margin-top: 20px;
      min-height: 200px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 15px;
    }
    
    .stat-item {
      background: var(--bg-tertiary);
      padding: 10px;
      border-radius: 4px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--primary-color);
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-top: 5px;
    }
    
    .performance-chart {
      width: 100%;
      height: 200px;
      margin-top: 20px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      position: relative;
    }
    
    @media (max-width: 768px) {
      .test-container {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <h1>優化版 WASM 轉譯測試</h1>
  
  <div class="test-container">
    <!-- 配置區 -->
    <div class="config-section">
      <h2>優化配置</h2>
      
      <div class="config-option">
        <label for="useOptimized">啟用優化版引擎</label>
        <input type="checkbox" id="useOptimized" checked>
      </div>
      
      <div class="config-option">
        <label for="workerPoolSize">Worker 池大小</label>
        <input type="number" id="workerPoolSize" min="1" max="16" value="0">
      </div>
      
      <div class="config-option">
        <label for="enableSIMD">啟用 SIMD 加速</label>
        <input type="checkbox" id="enableSIMD" checked>
      </div>
      
      <div class="config-option">
        <label for="enableStreaming">啟用串流結果</label>
        <input type="checkbox" id="enableStreaming" checked>
      </div>
      
      <div class="config-option">
        <label for="chunkDuration">分段大小（秒）</label>
        <input type="number" id="chunkDuration" min="10" max="60" value="30">
      </div>
      
      <div class="config-option">
        <label for="useQuantized">使用量化模型</label>
        <input type="checkbox" id="useQuantized" checked>
      </div>
      
      <button class="test-button" onclick="saveConfig()">儲存配置</button>
      <button class="test-button" onclick="resetConfig()">重置預設</button>
    </div>
    
    <!-- 統計區 -->
    <div class="stats-section">
      <h2>效能統計</h2>
      
      <div class="stats-grid">
        <div class="stat-item">
          <div class="stat-value" id="speedMultiplier">-</div>
          <div class="stat-label">速度倍數</div>
        </div>
        
        <div class="stat-item">
          <div class="stat-value" id="processingTime">-</div>
          <div class="stat-label">處理時間</div>
        </div>
        
        <div class="stat-item">
          <div class="stat-value" id="workerCount">-</div>
          <div class="stat-label">Worker 數量</div>
        </div>
        
        <div class="stat-item">
          <div class="stat-value" id="memoryUsage">-</div>
          <div class="stat-label">記憶體使用</div>
        </div>
      </div>
      
      <div class="performance-chart" id="performanceChart">
        <!-- 效能圖表 -->
      </div>
    </div>
  </div>
  
  <!-- 測試區 -->
  <div class="test-section">
    <h2>轉譯測試</h2>
    
    <input type="file" id="fileInput" accept="audio/*,video/*">
    
    <div style="margin: 15px 0;">
      <label>選擇模型：</label>
      <select id="modelSelect">
        <option value="tiny">Tiny (最快)</option>
        <option value="base" selected>Base (平衡)</option>
        <option value="small">Small (最準)</option>
      </select>
    </div>
    
    <button class="test-button" id="testOptimized" onclick="testOptimized()">測試優化版</button>
    <button class="test-button" id="testStandard" onclick="testStandard()">測試標準版</button>
    <button class="test-button" id="compareBoth" onclick="compareBoth()">效能對比</button>
    <button class="test-button" onclick="clearResults()">清除結果</button>
    
    <div class="result-area" id="results"></div>
  </div>
  
  <script type="module">
    import WASMConfig from '../js/wasm/wasm-config.js';
    import { WhisperWASMManager } from '../js/wasm/whisper-wasm-manager.js';
    import { notify } from '../js/notification.js';
    
    // 全域變數
    window.wasmManager = null;
    window.testStartTime = 0;
    window.testResults = [];
    
    // 初始化
    document.addEventListener('DOMContentLoaded', () => {
      loadConfig();
      updateStats();
      logResult('測試頁面載入完成', 'success');
      
      // 檢查環境支援
      checkEnvironmentSupport();
    });
    
    // 載入配置
    function loadConfig() {
      document.getElementById('useOptimized').checked = WASMConfig.useOptimized;
      document.getElementById('workerPoolSize').value = WASMConfig.optimization.workerPoolSize;
      document.getElementById('enableSIMD').checked = WASMConfig.optimization.enableSIMD;
      document.getElementById('enableStreaming').checked = WASMConfig.optimization.enableStreaming;
      document.getElementById('chunkDuration').value = WASMConfig.performance.chunkDuration;
      document.getElementById('useQuantized').checked = WASMConfig.optimization.useQuantizedModels;
    }
    
    // 儲存配置
    window.saveConfig = function() {
      WASMConfig.useOptimized = document.getElementById('useOptimized').checked;
      WASMConfig.optimization.workerPoolSize = parseInt(document.getElementById('workerPoolSize').value);
      WASMConfig.optimization.enableSIMD = document.getElementById('enableSIMD').checked;
      WASMConfig.optimization.enableStreaming = document.getElementById('enableStreaming').checked;
      WASMConfig.performance.chunkDuration = parseInt(document.getElementById('chunkDuration').value);
      WASMConfig.optimization.useQuantizedModels = document.getElementById('useQuantized').checked;
      
      WASMConfig.saveUserPreferences();
      logResult('配置已儲存', 'success');
      
      // 重新初始化
      if (window.wasmManager) {
        window.wasmManager = null;
      }
    };
    
    // 重置配置
    window.resetConfig = function() {
      localStorage.removeItem('whisper-wasm-config');
      location.reload();
    };
    
    // 更新統計
    function updateStats() {
      const perfEstimate = WASMConfig.getPerformanceEstimate(25);
      document.getElementById('speedMultiplier').textContent = perfEstimate.speedMultiplier;
      document.getElementById('workerCount').textContent = WASMConfig.optimization.workerPoolSize || 'Auto';
      
      // 記憶體使用
      if (performance.memory) {
        const memoryMB = (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(0);
        document.getElementById('memoryUsage').textContent = memoryMB + ' MB';
      } else {
        document.getElementById('memoryUsage').textContent = 'N/A';
      }
    }
    
    // 測試優化版
    window.testOptimized = async function() {
      const file = document.getElementById('fileInput').files[0];
      if (!file) {
        logResult('請選擇音訊檔案', 'error');
        return;
      }
      
      try {
        WASMConfig.useOptimized = true;
        await runTest(file, '優化版');
      } catch (error) {
        logResult(`優化版測試失敗: ${error.message}`, 'error');
      }
    };
    
    // 測試標準版
    window.testStandard = async function() {
      const file = document.getElementById('fileInput').files[0];
      if (!file) {
        logResult('請選擇音訊檔案', 'error');
        return;
      }
      
      try {
        WASMConfig.useOptimized = false;
        await runTest(file, '標準版');
      } catch (error) {
        logResult(`標準版測試失敗: ${error.message}`, 'error');
      }
    };
    
    // 效能對比
    window.compareBoth = async function() {
      const file = document.getElementById('fileInput').files[0];
      if (!file) {
        logResult('請選擇音訊檔案', 'error');
        return;
      }
      
      logResult('開始效能對比測試...', 'info');
      
      // 測試標準版
      WASMConfig.useOptimized = false;
      const standardTime = await runTest(file, '標準版');
      
      // 測試優化版
      WASMConfig.useOptimized = true;
      const optimizedTime = await runTest(file, '優化版');
      
      // 顯示對比結果
      if (standardTime && optimizedTime) {
        const speedup = (standardTime / optimizedTime).toFixed(2);
        logResult(`效能提升: ${speedup}x 倍`, 'success');
        logResult(`標準版: ${(standardTime / 1000).toFixed(2)}秒`, 'info');
        logResult(`優化版: ${(optimizedTime / 1000).toFixed(2)}秒`, 'info');
      }
    };
    
    // 執行測試
    async function runTest(file, version) {
      logResult(`開始 ${version} 測試...`, 'info');
      logResult(`檔案: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`, 'info');
      
      // 禁用按鈕
      document.querySelectorAll('.test-button').forEach(btn => btn.disabled = true);
      
      try {
        // 初始化
        if (!window.wasmManager || window.wasmManager.useOptimized !== WASMConfig.useOptimized) {
          window.wasmManager = new WhisperWASMManager();
          const model = document.getElementById('modelSelect').value;
          logResult(`初始化 ${model} 模型...`, 'info');
          await window.wasmManager.initialize(model);
        }
        
        // 開始計時
        const startTime = performance.now();
        window.testStartTime = startTime;
        
        // 執行轉譯
        const result = await window.wasmManager.transcribe(file, {
          onProgress: (progress) => {
            logResult(`進度: ${progress.toFixed(0)}%`, 'progress');
          },
          onPartialResult: (partial) => {
            logResult(`部分結果: ${partial.text.substring(0, 50)}...`, 'partial');
          }
        });
        
        // 計算時間
        const endTime = performance.now();
        const totalTime = endTime - startTime;
        
        // 顯示結果
        logResult(`${version} 完成！處理時間: ${(totalTime / 1000).toFixed(2)}秒`, 'success');
        logResult(`轉譯結果: ${result.segments.length} 個段落`, 'info');
        
        // 更新統計
        document.getElementById('processingTime').textContent = `${(totalTime / 1000).toFixed(1)}s`;
        updateStats();
        
        return totalTime;
        
      } finally {
        // 重新啟用按鈕
        document.querySelectorAll('.test-button').forEach(btn => btn.disabled = false);
      }
    }
    
    // 記錄結果
    function logResult(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString('zh-TW');
      const resultDiv = document.getElementById('results');
      
      const entry = document.createElement('div');
      entry.style.marginBottom = '5px';
      entry.style.color = {
        'success': 'var(--success-color)',
        'error': 'var(--danger-color)',
        'info': 'var(--text-primary)',
        'progress': 'var(--info-color)',
        'partial': 'var(--text-secondary)'
      }[type] || 'var(--text-primary)';
      
      entry.textContent = `[${timestamp}] ${message}`;
      resultDiv.appendChild(entry);
      resultDiv.scrollTop = resultDiv.scrollHeight;
      
      console.log(`[${type}]`, message);
    }
    
    // 清除結果
    window.clearResults = function() {
      document.getElementById('results').innerHTML = '';
      document.getElementById('processingTime').textContent = '-';
      window.testResults = [];
    };
    
    // 檢查環境支援
    function checkEnvironmentSupport() {
      logResult('=== 環境檢查 ===', 'info');
      
      // 檢查 WebAssembly
      if (typeof WebAssembly === 'undefined') {
        logResult('❌ WebAssembly 不支援', 'error');
        return;
      }
      logResult('✅ WebAssembly 支援', 'success');
      
      // 檢查 SharedArrayBuffer
      if (typeof SharedArrayBuffer === 'undefined') {
        logResult('⚠️ SharedArrayBuffer 不可用，將使用單執行緒模式', 'error');
        logResult('  需要 HTTPS 並設定正確的 COOP/COEP headers', 'info');
      } else {
        logResult('✅ SharedArrayBuffer 可用', 'success');
      }
      
      // 檢查 SIMD
      try {
        if (WebAssembly.validate(new Uint8Array([0,97,115,109,1,0,0,0,1,5,1,96,0,1,123,3,2,1,0,10,10,1,8,0,65,0,253,17,253,98,11]))) {
          logResult('✅ SIMD 支援', 'success');
        } else {
          logResult('⚠️ SIMD 不支援，效能可能較低', 'error');
        }
      } catch (e) {
        logResult('⚠️ SIMD 檢查失敗', 'error');
      }
      
      // 檢查 CPU 核心數
      const cores = navigator.hardwareConcurrency || 'unknown';
      logResult(`ℹ️ CPU 核心數: ${cores}`, 'info');
      
      // 檢查記憶體
      if (navigator.deviceMemory) {
        logResult(`ℹ️ 設備記憶體: ${navigator.deviceMemory} GB`, 'info');
      }
      
      // 檢查是否已降級
      if (!WASMConfig.useOptimized) {
        logResult('⚠️ 優化版已停用，將使用標準版', 'error');
        document.getElementById('useOptimized').checked = false;
        document.getElementById('useOptimized').disabled = true;
      }
      
      logResult('=== 檢查完成 ===', 'info');
    }
  </script>
</body>
</html>