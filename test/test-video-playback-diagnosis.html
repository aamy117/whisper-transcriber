<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>視訊播放診斷工具</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }

        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }

        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .test-area {
            border: 2px dashed #3498db;
            padding: 30px;
            text-align: center;
            margin: 20px 0;
            border-radius: 8px;
            background: #ecf0f1;
        }

        video {
            max-width: 100%;
            height: auto;
            background: #000;
            margin: 20px 0;
            border-radius: 4px;
        }

        .info-box {
            background: #e8f4f8;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #3498db;
            border-radius: 4px;
        }

        .error-box {
            background: #fee;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #e74c3c;
            border-radius: 4px;
        }

        .success-box {
            background: #efe;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #27ae60;
            border-radius: 4px;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
        }

        button:hover {
            background: #2980b9;
        }

        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        .log {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            font-family: 'Consolas', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            border-radius: 4px;
            margin: 10px 0;
        }

        .log-entry {
            margin: 3px 0;
            padding: 2px 0;
        }

        .log-error { color: #e74c3c; }
        .log-warn { color: #f39c12; }
        .log-success { color: #27ae60; }
        .log-info { color: #3498db; }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }

        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background: #3498db;
            color: white;
        }

        tr:hover {
            background: #f5f5f5;
        }
    </style>
</head>
<body>
    <h1>視訊播放診斷工具</h1>

    <div class="section">
        <h2>1. 瀏覽器支援檢測</h2>
        <div id="browserSupport"></div>
    </div>

    <div class="section">
        <h2>2. 上傳測試視訊</h2>
        <div class="test-area">
            <input type="file" id="videoInput" accept="video/*" style="display: none;">
            <button onclick="document.getElementById('videoInput').click()">選擇視訊檔案</button>
            <p>或拖放檔案到此處</p>
        </div>
        <div id="fileInfo"></div>
    </div>

    <div class="section">
        <h2>3. 視訊播放測試</h2>
        <video id="videoPlayer" controls></video>
        <div>
            <button id="playBtn" disabled>播放</button>
            <button id="pauseBtn" disabled>暫停</button>
            <button id="resetBtn" disabled>重新載入</button>
        </div>
        <div id="playbackInfo"></div>
    </div>

    <div class="section">
        <h2>4. 診斷日誌</h2>
        <button onclick="clearLog()">清除日誌</button>
        <button onclick="copyLog()">複製日誌</button>
        <div id="log" class="log"></div>
    </div>

    <script>
        let currentFile = null;
        const video = document.getElementById('videoPlayer');
        const videoInput = document.getElementById('videoInput');
        const playBtn = document.getElementById('playBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resetBtn = document.getElementById('resetBtn');

        // 安全的 DOM 建立輔助函數
        function createElement(tag, className, text) {
            const el = document.createElement(tag);
            if (className) el.className = className;
            if (text) el.textContent = text;
            return el;
        }

        function createTable(headers, rows) {
            const table = document.createElement('table');

            // 建立表頭
            if (headers && headers.length > 0) {
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                headers.forEach(header => {
                    const th = document.createElement('th');
                    th.textContent = header;
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                table.appendChild(thead);
            }

            // 建立表格內容
            const tbody = document.createElement('tbody');
            rows.forEach(rowData => {
                const row = document.createElement('tr');
                rowData.forEach(cellData => {
                    const cell = document.createElement('td');
                    if (typeof cellData === 'object' && cellData.text !== undefined) {
                        cell.textContent = cellData.text;
                        if (cellData.style) {
                            Object.assign(cell.style, cellData.style);
                        }
                    } else {
                        cell.textContent = cellData;
                    }
                    row.appendChild(cell);
                });
                tbody.appendChild(row);
            });
            table.appendChild(tbody);

            return table;
        }

        // 日誌系統
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const entry = createElement('div', `log-entry log-${type}`, `[${timestamp}] ${message}`);
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        function copyLog() {
            const logText = document.getElementById('log').innerText;
            navigator.clipboard.writeText(logText).then(() => {
                alert('日誌已複製到剪貼簿');
            });
        }

        // 1. 檢測瀏覽器支援
        function checkBrowserSupport() {
            const video = document.createElement('video');
            const formats = {
                'MP4 (H.264)': 'video/mp4; codecs="avc1.42E01E"',
                'MP4 (H.265/HEVC)': 'video/mp4; codecs="hvc1"',
                'MP4 (MPEG-4)': 'video/mp4; codecs="mp4v.20.8"',
                'WebM (VP8)': 'video/webm; codecs="vp8"',
                'WebM (VP9)': 'video/webm; codecs="vp9"',
                'Ogg (Theora)': 'video/ogg; codecs="theora"',
                'QuickTime': 'video/quicktime'
            };

            const rows = [];
            for (const [name, type] of Object.entries(formats)) {
                const support = video.canPlayType(type);
                let supportText = '';
                let color = '';

                if (support === 'probably') {
                    supportText = '完全支援';
                    color = '#27ae60';
                } else if (support === 'maybe') {
                    supportText = '可能支援';
                    color = '#f39c12';
                } else {
                    supportText = '不支援';
                    color = '#e74c3c';
                }

                rows.push([
                    name,
                    { text: supportText, style: { color: color, fontWeight: 'bold' } }
                ]);

                log(`${name}: ${supportText}`, support === 'probably' ? 'success' : (support === 'maybe' ? 'warn' : 'error'));
            }

            const container = document.getElementById('browserSupport');
            container.textContent = '';
            container.appendChild(createTable(['格式', '支援程度'], rows));

            // MSE 支援
            const mseSupported = 'MediaSource' in window;
            const mseBox = createElement('div', mseSupported ? 'success-box' : 'error-box',
                `Media Source Extensions (MSE): ${mseSupported ? '支援' : '不支援'}`);
            container.appendChild(mseBox);

            log(`MSE 支援: ${mseSupported}`, mseSupported ? 'success' : 'error');
        }

        // 2. 檔案資訊分析
        function analyzeFile(file) {
            currentFile = file;
            log(`=== 開始分析檔案: ${file.name} ===`);

            const extension = file.name.split('.').pop().toLowerCase();

            const info = {
                '檔案名稱': file.name,
                '檔案大小': formatBytes(file.size),
                '檔案類型（MIME）': file.type || '未知',
                '副檔名': extension,
                '最後修改': new Date(file.lastModified).toLocaleString()
            };

            const container = document.getElementById('fileInfo');
            container.textContent = '';

            // 基本資訊
            const infoBox = createElement('div', 'info-box');
            const rows = Object.entries(info).map(([key, value]) => {
                log(`${key}: ${value}`, 'info');
                return [{ text: key, style: { fontWeight: 'bold' } }, value];
            });
            infoBox.appendChild(createTable(null, rows));
            container.appendChild(infoBox);

            // 格式檢測
            const video = document.createElement('video');
            const possibleTypes = [
                file.type,
                `video/${extension}`,
                'video/mp4',
                'video/quicktime'
            ].filter(t => t);

            const formatBox = createElement('div', 'info-box');
            const formatTitle = createElement('h3', null, '格式檢測');
            formatBox.appendChild(formatTitle);

            const formatRows = possibleTypes.map(type => {
                const support = video.canPlayType(type);
                const supportText = support === 'probably' ? '完全支援' :
                                  support === 'maybe' ? '可能支援' : '不支援';
                const color = support === 'probably' ? '#27ae60' :
                             support === 'maybe' ? '#f39c12' : '#e74c3c';

                log(`格式 ${type}: ${supportText}`, support ? 'success' : 'error');

                return [
                    type,
                    { text: supportText, style: { color: color, fontWeight: 'bold' } }
                ];
            });

            formatBox.appendChild(createTable(['可能的格式', '瀏覽器支援'], formatRows));
            container.appendChild(formatBox);

            // 啟用按鈕
            playBtn.disabled = false;
            pauseBtn.disabled = false;
            resetBtn.disabled = false;

            // 自動載入視訊
            loadVideo(file);
        }

        // 3. 載入視訊
        function loadVideo(file) {
            log('開始載入視訊...', 'info');

            // 清理舊的 URL
            if (video.src && video.src.startsWith('blob:')) {
                URL.revokeObjectURL(video.src);
            }

            try {
                const url = URL.createObjectURL(file);
                video.src = url;
                log(`建立 Blob URL: ${url}`, 'success');

                // 嘗試載入
                video.load();
                log('呼叫 video.load()', 'info');

            } catch (error) {
                log(`載入失敗: ${error.message}`, 'error');
                showError(`載入失敗: ${error.message}`);
            }
        }

        // 視訊事件監聽
        video.addEventListener('loadstart', () => {
            log('事件: loadstart - 開始載入', 'info');
        });

        video.addEventListener('loadedmetadata', () => {
            log('事件: loadedmetadata - 元數據載入完成', 'success');
            log(`視訊尺寸: ${video.videoWidth}x${video.videoHeight}`, 'info');
            log(`視訊時長: ${video.duration.toFixed(2)} 秒`, 'info');

            updatePlaybackInfo();

            // 檢查尺寸
            if (video.videoWidth === 0 || video.videoHeight === 0) {
                log('警告: 視訊尺寸為 0，可能只有音訊或編碼問題', 'warn');
            }
        });

        video.addEventListener('loadeddata', () => {
            log('事件: loadeddata - 第一幀數據載入', 'success');
            log(`ReadyState: ${video.readyState}`, 'info');
        });

        video.addEventListener('canplay', () => {
            log('事件: canplay - 可以開始播放', 'success');
        });

        video.addEventListener('canplaythrough', () => {
            log('事件: canplaythrough - 可以流暢播放', 'success');
        });

        video.addEventListener('play', () => {
            log('事件: play - 開始播放', 'success');
        });

        video.addEventListener('pause', () => {
            log('事件: pause - 暫停播放', 'info');
        });

        video.addEventListener('error', (e) => {
            const error = video.error;
            let message = '未知錯誤';

            if (error) {
                switch (error.code) {
                    case error.MEDIA_ERR_ABORTED:
                        message = 'MEDIA_ERR_ABORTED - 播放被中止';
                        break;
                    case error.MEDIA_ERR_NETWORK:
                        message = 'MEDIA_ERR_NETWORK - 網路錯誤';
                        break;
                    case error.MEDIA_ERR_DECODE:
                        message = 'MEDIA_ERR_DECODE - 解碼錯誤（編碼格式不支援）';
                        break;
                    case error.MEDIA_ERR_SRC_NOT_SUPPORTED:
                        message = 'MEDIA_ERR_SRC_NOT_SUPPORTED - 不支援的視訊格式';
                        break;
                }

                if (error.message) {
                    message += ` - ${error.message}`;
                }
            }

            log(`錯誤: ${message}`, 'error');
            showError(message);
        });

        video.addEventListener('stalled', () => {
            log('事件: stalled - 載入停滯', 'warn');
        });

        video.addEventListener('waiting', () => {
            log('事件: waiting - 等待數據', 'info');
        });

        video.addEventListener('timeupdate', () => {
            updatePlaybackInfo();
        });

        // 按鈕事件
        playBtn.onclick = () => {
            video.play().catch(e => {
                log(`播放失敗: ${e.message}`, 'error');
            });
        };

        pauseBtn.onclick = () => {
            video.pause();
        };

        resetBtn.onclick = () => {
            if (currentFile) {
                log('=== 重新載入視訊 ===', 'info');
                loadVideo(currentFile);
            }
        };

        // 檔案選擇
        videoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                analyzeFile(file);
            }
        });

        // 拖放支援
        const dropArea = document.querySelector('.test-area');

        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.style.background = '#d5e8ef';
        });

        dropArea.addEventListener('dragleave', () => {
            dropArea.style.background = '#ecf0f1';
        });

        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.style.background = '#ecf0f1';

            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('video/')) {
                analyzeFile(file);
            } else {
                alert('請選擇視訊檔案');
            }
        });

        // 工具函數
        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function updatePlaybackInfo() {
            if (!video.duration) return;

            const info = {
                '當前時間': `${video.currentTime.toFixed(2)} 秒`,
                '總時長': `${video.duration.toFixed(2)} 秒`,
                'ReadyState': video.readyState,
                'NetworkState': video.networkState,
                '是否暫停': video.paused ? '是' : '否',
                '是否結束': video.ended ? '是' : '否',
                '播放速率': video.playbackRate,
                '音量': video.volume
            };

            const container = document.getElementById('playbackInfo');
            container.textContent = '';

            const infoBox = createElement('div', 'info-box');
            const title = createElement('h3', null, '播放狀態');
            infoBox.appendChild(title);

            const rows = Object.entries(info).map(([key, value]) => [
                { text: key, style: { fontWeight: 'bold' } },
                value
            ]);

            infoBox.appendChild(createTable(null, rows));
            container.appendChild(infoBox);
        }

        function showError(message) {
            const errorDiv = createElement('div', 'error-box');
            const strong = createElement('strong', null, '錯誤：');
            errorDiv.appendChild(strong);
            errorDiv.appendChild(document.createTextNode(' ' + message));

            const container = document.getElementById('playbackInfo');
            container.insertBefore(errorDiv, container.firstChild);
        }

        // 初始化
        checkBrowserSupport();
        log('診斷工具初始化完成', 'success');
    </script>
</body>
</html>
