<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASM 轉譯修復測試</title>
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        body {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .log {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 2px 0;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: #4caf50;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <h1>🔧 WASM 轉譯修復測試</h1>
    
    <div class="test-section">
        <h2>測試控制</h2>
        <button onclick="testInit()">測試初始化</button>
        <button onclick="testTranscribe()">測試轉譯（模擬檔案）</button>
        <input type="file" id="fileInput" accept="audio/*" onchange="testWithFile(this.files[0])">
        <button onclick="clearLog()">清除日誌</button>
    </div>

    <div class="test-section">
        <h2>進度</h2>
        <div class="progress-bar">
            <div class="progress-fill" id="progress" style="width: 0%"></div>
        </div>
        <div id="progressText">準備就緒</div>
    </div>

    <div class="test-section">
        <h2>測試日誌</h2>
        <div class="log" id="log"></div>
    </div>

    <script type="module">
        import { WhisperWASMManager } from '../js/wasm/whisper-wasm-manager.js';
        
        let wasmManager = null;
        
        window.log = function(msg, type = 'info') {
            const logEl = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        window.clearLog = function() {
            document.getElementById('log').innerHTML = '';
        }
        
        window.updateProgress = function(percent, text) {
            document.getElementById('progress').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }
        
        window.testInit = async function() {
            try {
                log('開始初始化測試...');
                
                wasmManager = new WhisperWASMManager();
                
                // 設定進度回調
                wasmManager.setProgressCallback((progress) => {
                    log(`進度: ${progress.type} - ${progress.message || progress.percentage + '%'}`);
                    if (progress.percentage !== undefined) {
                        updateProgress(progress.percentage, progress.message || '處理中...');
                    }
                });
                
                log('初始化 WASM 管理器...');
                await wasmManager.initialize('tiny');
                
                log('初始化成功！', 'success');
                log(`當前模型: ${wasmManager.currentModel}`);
                log(`已初始化: ${wasmManager.isInitialized}`);
                
            } catch (error) {
                log('初始化失敗: ' + error.message, 'error');
                console.error(error);
            }
        }
        
        window.testTranscribe = async function() {
            try {
                if (!wasmManager || !wasmManager.isInitialized) {
                    log('請先初始化 WASM', 'error');
                    return;
                }
                
                log('創建模擬音訊檔案...');
                // 創建一個小的模擬音訊檔案
                const audioData = new Float32Array(16000 * 5); // 5秒空音訊
                const blob = new Blob([audioData], { type: 'audio/wav' });
                const file = new File([blob], 'test.wav', { type: 'audio/wav' });
                
                log('開始轉譯...');
                const result = await wasmManager.transcribe(file, {
                    onProgress: (progress) => {
                        const percent = progress.percentage || 0;
                        const msg = progress.message || '轉譯中...';
                        updateProgress(percent, msg);
                        log(`轉譯進度: ${percent}% - ${msg}`);
                    }
                });
                
                log('轉譯完成！', 'success');
                log(`結果: ${JSON.stringify(result, null, 2)}`);
                
            } catch (error) {
                log('轉譯失敗: ' + error.message, 'error');
                console.error(error);
            }
        }
        
        window.testWithFile = async function(file) {
            if (!file) return;
            
            try {
                if (!wasmManager || !wasmManager.isInitialized) {
                    log('自動初始化 WASM...');
                    await testInit();
                }
                
                log(`測試檔案: ${file.name} (${(file.size/1024/1024).toFixed(2)}MB)`);
                
                const result = await wasmManager.transcribe(file, {
                    onProgress: (progress) => {
                        const percent = progress.percentage || 0;
                        const msg = progress.message || '轉譯中...';
                        updateProgress(percent, msg);
                    }
                });
                
                log('轉譯完成！', 'success');
                log(`文字長度: ${result.text ? result.text.length : 0}`);
                log(`段落數: ${result.segments ? result.segments.length : 0}`);
                
            } catch (error) {
                log('轉譯失敗: ' + error.message, 'error');
                console.error(error);
            }
        }
        
        // 頁面載入時的初始化
        log('WASM 修復測試頁面已載入');
        log('點擊"測試初始化"開始測試');
    </script>
</body>
</html>