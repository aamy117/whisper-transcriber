<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASM è½‰è­¯ä¿®å¾©æ¸¬è©¦</title>
    <link rel="stylesheet" href="../css/styles.css">
    <style>
        body {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .log {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 2px 0;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: #4caf50;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <h1>ğŸ”§ WASM è½‰è­¯ä¿®å¾©æ¸¬è©¦</h1>
    
    <div class="test-section">
        <h2>æ¸¬è©¦æ§åˆ¶</h2>
        <button onclick="testInit()">æ¸¬è©¦åˆå§‹åŒ–</button>
        <button onclick="testTranscribe()">æ¸¬è©¦è½‰è­¯ï¼ˆæ¨¡æ“¬æª”æ¡ˆï¼‰</button>
        <input type="file" id="fileInput" accept="audio/*" onchange="testWithFile(this.files[0])">
        <button onclick="clearLog()">æ¸…é™¤æ—¥èªŒ</button>
    </div>

    <div class="test-section">
        <h2>é€²åº¦</h2>
        <div class="progress-bar">
            <div class="progress-fill" id="progress" style="width: 0%"></div>
        </div>
        <div id="progressText">æº–å‚™å°±ç·’</div>
    </div>

    <div class="test-section">
        <h2>æ¸¬è©¦æ—¥èªŒ</h2>
        <div class="log" id="log"></div>
    </div>

    <script type="module">
        import { WhisperWASMManager } from '../js/wasm/whisper-wasm-manager.js';
        
        let wasmManager = null;
        
        window.log = function(msg, type = 'info') {
            const logEl = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        window.clearLog = function() {
            document.getElementById('log').innerHTML = '';
        }
        
        window.updateProgress = function(percent, text) {
            document.getElementById('progress').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }
        
        window.testInit = async function() {
            try {
                log('é–‹å§‹åˆå§‹åŒ–æ¸¬è©¦...');
                
                wasmManager = new WhisperWASMManager();
                
                // è¨­å®šé€²åº¦å›èª¿
                wasmManager.setProgressCallback((progress) => {
                    log(`é€²åº¦: ${progress.type} - ${progress.message || progress.percentage + '%'}`);
                    if (progress.percentage !== undefined) {
                        updateProgress(progress.percentage, progress.message || 'è™•ç†ä¸­...');
                    }
                });
                
                log('åˆå§‹åŒ– WASM ç®¡ç†å™¨...');
                await wasmManager.initialize('tiny');
                
                log('åˆå§‹åŒ–æˆåŠŸï¼', 'success');
                log(`ç•¶å‰æ¨¡å‹: ${wasmManager.currentModel}`);
                log(`å·²åˆå§‹åŒ–: ${wasmManager.isInitialized}`);
                
            } catch (error) {
                log('åˆå§‹åŒ–å¤±æ•—: ' + error.message, 'error');
                console.error(error);
            }
        }
        
        window.testTranscribe = async function() {
            try {
                if (!wasmManager || !wasmManager.isInitialized) {
                    log('è«‹å…ˆåˆå§‹åŒ– WASM', 'error');
                    return;
                }
                
                log('å‰µå»ºæ¨¡æ“¬éŸ³è¨Šæª”æ¡ˆ...');
                // å‰µå»ºä¸€å€‹å°çš„æ¨¡æ“¬éŸ³è¨Šæª”æ¡ˆ
                const audioData = new Float32Array(16000 * 5); // 5ç§’ç©ºéŸ³è¨Š
                const blob = new Blob([audioData], { type: 'audio/wav' });
                const file = new File([blob], 'test.wav', { type: 'audio/wav' });
                
                log('é–‹å§‹è½‰è­¯...');
                const result = await wasmManager.transcribe(file, {
                    onProgress: (progress) => {
                        const percent = progress.percentage || 0;
                        const msg = progress.message || 'è½‰è­¯ä¸­...';
                        updateProgress(percent, msg);
                        log(`è½‰è­¯é€²åº¦: ${percent}% - ${msg}`);
                    }
                });
                
                log('è½‰è­¯å®Œæˆï¼', 'success');
                log(`çµæœ: ${JSON.stringify(result, null, 2)}`);
                
            } catch (error) {
                log('è½‰è­¯å¤±æ•—: ' + error.message, 'error');
                console.error(error);
            }
        }
        
        window.testWithFile = async function(file) {
            if (!file) return;
            
            try {
                if (!wasmManager || !wasmManager.isInitialized) {
                    log('è‡ªå‹•åˆå§‹åŒ– WASM...');
                    await testInit();
                }
                
                log(`æ¸¬è©¦æª”æ¡ˆ: ${file.name} (${(file.size/1024/1024).toFixed(2)}MB)`);
                
                const result = await wasmManager.transcribe(file, {
                    onProgress: (progress) => {
                        const percent = progress.percentage || 0;
                        const msg = progress.message || 'è½‰è­¯ä¸­...';
                        updateProgress(percent, msg);
                    }
                });
                
                log('è½‰è­¯å®Œæˆï¼', 'success');
                log(`æ–‡å­—é•·åº¦: ${result.text ? result.text.length : 0}`);
                log(`æ®µè½æ•¸: ${result.segments ? result.segments.length : 0}`);
                
            } catch (error) {
                log('è½‰è­¯å¤±æ•—: ' + error.message, 'error');
                console.error(error);
            }
        }
        
        // é é¢è¼‰å…¥æ™‚çš„åˆå§‹åŒ–
        log('WASM ä¿®å¾©æ¸¬è©¦é é¢å·²è¼‰å…¥');
        log('é»æ“Š"æ¸¬è©¦åˆå§‹åŒ–"é–‹å§‹æ¸¬è©¦');
    </script>
</body>
</html>