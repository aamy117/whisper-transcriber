<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>進度顯示 UI 測試</title>
    
    <link rel="stylesheet" href="css/shared.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/progress.css">
    
    <style>
        .test-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
        }
        
        .test-header {
            text-align: center;
            padding: 2rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .test-card {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .test-card h3 {
            margin-bottom: 1rem;
            color: var(--primary-color);
        }
        
        .test-card button {
            width: 100%;
            margin-top: 1rem;
        }
        
        .demo-section {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        
        .inline-demo {
            margin: 2rem 0;
        }
        
        .log-area {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 1rem;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>📊 進度顯示 UI 測試</h1>
            <p>測試各種進度顯示元件和情境</p>
        </div>
        
        <!-- 基本進度測試 -->
        <div class="test-grid">
            <div class="test-card">
                <h3>🎯 基本進度條</h3>
                <p>簡單的進度顯示，無取消按鈕</p>
                <button class="btn btn-primary" onclick="testBasicProgress()">測試基本進度</button>
            </div>
            
            <div class="test-card">
                <h3>⚙️ 階段進度</h3>
                <p>多階段處理進度顯示</p>
                <button class="btn btn-primary" onclick="testStageProgress()">測試階段進度</button>
            </div>
            
            <div class="test-card">
                <h3>🚫 可取消進度</h3>
                <p>支援取消操作的進度</p>
                <button class="btn btn-primary" onclick="testCancellableProgress()">測試可取消進度</button>
            </div>
            
            <div class="test-card">
                <h3>📋 詳細資訊進度</h3>
                <p>顯示處理詳細資訊</p>
                <button class="btn btn-primary" onclick="testDetailedProgress()">測試詳細進度</button>
            </div>
            
            <div class="test-card">
                <h3>🎵 音訊分割進度</h3>
                <p>模擬音訊分割處理</p>
                <button class="btn btn-primary" onclick="testAudioSplitting()">測試分割進度</button>
            </div>
            
            <div class="test-card">
                <h3>❌ 錯誤處理</h3>
                <p>測試錯誤狀態顯示</p>
                <button class="btn btn-primary" onclick="testErrorProgress()">測試錯誤狀態</button>
            </div>
        </div>
        
        <!-- 內聯進度條示範 -->
        <div class="demo-section">
            <h3>內聯進度條示範</h3>
            <div class="inline-demo" id="inlineDemo1"></div>
            <div class="inline-demo" id="inlineDemo2"></div>
            <button class="btn btn-secondary" onclick="testInlineProgress()">測試內聯進度</button>
        </div>
        
        <!-- 測試日誌 -->
        <div class="demo-section">
            <h3>測試日誌</h3>
            <div class="log-area" id="testLog">
                等待測試開始...
            </div>
        </div>
    </div>

    <script type="module">
        import { ProgressManager, showProgress, showSimpleProgress, showProcessingProgress } from './js/progress-manager.js';
        
        const progressManager = new ProgressManager();
        let currentProgress = null;
        let cancelled = false;
        
        // 日誌功能
        function log(message) {
            const logArea = document.getElementById('testLog');
            const time = new Date().toLocaleTimeString();
            logArea.innerHTML += `<div>[${time}] ${message}</div>`;
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        // 測試基本進度
        window.testBasicProgress = async function() {
            log('開始基本進度測試');
            
            currentProgress = showSimpleProgress('處理中', '正在執行基本任務...');
            
            // 模擬進度更新
            for (let i = 0; i <= 100; i += 10) {
                currentProgress.update(i, `處理中... ${i}%`);
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            
            currentProgress.complete();
            log('基本進度測試完成');
        };
        
        // 測試階段進度
        window.testStageProgress = async function() {
            log('開始階段進度測試');
            
            const stages = [
                '準備檔案',
                '音訊解碼',
                '轉譯處理',
                '結果整理',
                '儲存輸出'
            ];
            
            currentProgress = showProgress({
                title: '音訊轉譯',
                message: '正在處理您的音訊檔案...',
                stages: stages,
                showDetails: true,
                icon: '🎵'
            });
            
            for (let i = 0; i < stages.length; i++) {
                currentProgress.setStage(i);
                currentProgress.setMessage(`正在${stages[i]}...`);
                
                // 模擬每個階段的進度
                for (let j = 0; j <= 100; j += 25) {
                    const overallProgress = (i * 100 + j) / stages.length;
                    currentProgress.update(overallProgress);
                    await new Promise(resolve => setTimeout(resolve, 200));
                }
            }
            
            currentProgress.complete();
            log('階段進度測試完成');
        };
        
        // 測試可取消進度
        window.testCancellableProgress = async function() {
            log('開始可取消進度測試');
            cancelled = false;
            
            currentProgress = showProcessingProgress(
                '大檔案處理',
                ['檔案分析', '音訊壓縮', 'API 上傳', '結果處理'],
                () => {
                    cancelled = true;
                    log('使用者取消了操作');
                }
            );
            
            for (let i = 0; i <= 100; i += 5) {
                if (cancelled) {
                    log('操作已取消');
                    break;
                }
                
                currentProgress.update(i, `處理進度 ${i}%`);
                
                if (i === 25) currentProgress.setStage(1);
                if (i === 50) currentProgress.setStage(2);
                if (i === 75) currentProgress.setStage(3);
                
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            if (!cancelled) {
                currentProgress.complete();
                log('可取消進度測試完成');
            }
        };
        
        // 測試詳細資訊進度
        window.testDetailedProgress = async function() {
            log('開始詳細資訊進度測試');
            
            currentProgress = showProgress({
                title: '檔案上傳',
                message: '正在上傳音訊檔案...',
                showDetails: true,
                icon: '📤'
            });
            
            const fileSize = 25.6; // MB
            let uploaded = 0;
            
            currentProgress.addDetail('檔案名稱', 'recording.wav');
            currentProgress.addDetail('檔案大小', `${fileSize} MB`);
            currentProgress.addDetail('上傳速度', '0 KB/s');
            
            const interval = setInterval(() => {
                uploaded += Math.random() * 2;
                if (uploaded > fileSize) uploaded = fileSize;
                
                const progress = (uploaded / fileSize) * 100;
                const speed = (Math.random() * 500 + 100).toFixed(0);
                
                currentProgress.update(progress);
                currentProgress.addDetail('已上傳', `${uploaded.toFixed(1)} MB`);
                currentProgress.addDetail('上傳速度', `${speed} KB/s`);
                
                if (uploaded >= fileSize) {
                    clearInterval(interval);
                    currentProgress.complete();
                    log('詳細資訊進度測試完成');
                }
            }, 500);
        };
        
        // 測試音訊分割進度
        window.testAudioSplitting = async function() {
            log('開始音訊分割進度測試');
            
            currentProgress = showProgress({
                title: '音訊分割處理',
                message: '正在將大檔案分割成小段...',
                stages: ['檔案分析', '分割處理', '段落轉譯', '結果合併'],
                showDetails: true,
                icon: '✂️'
            });
            
            // 顯示分段進度
            const segmentProgress = currentProgress.showSegmentProgress?.(10) || 
                                  progressManager.showSegmentProgress(10);
            
            currentProgress.setStage(0);
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            currentProgress.setStage(1);
            for (let i = 0; i < 10; i++) {
                segmentProgress?.setSegmentStatus(i, 'processing');
                currentProgress.update((i + 1) * 10, `處理第 ${i + 1}/10 段`);
                await new Promise(resolve => setTimeout(resolve, 300));
                segmentProgress?.setSegmentStatus(i, 'completed');
            }
            
            currentProgress.setStage(2);
            currentProgress.update(100, '所有段落處理完成');
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            currentProgress.complete();
            log('音訊分割進度測試完成');
        };
        
        // 測試錯誤狀態
        window.testErrorProgress = async function() {
            log('開始錯誤狀態測試');
            
            currentProgress = showProgress({
                title: 'API 轉譯',
                message: '正在連接 OpenAI API...',
                icon: '🌐'
            });
            
            // 模擬處理
            for (let i = 0; i <= 60; i += 10) {
                currentProgress.update(i, `處理中... ${i}%`);
                await new Promise(resolve => setTimeout(resolve, 200));
            }
            
            // 模擬錯誤
            currentProgress.error('API 連線失敗：請檢查網路連線');
            log('錯誤狀態測試完成');
        };
        
        // 測試內聯進度
        window.testInlineProgress = function() {
            log('開始內聯進度測試');
            
            const progress1 = progressManager.createInlineProgress(
                document.getElementById('inlineDemo1'),
                { label: '檔案處理' }
            );
            
            const progress2 = progressManager.createInlineProgress(
                document.getElementById('inlineDemo2'),
                { label: '資料上傳', showPercentage: false }
            );
            
            let value = 0;
            const interval = setInterval(() => {
                value += 5;
                progress1.update(value);
                progress2.update(value);
                
                if (value >= 100) {
                    clearInterval(interval);
                    log('內聯進度測試完成');
                }
            }, 100);
        };
        
        // 頁面載入完成
        log('進度顯示 UI 測試頁面已就緒');
    </script>
</body>
</html>