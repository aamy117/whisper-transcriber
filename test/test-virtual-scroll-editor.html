<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>虛擬滾動編輯器測試</title>
  <link rel="stylesheet" href="../css/style.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }
    
    .test-container {
      display: flex;
      gap: 20px;
      height: 600px;
    }
    
    .controls {
      flex: 0 0 300px;
      background: #f5f5f5;
      padding: 20px;
      border-radius: 8px;
      overflow-y: auto;
    }
    
    .editor-wrapper {
      flex: 1;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    #editorContainer {
      flex: 1;
      overflow: auto;
      position: relative;
    }
    
    .stats {
      background: #e0e0e0;
      padding: 10px;
      font-family: monospace;
      font-size: 12px;
      border-top: 1px solid #ccc;
    }
    
    button {
      margin: 5px;
      padding: 8px 16px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    button:hover {
      background: #0056b3;
    }
    
    .section {
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #ddd;
    }
    
    h3 {
      margin-top: 0;
    }
    
    .debug-info {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 11px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <h1>虛擬滾動編輯器測試</h1>
  
  <div class="test-container">
    <div class="controls">
      <div class="section">
        <h3>段落生成</h3>
        <button onclick="generateSegments(50)">生成 50 個段落</button>
        <button onclick="generateSegments(100)">生成 100 個段落</button>
        <button onclick="generateSegments(500)">生成 500 個段落</button>
        <button onclick="generateSegments(1000)">生成 1000 個段落</button>
        <button onclick="clearSegments()">清空段落</button>
      </div>
      
      <div class="section">
        <h3>滾動測試</h3>
        <button onclick="scrollToTop()">滾動到頂部</button>
        <button onclick="scrollToMiddle()">滾動到中間</button>
        <button onclick="scrollToBottom()">滾動到底部</button>
        <button onclick="scrollToRandom()">滾動到隨機位置</button>
      </div>
      
      <div class="section">
        <h3>偵錯信息</h3>
        <div id="debugInfo" class="debug-info">等待初始化...</div>
      </div>
    </div>
    
    <div class="editor-wrapper">
      <div id="editorContainer"></div>
      <div class="stats" id="stats">統計信息</div>
    </div>
  </div>

  <script type="module">
    import { TranscriptionEditor } from '../js/editor.js';
    
    let editor;
    let updateInterval;
    
    // 初始化編輯器
    function initEditor() {
      const container = document.getElementById('editorContainer');
      editor = new TranscriptionEditor(container);
      
      // 設置編輯器事件監聽
      editor.on('notification', (data) => {
        console.log('通知:', data);
      });
      
      editor.on('edit', (data) => {
        console.log('編輯:', data);
      });
      
      // 開始更新偵錯信息
      updateInterval = setInterval(updateDebugInfo, 500);
      
      console.log('編輯器初始化完成');
    }
    
    // 生成測試段落
    window.generateSegments = function(count) {
      const segments = [];
      let currentTime = 0;
      
      for (let i = 0; i < count; i++) {
        const duration = Math.random() * 5 + 2; // 2-7 秒
        const hasLongText = Math.random() > 0.7; // 30% 機率有長文字
        
        segments.push({
          id: `seg_${i}`,
          start: currentTime,
          end: currentTime + duration,
          text: `這是第 ${i + 1} 個段落的測試文字。這段文字包含了一些隨機生成的內容，用於測試虛擬滾動的效果。${hasLongText ? '這是額外的文字，使段落更長一些。有時候段落會特別長，需要測試不同高度的項目是否能正確顯示。' : ''}`,
          textWithoutPunctuation: `這是第 ${i + 1} 個段落的測試文字 這段文字包含了一些隨機生成的內容 用於測試虛擬滾動的效果 ${hasLongText ? '這是額外的文字 使段落更長一些 有時候段落會特別長 需要測試不同高度的項目是否能正確顯示' : ''}`
        });
        currentTime += duration;
      }
      
      // 載入轉譯結果
      editor.loadTranscription({ segments });
      updateStats();
    };
    
    // 清空段落
    window.clearSegments = function() {
      editor.loadTranscription({ segments: [] });
      updateStats();
    };
    
    // 滾動控制
    window.scrollToTop = function() {
      const container = document.getElementById('editorContainer');
      container.scrollTop = 0;
    };
    
    window.scrollToMiddle = function() {
      const container = document.getElementById('editorContainer');
      container.scrollTop = container.scrollHeight / 2;
    };
    
    window.scrollToBottom = function() {
      const container = document.getElementById('editorContainer');
      container.scrollTop = container.scrollHeight;
    };
    
    window.scrollToRandom = function() {
      const container = document.getElementById('editorContainer');
      const randomPosition = Math.random() * container.scrollHeight;
      container.scrollTop = randomPosition;
    };
    
    // 更新統計信息
    function updateStats() {
      const statsEl = document.getElementById('stats');
      const segmentCount = editor.segments ? editor.segments.length : 0;
      const isVirtualMode = segmentCount > editor.virtualScrollThreshold;
      
      statsEl.innerHTML = `
        模式：${isVirtualMode ? '虛擬滾動' : '普通渲染'} | 
        段落數：${segmentCount} | 
        閾值：${editor.virtualScrollThreshold}
      `;
    }
    
    // 更新偵錯信息
    function updateDebugInfo() {
      const debugEl = document.getElementById('debugInfo');
      const container = document.getElementById('editorContainer');
      
      if (!editor || !editor.virtualScrollManager) {
        debugEl.textContent = '編輯器未初始化';
        return;
      }
      
      const vsm = editor.virtualScrollManager;
      const visibleRange = vsm.visibleRange || { start: 0, end: 0 };
      
      debugEl.innerHTML = `
容器高度: ${container.clientHeight}px
滾動位置: ${container.scrollTop.toFixed(0)}px
總高度: ${container.scrollHeight}px
虛擬滾動: ${vsm.isVirtualMode ? '啟用' : '停用'}
可見範圍: ${visibleRange.start} - ${visibleRange.end}
視口元素: ${vsm.viewport ? '已創建' : '未創建'}
段落總數: ${editor.segments ? editor.segments.length : 0}
      `.trim();
    }
    
    // 初始化
    initEditor();
    
    // 生成初始段落
    generateSegments(200);
  </script>
</body>
</html>