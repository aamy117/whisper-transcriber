<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASM æ•´åˆæ¸¬è©¦ - å®Œæ•´æµç¨‹</title>
    
    <!-- å¼•å…¥æ‰€æœ‰å°ˆæ¡ˆæ¨£å¼ -->
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/dialog.css">
    <link rel="stylesheet" href="../css/notification.css">
    <link rel="stylesheet" href="../css/preprocessing.css">
    <link rel="stylesheet" href="../css/progress.css">
    
    <style>
        .integration-test-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .test-header {
            text-align: center;
            padding: 2rem 0;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 2rem;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        @media (max-width: 968px) {
            .test-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .test-panel {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }
        
        .test-panel h3 {
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }
        
        .file-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 3rem;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            margin-bottom: 1rem;
        }
        
        .file-upload-area:hover {
            border-color: var(--primary-color);
            background: var(--bg-tertiary);
        }
        
        .file-upload-area.dragover {
            border-color: var(--success-color);
            background: rgba(34, 197, 94, 0.1);
        }
        
        .file-info {
            background: var(--bg-primary);
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
            display: none;
        }
        
        .file-info.show {
            display: block;
        }
        
        .test-controls {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            background: var(--bg-tertiary);
            margin-bottom: 1rem;
        }
        
        .status-indicator.success {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success-color);
        }
        
        .status-indicator.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error-color);
        }
        
        .status-indicator.warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }
        
        .result-display {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 1rem;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 1rem;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 0.875rem;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .feature-card {
            background: var(--bg-primary);
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            text-align: center;
        }
        
        .feature-card.enabled {
            border-color: var(--success-color);
        }
        
        .feature-card.disabled {
            opacity: 0.6;
        }
        
        .log-panel {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 1rem;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.85rem;
            margin-top: 1rem;
        }
        
        .log-entry {
            padding: 0.25rem 0;
        }
        
        .log-entry.error {
            color: var(--error-color);
        }
        
        .log-entry.success {
            color: var(--success-color);
        }
        
        .log-entry.info {
            color: var(--text-secondary);
        }
        
        #fileInput {
            display: none;
        }
    </style>
</head>
<body>
    <div class="integration-test-container">
        <div class="test-header">
            <h1>ğŸ”§ WASM æ•´åˆæ¸¬è©¦</h1>
            <p>æ¸¬è©¦å¤§æª”æ¡ˆè™•ç† + WASM æœ¬åœ°è½‰è­¯çš„å®Œæ•´æµç¨‹</p>
        </div>

        <div class="test-grid">
            <!-- å·¦å´ï¼šæª”æ¡ˆä¸Šå‚³å’Œæ§åˆ¶ -->
            <div class="test-panel">
                <h3>æ¸¬è©¦æ§åˆ¶é¢æ¿</h3>
                
                <div class="status-indicator" id="systemStatus">
                    <span class="status-dot"></span>
                    <span>ç³»çµ±ç‹€æ…‹æª¢æŸ¥ä¸­...</span>
                </div>
                
                <div class="file-upload-area" id="uploadArea">
                    <p>ğŸµ æ‹–æ”¾éŸ³è¨Šæª”æ¡ˆåˆ°æ­¤è™•</p>
                    <p>æˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ</p>
                    <input type="file" id="fileInput" accept="audio/*">
                </div>
                
                <div class="file-info" id="fileInfo">
                    <h4>æª”æ¡ˆè³‡è¨Š</h4>
                    <p>åç¨±ï¼š<span id="fileName">-</span></p>
                    <p>å¤§å°ï¼š<span id="fileSize">-</span></p>
                    <p>é¡å‹ï¼š<span id="fileType">-</span></p>
                    <p>ç‹€æ…‹ï¼š<span id="fileStatus">-</span></p>
                </div>
                
                <div class="test-controls">
                    <button class="btn btn-primary" id="startTest" disabled>é–‹å§‹æ¸¬è©¦è½‰è­¯</button>
                    <button class="btn btn-secondary" id="toggleWASM">åˆ‡æ› WASM</button>
                    <button class="btn btn-secondary" id="clearCache">æ¸…é™¤å¿«å–</button>
                </div>
                
                <div class="feature-grid">
                    <div class="feature-card" id="wasmFeature">
                        <h5>WASM</h5>
                        <span id="wasmStatus">æª¢æ¸¬ä¸­</span>
                    </div>
                    <div class="feature-card" id="splitFeature">
                        <h5>æ™ºèƒ½åˆ†å‰²</h5>
                        <span>âœ… å•Ÿç”¨</span>
                    </div>
                    <div class="feature-card" id="compressFeature">
                        <h5>æ™ºèƒ½å£“ç¸®</h5>
                        <span>âœ… å•Ÿç”¨</span>
                    </div>
                    <div class="feature-card" id="hybridFeature">
                        <h5>æ··åˆæ¨¡å¼</h5>
                        <span>âœ… å•Ÿç”¨</span>
                    </div>
                </div>
            </div>
            
            <!-- å³å´ï¼šçµæœé¡¯ç¤º -->
            <div class="test-panel">
                <h3>æ¸¬è©¦çµæœ</h3>
                
                <div id="progressArea" style="display: none;">
                    <h4>è™•ç†é€²åº¦</h4>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                    </div>
                    <p id="progressText">æº–å‚™ä¸­...</p>
                </div>
                
                <div id="resultArea" style="display: none;">
                    <h4>è½‰è­¯çµæœ</h4>
                    <div class="result-display" id="resultDisplay"></div>
                </div>
                
                <div class="log-panel" id="logPanel">
                    <div class="log-entry info">[ç³»çµ±] æ•´åˆæ¸¬è©¦å°±ç·’</div>
                </div>
            </div>
        </div>

        <!-- é€šçŸ¥å€åŸŸ -->
        <div id="notification-container"></div>
    </div>

    <!-- å¼•å…¥æ‰€æœ‰å¿…è¦çš„æ¨¡çµ„ -->
    <script type="module">
        import { notify } from '../js/notification.js';
        import { TranscriptionPreprocessor } from '../js/transcription-preprocessor.js';
        import { WhisperWASMManager } from '../js/wasm/whisper-wasm-manager.js';
        import { WhisperAPI } from '../js/api.js';
        
        // å…¨åŸŸè®Šæ•¸
        let currentFile = null;
        let preprocessor = null;
        let wasmManager = null;
        let api = null;
        
        // æ—¥èªŒåŠŸèƒ½
        function log(message, type = 'info') {
            const logPanel = document.getElementById('logPanel');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const time = new Date().toLocaleTimeString();
            entry.textContent = `[${time}] ${message}`;
            logPanel.appendChild(entry);
            logPanel.scrollTop = logPanel.scrollHeight;
        }
        
        // åˆå§‹åŒ–
        async function init() {
            log('åˆå§‹åŒ–æ¸¬è©¦ç’°å¢ƒ...', 'info');
            
            try {
                // åˆå§‹åŒ–é è™•ç†å™¨
                preprocessor = new TranscriptionPreprocessor();
                log('é è™•ç†å™¨åˆå§‹åŒ–æˆåŠŸ', 'success');
                
                // åˆå§‹åŒ– API
                api = new WhisperAPI();
                log('API åˆå§‹åŒ–æˆåŠŸ', 'success');
                
                // æª¢æŸ¥ç³»çµ±ç‹€æ…‹
                await checkSystemStatus();
                
                // ç¶å®šäº‹ä»¶
                bindEvents();
                
                log('æ•´åˆæ¸¬è©¦ç’°å¢ƒæº–å‚™å®Œæˆ', 'success');
                
            } catch (error) {
                log(`åˆå§‹åŒ–å¤±æ•—: ${error.message}`, 'error');
                updateSystemStatus('error', 'åˆå§‹åŒ–å¤±æ•—');
            }
        }
        
        // æª¢æŸ¥ç³»çµ±ç‹€æ…‹
        async function checkSystemStatus() {
            const statusEl = document.getElementById('systemStatus');
            
            // æª¢æŸ¥ WebAssembly
            const hasWASM = 'WebAssembly' in window;
            const wasmCard = document.getElementById('wasmFeature');
            const wasmStatusEl = document.getElementById('wasmStatus');
            
            if (hasWASM) {
                wasmCard.classList.add('enabled');
                wasmStatusEl.textContent = preprocessor.ENABLE_WASM ? 'âœ… å·²å•Ÿç”¨' : 'âŒ å·²åœç”¨';
            } else {
                wasmCard.classList.add('disabled');
                wasmStatusEl.textContent = 'âŒ ä¸æ”¯æ´';
            }
            
            // æ›´æ–°ç³»çµ±ç‹€æ…‹
            if (hasWASM && preprocessor.ENABLE_WASM) {
                updateSystemStatus('success', 'æ‰€æœ‰åŠŸèƒ½æ­£å¸¸');
            } else if (hasWASM) {
                updateSystemStatus('warning', 'WASM å·²åœç”¨');
            } else {
                updateSystemStatus('error', 'WebAssembly ä¸æ”¯æ´');
            }
        }
        
        function updateSystemStatus(type, message) {
            const statusEl = document.getElementById('systemStatus');
            statusEl.className = `status-indicator ${type}`;
            statusEl.querySelector('span:last-child').textContent = message;
        }
        
        // ç¶å®šäº‹ä»¶
        function bindEvents() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const startBtn = document.getElementById('startTest');
            const toggleBtn = document.getElementById('toggleWASM');
            const clearBtn = document.getElementById('clearCache');
            
            // æª”æ¡ˆä¸Šå‚³
            uploadArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileSelect);
            
            // æ‹–æ”¾æ”¯æ´
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect({ target: { files } });
                }
            });
            
            // æŒ‰éˆ•äº‹ä»¶
            startBtn.addEventListener('click', startTest);
            toggleBtn.addEventListener('click', toggleWASM);
            clearBtn.addEventListener('click', clearCache);
        }
        
        // è™•ç†æª”æ¡ˆé¸æ“‡
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            currentFile = file;
            
            // æ›´æ–°æª”æ¡ˆè³‡è¨Š
            const fileInfo = document.getElementById('fileInfo');
            fileInfo.classList.add('show');
            
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('fileType').textContent = file.type || 'æœªçŸ¥';
            
            // æª¢æŸ¥æª”æ¡ˆå¤§å°
            const isLarge = file.size > 25 * 1024 * 1024;
            document.getElementById('fileStatus').textContent = isLarge ? 'å¤§æª”æ¡ˆ (éœ€è¦è™•ç†)' : 'æ¨™æº–æª”æ¡ˆ';
            
            // å•Ÿç”¨æ¸¬è©¦æŒ‰éˆ•
            document.getElementById('startTest').disabled = false;
            
            log(`å·²é¸æ“‡æª”æ¡ˆ: ${file.name} (${formatFileSize(file.size)})`, 'info');
        }
        
        // é–‹å§‹æ¸¬è©¦
        async function startTest() {
            if (!currentFile) return;
            
            log('é–‹å§‹æ•´åˆæ¸¬è©¦...', 'info');
            
            try {
                // é¡¯ç¤ºé€²åº¦å€åŸŸ
                document.getElementById('progressArea').style.display = 'block';
                document.getElementById('resultArea').style.display = 'none';
                
                // ä½¿ç”¨é è™•ç†å™¨
                log('å‘¼å«é è™•ç†å™¨...', 'info');
                const preprocessResult = await preprocessor.prepareForTranscription(currentFile);
                
                log(`é è™•ç†ç­–ç•¥: ${preprocessResult.strategy}`, 'info');
                
                // æ ¹æ“šç­–ç•¥è™•ç†
                let result = null;
                
                if (preprocessResult.strategy === 'wasm') {
                    log('ä½¿ç”¨ WASM æœ¬åœ°è½‰è­¯', 'info');
                    result = await handleWASMTranscription(preprocessResult);
                } else if (preprocessResult.strategy === 'direct') {
                    log('ç›´æ¥ä½¿ç”¨ API è½‰è­¯', 'info');
                    result = await handleAPITranscription(currentFile);
                } else {
                    log(`ä½¿ç”¨ ${preprocessResult.strategy} ç­–ç•¥è™•ç†`, 'info');
                    result = await handleProcessedTranscription(preprocessResult);
                }
                
                // é¡¯ç¤ºçµæœ
                showResult(result);
                
            } catch (error) {
                log(`æ¸¬è©¦å¤±æ•—: ${error.message}`, 'error');
                notify.error(`æ¸¬è©¦å¤±æ•—: ${error.message}`);
            }
        }
        
        // WASM è½‰è­¯è™•ç†
        async function handleWASMTranscription(preprocessResult) {
            const wasmManager = preprocessResult.wasmManager;
            
            updateProgress(0, 'æº–å‚™æœ¬åœ°è½‰è­¯...');
            
            const result = await wasmManager.transcribe(currentFile, {
                onProgress: (progress) => {
                    updateProgress(progress.percentage, progress.message);
                    log(`WASM é€²åº¦: ${progress.percentage}% - ${progress.message}`, 'info');
                }
            });
            
            result.strategy = 'wasm';
            result.model = preprocessResult.model;
            
            return result;
        }
        
        // API è½‰è­¯è™•ç†
        async function handleAPITranscription(file) {
            updateProgress(10, 'ä¸Šå‚³æª”æ¡ˆä¸­...');
            
            try {
                const result = await api.transcribe(file, {
                    language: 'zh',
                    prompt: 'ä»¥ä¸‹æ˜¯æ™®é€šè©±çš„å°è©±å…§å®¹ã€‚'
                });
                
                updateProgress(100, 'è½‰è­¯å®Œæˆ');
                result.strategy = 'direct';
                
                return result;
            } catch (error) {
                // å¦‚æœ API æœªè¨­å®šï¼Œè¿”å›æ¨¡æ“¬çµæœ
                log('API æœªè¨­å®šï¼Œè¿”å›æ¨¡æ“¬çµæœ', 'warning');
                return {
                    text: '[æ¨¡æ“¬çµæœ] API æœªè¨­å®šï¼Œç„¡æ³•é€²è¡ŒçœŸå¯¦è½‰è­¯',
                    segments: [],
                    strategy: 'direct-simulated'
                };
            }
        }
        
        // è™•ç†å¾Œçš„æª”æ¡ˆè½‰è­¯
        async function handleProcessedTranscription(preprocessResult) {
            const totalFiles = preprocessResult.files.length;
            let allText = '';
            
            for (let i = 0; i < totalFiles; i++) {
                updateProgress(
                    (i / totalFiles) * 100,
                    `è™•ç†ç¬¬ ${i + 1}/${totalFiles} æ®µ...`
                );
                
                // æ¨¡æ“¬è™•ç†
                await new Promise(resolve => setTimeout(resolve, 1000));
                allText += `[æ®µè½ ${i + 1}] æ¨¡æ“¬è½‰è­¯çµæœ\n`;
            }
            
            updateProgress(100, 'è™•ç†å®Œæˆ');
            
            return {
                text: allText,
                segments: [],
                strategy: preprocessResult.strategy
            };
        }
        
        // æ›´æ–°é€²åº¦
        function updateProgress(percentage, message) {
            document.getElementById('progressBar').style.width = `${percentage}%`;
            document.getElementById('progressText').textContent = message;
        }
        
        // é¡¯ç¤ºçµæœ
        function showResult(result) {
            document.getElementById('resultArea').style.display = 'block';
            
            const display = document.getElementById('resultDisplay');
            display.textContent = JSON.stringify(result, null, 2);
            
            log('æ¸¬è©¦å®Œæˆ', 'success');
            notify.success(`è½‰è­¯å®Œæˆ - ç­–ç•¥: ${result.strategy}`);
        }
        
        // åˆ‡æ› WASM
        function toggleWASM() {
            preprocessor.ENABLE_WASM = !preprocessor.ENABLE_WASM;
            
            const wasmStatusEl = document.getElementById('wasmStatus');
            wasmStatusEl.textContent = preprocessor.ENABLE_WASM ? 'âœ… å·²å•Ÿç”¨' : 'âŒ å·²åœç”¨';
            
            log(`WASM åŠŸèƒ½ ${preprocessor.ENABLE_WASM ? 'å·²å•Ÿç”¨' : 'å·²åœç”¨'}`, 'info');
            notify.info(`WASM åŠŸèƒ½ ${preprocessor.ENABLE_WASM ? 'å·²å•Ÿç”¨' : 'å·²åœç”¨'}`);
            
            checkSystemStatus();
        }
        
        // æ¸…é™¤å¿«å–
        async function clearCache() {
            try {
                if (!wasmManager) {
                    wasmManager = new WhisperWASMManager();
                }
                
                await wasmManager.clearCache();
                log('æ¨¡å‹å¿«å–å·²æ¸…é™¤', 'success');
                notify.success('å¿«å–æ¸…é™¤æˆåŠŸ');
                
            } catch (error) {
                log(`æ¸…é™¤å¿«å–å¤±æ•—: ${error.message}`, 'error');
                notify.error('æ¸…é™¤å¿«å–å¤±æ•—');
            }
        }
        
        // å·¥å…·å‡½æ•¸
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // å•Ÿå‹•
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>