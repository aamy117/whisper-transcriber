<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>增強版進度管理器測試</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/progress.css">
    <style>
        .test-container {
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
        }
        
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .test-button {
            padding: 15px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .test-button:active {
            transform: translateY(0);
        }
        
        .test-info {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }
        
        .test-info code {
            background: var(--bg-primary);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <h1>增強版進度管理器測試</h1>
            <p>測試整合後的進度顯示功能</p>
        </header>

        <div class="test-container">
            <div class="test-info">
                <h3>測試說明</h3>
                <p>這個頁面測試增強版進度管理器的各種功能：</p>
                <ul>
                    <li>階段式進度顯示</li>
                    <li>詳細資訊面板</li>
                    <li>分段進度（用於音訊分割）</li>
                    <li>取消功能整合</li>
                    <li>錯誤處理顯示</li>
                </ul>
            </div>

            <div class="test-section">
                <h3>基本功能測試</h3>
                <div class="test-grid">
                    <button class="test-button" onclick="testBasicProgress()">
                        基本進度
                    </button>
                    <button class="test-button" onclick="testStagesProgress()">
                        階段進度
                    </button>
                    <button class="test-button" onclick="testDetailedProgress()">
                        詳細進度
                    </button>
                    <button class="test-button" onclick="testCancellableProgress()">
                        可取消進度
                    </button>
                </div>
            </div>

            <div class="test-section">
                <h3>轉譯流程測試</h3>
                <div class="test-grid">
                    <button class="test-button" onclick="testDirectTranscription()">
                        直接轉譯
                    </button>
                    <button class="test-button" onclick="testWASMTranscription()">
                        WASM 轉譯
                    </button>
                    <button class="test-button" onclick="testSegmentedTranscription()">
                        分段轉譯
                    </button>
                    <button class="test-button" onclick="testCompressionProgress()">
                        壓縮處理
                    </button>
                </div>
            </div>

            <div class="test-section">
                <h3>錯誤處理測試</h3>
                <div class="test-grid">
                    <button class="test-button" onclick="testErrorHandling()">
                        錯誤顯示
                    </button>
                    <button class="test-button" onclick="testCancellation()">
                        取消操作
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { progressManager, showProcessingProgress } from '../js/progress-manager.js';
        
        // 基本進度測試
        window.testBasicProgress = function() {
            const progress = progressManager.showProgress({
                title: '基本進度測試',
                message: '正在處理...',
                cancellable: false,
                showDetails: false,
                icon: '⚡'
            });
            
            let percentage = 0;
            const interval = setInterval(() => {
                percentage += 10;
                progress.update(percentage, `處理中... ${percentage}%`);
                
                if (percentage >= 100) {
                    clearInterval(interval);
                    progress.complete();
                }
            }, 500);
        };
        
        // 階段進度測試
        window.testStagesProgress = function() {
            const progress = showProcessingProgress(
                '階段式處理測試',
                ['準備階段', '處理階段', '驗證階段', '完成階段'],
                () => console.log('已取消')
            );
            
            let stage = 0;
            const nextStage = () => {
                if (stage < 4) {
                    progress.setStage(stage);
                    progress.update(stage * 25, `正在執行第 ${stage + 1} 階段...`);
                    stage++;
                    setTimeout(nextStage, 1500);
                } else {
                    progress.complete();
                }
            };
            
            nextStage();
        };
        
        // 詳細進度測試
        window.testDetailedProgress = function() {
            const progress = progressManager.showProgress({
                title: '詳細資訊測試',
                message: '顯示處理詳情...',
                stages: ['分析', '處理', '輸出'],
                cancellable: true,
                onCancel: () => console.log('使用者取消'),
                showDetails: true,
                icon: '📊'
            });
            
            progress.setStage(0);
            progress.addDetail('檔案名稱', 'test-audio.mp3');
            progress.addDetail('檔案大小', '45.3 MB');
            progress.addDetail('處理方式', '智能壓縮');
            
            let percentage = 0;
            const interval = setInterval(() => {
                percentage += 5;
                progress.update(percentage);
                
                // 動態更新詳情
                if (percentage === 30) {
                    progress.setStage(1);
                    progress.addDetail('壓縮比', '65%');
                } else if (percentage === 70) {
                    progress.setStage(2);
                    progress.addDetail('輸出大小', '29.4 MB');
                }
                
                if (percentage >= 100) {
                    clearInterval(interval);
                    progress.addDetail('處理時間', '12.5 秒');
                    progress.complete();
                }
            }, 300);
        };
        
        // 可取消進度測試
        window.testCancellableProgress = function() {
            let cancelled = false;
            const progress = progressManager.showProgress({
                title: '可取消操作',
                message: '點擊取消按鈕停止處理...',
                cancellable: true,
                onCancel: () => {
                    cancelled = true;
                    console.log('操作已取消');
                },
                showDetails: true,
                icon: '🛑'
            });
            
            progress.addDetail('狀態', '處理中');
            
            let percentage = 0;
            const interval = setInterval(() => {
                if (cancelled) {
                    clearInterval(interval);
                    progress.close();
                    return;
                }
                
                percentage += 2;
                progress.update(percentage, `處理進度 ${percentage}%`);
                progress.addDetail('已處理', `${percentage} / 100`);
                
                if (percentage >= 100) {
                    clearInterval(interval);
                    progress.complete();
                }
            }, 200);
        };
        
        // 直接轉譯測試
        window.testDirectTranscription = function() {
            const progress = showProcessingProgress(
                '音訊轉譯處理',
                ['準備檔案', '執行轉譯', '處理結果'],
                () => console.log('取消轉譯')
            );
            
            progress.setStage(0);
            progress.update(10, '檔案準備完成');
            progress.addDetail('檔案名稱', 'sample.mp3');
            progress.addDetail('檔案大小', '15.2 MB');
            progress.addDetail('處理策略', 'direct');
            
            setTimeout(() => {
                progress.setStage(1);
                progress.update(50, '正在進行 API 轉譯...');
                progress.addDetail('轉譯方式', '雲端 API');
                
                // 模擬轉譯進度
                let transcribeProgress = 50;
                const transcribeInterval = setInterval(() => {
                    transcribeProgress += 10;
                    progress.update(transcribeProgress, `轉譯中... ${transcribeProgress - 50}%`);
                    
                    if (transcribeProgress >= 90) {
                        clearInterval(transcribeInterval);
                        progress.setStage(2);
                        progress.update(95, '儲存轉譯結果...');
                        progress.addDetail('轉譯段落數', '42');
                        progress.addDetail('總時長', '8 分鐘');
                        
                        setTimeout(() => {
                            progress.complete();
                        }, 1000);
                    }
                }, 800);
            }, 1500);
        };
        
        // WASM 轉譯測試
        window.testWASMTranscription = function() {
            const progress = showProcessingProgress(
                '本地轉譯處理',
                ['準備檔案', '執行轉譯', '處理結果'],
                () => console.log('取消轉譯')
            );
            
            progress.setStage(0);
            progress.update(25, '檔案準備完成');
            progress.addDetail('檔案名稱', 'local-audio.wav');
            progress.addDetail('檔案大小', '32.5 MB');
            progress.addDetail('處理策略', 'wasm');
            
            setTimeout(() => {
                progress.setStage(1);
                progress.update(50, '正在進行本地轉譯...');
                progress.addDetail('轉譯方式', 'WebAssembly 本地');
                progress.addDetail('模型', 'base');
                
                // 模擬 WASM 轉譯進度
                let wasmProgress = 0;
                const wasmInterval = setInterval(() => {
                    wasmProgress += 5;
                    const overallProgress = 50 + (wasmProgress * 0.4);
                    progress.update(overallProgress, `本地處理中... ${wasmProgress}%`);
                    progress.addDetail('處理速度', `${(wasmProgress / 20).toFixed(1)}x`);
                    
                    if (wasmProgress >= 100) {
                        clearInterval(wasmInterval);
                        progress.update(90, '轉譯完成，處理結果中...');
                        
                        setTimeout(() => {
                            progress.setStage(2);
                            progress.update(95, '儲存轉譯結果...');
                            progress.addDetail('轉譯段落數', '58');
                            progress.addDetail('總時長', '12 分鐘');
                            progress.complete();
                        }, 1000);
                    }
                }, 600);
            }, 1500);
        };
        
        // 分段轉譯測試
        window.testSegmentedTranscription = function() {
            const progress = showProcessingProgress(
                '音訊轉譯處理',
                ['準備檔案', '執行轉譯', '處理結果'],
                () => console.log('取消轉譯')
            );
            
            progress.setStage(0);
            progress.update(25, '檔案準備完成');
            progress.addDetail('檔案名稱', 'large-audio.mp3');
            progress.addDetail('檔案大小', '156.8 MB');
            progress.addDetail('處理策略', 'split');
            
            setTimeout(() => {
                progress.setStage(1);
                progress.update(50, '使用split策略處理...');
                progress.addDetail('處理策略', 'split');
                
                // 顯示分段進度
                const totalSegments = 8;
                const segmentProgress = progressManager.showSegmentProgress(totalSegments);
                progress.addDetail('總段數', totalSegments);
                
                let currentSegment = 0;
                const processSegment = () => {
                    if (currentSegment < totalSegments) {
                        const segmentPercentage = 50 + ((currentSegment / totalSegments) * 40);
                        progress.update(segmentPercentage, `正在轉譯第 ${currentSegment + 1}/${totalSegments} 段...`);
                        segmentProgress.setSegmentStatus(currentSegment, 'processing');
                        
                        setTimeout(() => {
                            segmentProgress.setSegmentStatus(currentSegment, 'completed');
                            currentSegment++;
                            processSegment();
                        }, 1200);
                    } else {
                        progress.update(90, '所有分段轉譯完成，合併結果中...');
                        
                        setTimeout(() => {
                            progress.setStage(2);
                            progress.update(95, '儲存轉譯結果...');
                            progress.addDetail('轉譯段落數', '186');
                            progress.addDetail('總時長', '45 分鐘');
                            progress.complete();
                        }, 1000);
                    }
                };
                
                processSegment();
            }, 1500);
        };
        
        // 壓縮進度測試
        window.testCompressionProgress = function() {
            const progress = progressManager.showProgress({
                title: '音訊壓縮處理',
                message: '正在智能壓縮音訊檔案...',
                stages: ['分析音訊品質', '計算壓縮參數', '執行壓縮', '驗證品質'],
                cancellable: true,
                onCancel: () => console.log('取消壓縮'),
                showDetails: true,
                icon: '🗜️'
            });
            
            progress.setStage(0);
            progress.addDetail('原始大小', '85.6 MB');
            progress.addDetail('目標大小', '25.0 MB');
            
            const stages = [
                { stage: 0, progress: 25, message: '分析音訊品質中...' },
                { stage: 1, progress: 50, message: '計算最佳壓縮參數...' },
                { stage: 2, progress: 85, message: '執行智能壓縮...' },
                { stage: 3, progress: 95, message: '驗證壓縮品質...' }
            ];
            
            let currentIndex = 0;
            const processStage = () => {
                if (currentIndex < stages.length) {
                    const { stage, progress: prog, message } = stages[currentIndex];
                    progress.setStage(stage);
                    progress.update(prog, message);
                    
                    if (stage === 2) {
                        progress.addDetail('壓縮比', '29.2%');
                    }
                    
                    currentIndex++;
                    setTimeout(processStage, 1500);
                } else {
                    progress.addDetail('壓縮後大小', '25.0 MB');
                    progress.addDetail('壓縮比率', '29%');
                    progress.complete();
                }
            };
            
            processStage();
        };
        
        // 錯誤處理測試
        window.testErrorHandling = function() {
            const progress = progressManager.showProgress({
                title: '錯誤處理測試',
                message: '模擬處理錯誤...',
                cancellable: false,
                showDetails: true,
                icon: '⚠️'
            });
            
            progress.addDetail('操作', '檔案處理');
            progress.update(30, '處理中...');
            
            setTimeout(() => {
                progress.update(60, '發生錯誤...');
                setTimeout(() => {
                    progress.error('處理失敗：檔案格式不支援');
                }, 1000);
            }, 1500);
        };
        
        // 取消操作測試
        window.testCancellation = function() {
            let cancelToken = { cancelled: false };
            
            const progress = showProcessingProgress(
                '取消操作測試',
                ['準備', '處理', '完成'],
                () => {
                    cancelToken.cancelled = true;
                    console.log('操作已被取消');
                }
            );
            
            progress.setStage(0);
            progress.update(10, '準備中...');
            progress.addDetail('提示', '點擊取消按鈕測試');
            
            let percentage = 10;
            const interval = setInterval(() => {
                if (cancelToken.cancelled) {
                    clearInterval(interval);
                    progress.close();
                    alert('操作已成功取消！');
                    return;
                }
                
                percentage += 5;
                progress.update(percentage, `處理進度 ${percentage}%`);
                
                if (percentage === 40) {
                    progress.setStage(1);
                } else if (percentage === 80) {
                    progress.setStage(2);
                }
                
                if (percentage >= 100) {
                    clearInterval(interval);
                    progress.complete();
                }
            }, 400);
        };
        
        console.log('增強版進度管理器測試頁面已載入');
    </script>
</body>
</html>