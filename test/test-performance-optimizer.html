<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•ˆèƒ½å„ªåŒ–å™¨æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .card {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        h2 {
            color: #666;
            margin-top: 0;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .metric-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .metric-card.warning {
            border-left-color: #ffc107;
        }
        .metric-card.danger {
            border-left-color: #dc3545;
        }
        .metric-card.success {
            border-left-color: #28a745;
        }
        .metric-label {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .metric-trend {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        .recommendations {
            background: #e9ecef;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
        }
        .recommendation-item {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 4px;
        }
        .log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #007bff;
            padding-left: 10px;
        }
        .simulation-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .simulation-button {
            padding: 8px 16px;
            background: #6c757d;
            font-size: 14px;
        }
        .report-section {
            white-space: pre-wrap;
            font-family: monospace;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ æ•ˆèƒ½å„ªåŒ–å™¨æ¸¬è©¦</h1>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="card">
            <h2>æ§åˆ¶é¢æ¿</h2>
            <div class="controls">
                <button id="startBtn">é–‹å§‹ç›£æ§</button>
                <button id="stopBtn" disabled>åœæ­¢ç›£æ§</button>
                <button id="resetBtn">é‡ç½®æŒ‡æ¨™</button>
                <button id="reportBtn">ç”Ÿæˆå ±å‘Š</button>
            </div>
        </div>

        <!-- å³æ™‚æŒ‡æ¨™ -->
        <div class="card">
            <h2>å³æ™‚æ•ˆèƒ½æŒ‡æ¨™</h2>
            <div class="metrics-grid" id="metricsGrid">
                <div class="metric-card">
                    <div class="metric-label">è¨˜æ†¶é«”ä½¿ç”¨ç‡</div>
                    <div class="metric-value" id="memoryUsage">--</div>
                    <div class="metric-trend" id="memoryTrend">--</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Worker æ•ˆç‡</div>
                    <div class="metric-value" id="workerEfficiency">--</div>
                    <div class="metric-trend" id="workerCount">--</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">ååé‡</div>
                    <div class="metric-value" id="throughput">--</div>
                    <div class="metric-trend">MB/s</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">API å»¶é²</div>
                    <div class="metric-value" id="apiLatency">--</div>
                    <div class="metric-trend">ms</div>
                </div>
            </div>
        </div>

        <!-- æ¨¡æ“¬æ§åˆ¶ -->
        <div class="card">
            <h2>æ•ˆèƒ½æ¨¡æ“¬</h2>
            <div class="simulation-controls">
                <button class="simulation-button" onclick="simulateHighMemory()">æ¨¡æ“¬é«˜è¨˜æ†¶é«”ä½¿ç”¨</button>
                <button class="simulation-button" onclick="simulateLowThroughput()">æ¨¡æ“¬ä½ååé‡</button>
                <button class="simulation-button" onclick="simulateWorkerErrors()">æ¨¡æ“¬ Worker éŒ¯èª¤</button>
                <button class="simulation-button" onclick="simulateHighLatency()">æ¨¡æ“¬é«˜ API å»¶é²</button>
                <button class="simulation-button" onclick="simulateNormalOperation()">æ¨¡æ“¬æ­£å¸¸é‹ä½œ</button>
            </div>
        </div>

        <!-- å„ªåŒ–å»ºè­° -->
        <div class="card">
            <h2>å„ªåŒ–å»ºè­°</h2>
            <div id="recommendations" class="recommendations">
                <p>ç­‰å¾…ç›£æ§è³‡æ–™...</p>
            </div>
        </div>

        <!-- æ•ˆèƒ½å ±å‘Š -->
        <div class="card">
            <h2>æ•ˆèƒ½å ±å‘Š</h2>
            <div id="report" class="report-section">
                é»æ“Šã€Œç”Ÿæˆå ±å‘Šã€æŒ‰éˆ•æŸ¥çœ‹è©³ç´°å ±å‘Š
            </div>
        </div>

        <!-- ç³»çµ±æ—¥èªŒ -->
        <div class="card">
            <h2>ç³»çµ±æ—¥èªŒ</h2>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script type="module">
        import { performanceOptimizer } from './js/large-file/performance-optimizer.js';

        // UI å…ƒç´ 
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const resetBtn = document.getElementById('resetBtn');
        const reportBtn = document.getElementById('reportBtn');
        const logDiv = document.getElementById('log');

        // ç›£æ§ç‹€æ…‹
        let isMonitoring = false;
        let updateTimer = null;

        // é–‹å§‹ç›£æ§
        startBtn.addEventListener('click', async () => {
            await performanceOptimizer.startMonitoring();
            isMonitoring = true;
            startBtn.disabled = true;
            stopBtn.disabled = false;
            addLog('ğŸŸ¢ æ•ˆèƒ½ç›£æ§å·²å•Ÿå‹•');
            
            // é–‹å§‹å®šæœŸæ›´æ–° UI
            updateTimer = setInterval(updateMetrics, 1000);
        });

        // åœæ­¢ç›£æ§
        stopBtn.addEventListener('click', () => {
            performanceOptimizer.stopMonitoring();
            isMonitoring = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            addLog('ğŸ”´ æ•ˆèƒ½ç›£æ§å·²åœæ­¢');
            
            if (updateTimer) {
                clearInterval(updateTimer);
                updateTimer = null;
            }
        });

        // é‡ç½®æŒ‡æ¨™
        resetBtn.addEventListener('click', () => {
            performanceOptimizer.resetMetrics();
            addLog('ğŸ”„ æ•ˆèƒ½æŒ‡æ¨™å·²é‡ç½®');
            updateMetrics();
        });

        // ç”Ÿæˆå ±å‘Š
        reportBtn.addEventListener('click', () => {
            const report = performanceOptimizer.generateReport();
            document.getElementById('report').textContent = JSON.stringify(report, null, 2);
            addLog('ğŸ“Š æ•ˆèƒ½å ±å‘Šå·²ç”Ÿæˆ');
        });

        // æ›´æ–°æŒ‡æ¨™é¡¯ç¤º
        function updateMetrics() {
            const summary = performanceOptimizer.getMetricsSummary();
            
            // æ›´æ–°è¨˜æ†¶é«”ä½¿ç”¨ç‡
            const memoryCard = document.querySelector('.metric-card:nth-child(1)');
            const memoryUsage = summary.memoryUsage.avgUsage * 100;
            document.getElementById('memoryUsage').textContent = `${memoryUsage.toFixed(1)}%`;
            document.getElementById('memoryTrend').textContent = `è¶¨å‹¢: ${summary.memoryUsage.trend}`;
            
            // æ›´æ–°å¡ç‰‡ç‹€æ…‹
            memoryCard.classList.remove('success', 'warning', 'danger');
            if (summary.memoryUsage.status === 'critical') {
                memoryCard.classList.add('danger');
            } else if (summary.memoryUsage.status === 'warning') {
                memoryCard.classList.add('warning');
            } else {
                memoryCard.classList.add('success');
            }
            
            // æ›´æ–° Worker æ•ˆç‡
            const workerCard = document.querySelector('.metric-card:nth-child(2)');
            const workerEfficiency = summary.workerPerformance.avgEfficiency * 100;
            document.getElementById('workerEfficiency').textContent = `${workerEfficiency.toFixed(1)}%`;
            document.getElementById('workerCount').textContent = `æœ€ä½³ Workers: ${summary.workerPerformance.optimalWorkerCount}`;
            
            workerCard.classList.remove('success', 'warning', 'danger');
            if (summary.workerPerformance.status === 'poor') {
                workerCard.classList.add('warning');
            } else {
                workerCard.classList.add('success');
            }
            
            // æ›´æ–°ååé‡
            const throughputCard = document.querySelector('.metric-card:nth-child(3)');
            const throughput = summary.throughput.avgThroughput / 1024 / 1024;
            document.getElementById('throughput').textContent = throughput.toFixed(2);
            
            throughputCard.classList.remove('success', 'warning', 'danger');
            if (summary.throughput.status === 'poor') {
                throughputCard.classList.add('warning');
            } else {
                throughputCard.classList.add('success');
            }
            
            // æ›´æ–° API å»¶é²
            const latencyCard = document.querySelector('.metric-card:nth-child(4)');
            const latency = summary.apiLatency.avgLatency;
            document.getElementById('apiLatency').textContent = latency.toFixed(0);
            
            latencyCard.classList.remove('success', 'warning', 'danger');
            if (summary.apiLatency.status === 'poor') {
                latencyCard.classList.add('danger');
            } else {
                latencyCard.classList.add('success');
            }
            
            // æ›´æ–°å„ªåŒ–å»ºè­°
            updateRecommendations(summary.recommendations);
        }

        // æ›´æ–°å„ªåŒ–å»ºè­°
        function updateRecommendations(recommendations) {
            const recDiv = document.getElementById('recommendations');
            recDiv.innerHTML = '';
            
            let hasRecommendations = false;
            
            if (recommendations.workerCount !== null) {
                hasRecommendations = true;
                recDiv.innerHTML += `
                    <div class="recommendation-item">
                        <strong>Worker æ•¸é‡å„ªåŒ–ï¼š</strong>
                        å»ºè­°èª¿æ•´ç‚º ${recommendations.workerCount} å€‹ Workers
                    </div>
                `;
            }
            
            if (recommendations.chunkSize !== null) {
                hasRecommendations = true;
                const size = recommendations.chunkSize / 1024 / 1024;
                recDiv.innerHTML += `
                    <div class="recommendation-item">
                        <strong>å€å¡Šå¤§å°å„ªåŒ–ï¼š</strong>
                        å»ºè­°èª¿æ•´ç‚º ${size.toFixed(1)} MB
                    </div>
                `;
            }
            
            if (recommendations.bufferSize !== null) {
                hasRecommendations = true;
                recDiv.innerHTML += `
                    <div class="recommendation-item">
                        <strong>ç·©è¡å€å„ªåŒ–ï¼š</strong>
                        å»ºè­°${recommendations.bufferSize === 'reduce' ? 'æ¸›å°' : 'å¢åŠ '}ç·©è¡å€å¤§å°
                    </div>
                `;
            }
            
            if (recommendations.cacheStrategy !== null) {
                hasRecommendations = true;
                recDiv.innerHTML += `
                    <div class="recommendation-item">
                        <strong>å¿«å–ç­–ç•¥å„ªåŒ–ï¼š</strong>
                        å»ºè­°ä½¿ç”¨${recommendations.cacheStrategy === 'aggressive' ? 'ç©æ¥µ' : 'å¹³è¡¡'}çš„å¿«å–æ¸…ç†ç­–ç•¥
                    </div>
                `;
            }
            
            if (!hasRecommendations) {
                recDiv.innerHTML = '<p>ç›®å‰ç³»çµ±é‹ä½œæ­£å¸¸ï¼Œæš«ç„¡å„ªåŒ–å»ºè­°</p>';
            }
        }

        // æ·»åŠ æ—¥èªŒ
        function addLog(message) {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // ç›£è½å„ªåŒ–äº‹ä»¶
        window.addEventListener('performance-optimization', (event) => {
            addLog('âš¡ æ”¶åˆ°æ•ˆèƒ½å„ªåŒ–å»ºè­°');
        });

        // æ¨¡æ“¬å‡½æ•¸
        window.simulateHighMemory = function() {
            // æ¨¡æ“¬é«˜è¨˜æ†¶é«”ä½¿ç”¨
            const largeArray = new Array(10000000).fill(0);
            performanceOptimizer.collectMetrics();
            addLog('ğŸ”´ æ¨¡æ“¬é«˜è¨˜æ†¶é«”ä½¿ç”¨');
            setTimeout(() => {
                // é‡‹æ”¾è¨˜æ†¶é«”
                largeArray.length = 0;
            }, 5000);
        };

        window.simulateLowThroughput = function() {
            // æ¨¡æ“¬ä½ååé‡
            performanceOptimizer.recordProcessingPerformance({
                fileSize: 1024 * 1024,  // 1MB
                duration: 10000,         // 10ç§’
                chunkCount: 10,
            });
            addLog('ğŸŸ¡ æ¨¡æ“¬ä½ååé‡è™•ç†');
        };

        window.simulateWorkerErrors = function() {
            // æ¨¡æ“¬ Worker éŒ¯èª¤
            for (let i = 0; i < 5; i++) {
                performanceOptimizer.recordWorkerPerformance(`worker-${i}`, {
                    type: 'error',
                });
            }
            addLog('ğŸ”´ æ¨¡æ“¬ Worker éŒ¯èª¤');
        };

        window.simulateHighLatency = function() {
            // æ¨¡æ“¬é«˜ API å»¶é²
            performanceOptimizer.metrics.apiLatency.push({
                timestamp: Date.now(),
                duration: 8000,  // 8ç§’
                transferSize: 1024 * 1024,
            });
            addLog('ğŸŸ¡ æ¨¡æ“¬é«˜ API å»¶é²');
        };

        window.simulateNormalOperation = function() {
            // æ¨¡æ“¬æ­£å¸¸é‹ä½œ
            for (let i = 0; i < 3; i++) {
                performanceOptimizer.recordWorkerPerformance(`worker-${i}`, {
                    type: 'task_complete',
                    duration: 1000 + Math.random() * 2000,
                });
            }
            
            performanceOptimizer.recordProcessingPerformance({
                fileSize: 10 * 1024 * 1024,  // 10MB
                duration: 5000,               // 5ç§’
                chunkCount: 10,
            });
            
            addLog('ğŸŸ¢ æ¨¡æ“¬æ­£å¸¸é‹ä½œ');
        };

        // åˆå§‹åŒ–
        addLog('ğŸš€ æ•ˆèƒ½å„ªåŒ–å™¨æ¸¬è©¦é é¢å·²è¼‰å…¥');
    </script>
</body>
</html>