<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>進度顯示修復測試</title>
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/progress.css">
  <style>
    body {
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    
    .test-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .test-button {
      padding: 10px 20px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    
    .test-button:hover {
      opacity: 0.8;
    }
    
    .log {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 15px;
      margin-top: 20px;
      min-height: 200px;
      font-family: monospace;
      font-size: 0.9rem;
      white-space: pre-wrap;
      overflow-y: auto;
      max-height: 400px;
    }
    
    .error {
      color: var(--error-color);
    }
    
    .success {
      color: var(--success-color);
    }
  </style>
</head>
<body>
  <h1>進度顯示修復測試</h1>
  
  <div class="test-section">
    <h2>測試進度管理器</h2>
    <button class="test-button" onclick="testProgressManager()">測試進度管理器</button>
    <button class="test-button" onclick="testShowProcessingProgress()">測試處理進度</button>
    <button class="test-button" onclick="testPreloadIndicator()">測試預載入指示器</button>
    <button class="test-button" onclick="testFullIntegration()">完整整合測試</button>
    <button class="test-button" onclick="clearLog()">清除日誌</button>
    
    <div class="log" id="log"></div>
  </div>
  
  <div class="test-section">
    <h2>檔案上傳測試</h2>
    <input type="file" id="fileInput" accept="audio/*,video/*">
    <button class="test-button" onclick="testFileUpload()">測試檔案處理</button>
  </div>
  
  <script type="module">
    import { progressManager, showProcessingProgress } from '../js/progress-manager.js';
    import { preloadIndicator } from '../js/preload-indicator.js';
    import { WhisperWASMManager } from '../js/wasm/whisper-wasm-manager.js';
    
    function log(message, type = 'info') {
      const logEl = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString('zh-TW');
      const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
      logEl.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }
    
    window.log = log;
    
    // 測試進度管理器
    window.testProgressManager = function() {
      log('開始測試進度管理器...');
      
      try {
        const progress = progressManager.showProgress({
          title: '測試進度',
          message: '正在測試進度管理器...',
          stages: ['階段一', '階段二', '階段三'],
          cancellable: true,
          onCancel: () => {
            log('進度被取消');
          }
        });
        
        log('進度管理器創建成功', 'success');
        
        // 模擬進度更新
        let currentProgress = 0;
        const interval = setInterval(() => {
          currentProgress += 10;
          progress.update(currentProgress, `進度: ${currentProgress}%`);
          
          if (currentProgress >= 100) {
            clearInterval(interval);
            progress.complete('測試完成！');
            log('進度管理器測試完成', 'success');
          }
        }, 300);
        
      } catch (error) {
        log(`錯誤: ${error.message}`, 'error');
        console.error(error);
      }
    };
    
    // 測試處理進度
    window.testShowProcessingProgress = function() {
      log('開始測試處理進度...');
      
      try {
        const progress = showProcessingProgress(
          '音訊轉譯處理',
          ['準備檔案', '執行轉譯', '處理結果'],
          () => {
            log('處理被取消');
          }
        );
        
        log('處理進度創建成功', 'success');
        
        // 模擬階段進度
        setTimeout(() => {
          progress.setStage(0);
          progress.update(33, '檔案準備中...');
        }, 500);
        
        setTimeout(() => {
          progress.setStage(1);
          progress.update(66, '正在轉譯...');
        }, 1500);
        
        setTimeout(() => {
          progress.setStage(2);
          progress.update(100, '處理完成');
          progress.complete();
          log('處理進度測試完成', 'success');
        }, 2500);
        
      } catch (error) {
        log(`錯誤: ${error.message}`, 'error');
        console.error(error);
      }
    };
    
    // 測試預載入指示器
    window.testPreloadIndicator = function() {
      log('開始測試預載入指示器...');
      
      try {
        // 顯示指示器
        preloadIndicator.show();
        log('預載入指示器顯示成功', 'success');
        
        // 更新一些模型狀態
        preloadIndicator.updatePreloadItem('tiny', 'loading', 30, 75 * 1024 * 1024);
        
        setTimeout(() => {
          preloadIndicator.updatePreloadItem('tiny', 'loading', 60, 75 * 1024 * 1024);
        }, 1000);
        
        setTimeout(() => {
          preloadIndicator.updatePreloadItem('tiny', 'complete', 100, 75 * 1024 * 1024);
          log('預載入指示器測試完成', 'success');
        }, 2000);
        
      } catch (error) {
        log(`錯誤: ${error.message}`, 'error');
        console.error(error);
      }
    };
    
    // 完整整合測試
    window.testFullIntegration = async function() {
      log('開始完整整合測試...');
      
      try {
        // 創建 WASM 管理器
        const wasmManager = new WhisperWASMManager();
        log('WASM 管理器創建成功', 'success');
        
        // 測試進度顯示
        const progress = showProcessingProgress(
          '完整測試',
          ['初始化', '載入模型', '完成'],
          () => log('測試取消')
        );
        
        progress.setStage(0);
        progress.update(20, '正在初始化...');
        
        setTimeout(() => {
          progress.setStage(1);
          progress.update(60, '載入模型中...');
        }, 1000);
        
        setTimeout(() => {
          progress.setStage(2);
          progress.update(100, '測試完成');
          progress.complete();
          log('完整整合測試成功', 'success');
        }, 2000);
        
      } catch (error) {
        log(`錯誤: ${error.message}`, 'error');
        console.error(error);
      }
    };
    
    // 檔案上傳測試
    window.testFileUpload = function() {
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];
      
      if (!file) {
        log('請先選擇檔案', 'error');
        return;
      }
      
      log(`檔案: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
      
      // 模擬處理流程
      const progress = showProcessingProgress(
        '檔案處理',
        ['讀取檔案', '分析音訊', '準備轉譯'],
        () => log('處理取消')
      );
      
      let stage = 0;
      const stages = [
        { percent: 33, message: '正在讀取檔案...' },
        { percent: 66, message: '正在分析音訊...' },
        { percent: 100, message: '準備完成' }
      ];
      
      function nextStage() {
        if (stage < stages.length) {
          progress.setStage(stage);
          progress.update(stages[stage].percent, stages[stage].message);
          stage++;
          
          if (stage < stages.length) {
            setTimeout(nextStage, 1000);
          } else {
            setTimeout(() => {
              progress.complete();
              log('檔案處理測試完成', 'success');
            }, 500);
          }
        }
      }
      
      nextStage();
    };
    
    // 清除日誌
    window.clearLog = function() {
      document.getElementById('log').innerHTML = '';
    };
    
    // 頁面載入完成提示
    document.addEventListener('DOMContentLoaded', () => {
      log('測試頁面載入完成，可以開始測試');
      
      // 檢查各模組是否正確載入
      if (typeof progressManager !== 'undefined') {
        log('✓ progressManager 載入成功', 'success');
      } else {
        log('✗ progressManager 載入失敗', 'error');
      }
      
      if (typeof preloadIndicator !== 'undefined') {
        log('✓ preloadIndicator 載入成功', 'success');
      } else {
        log('✗ preloadIndicator 載入失敗', 'error');
      }
      
      if (typeof WhisperWASMManager !== 'undefined') {
        log('✓ WhisperWASMManager 載入成功', 'success');
      } else {
        log('✗ WhisperWASMManager 載入失敗', 'error');
      }
    });
  </script>
</body>
</html>