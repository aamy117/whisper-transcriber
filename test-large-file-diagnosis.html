<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§æª”æ¡ˆè™•ç†è¨ºæ–·</title>
    
    <!-- å¼•å…¥å°ˆæ¡ˆæ¨£å¼ -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/dialog.css">
    <link rel="stylesheet" href="css/notification.css">
    <link rel="stylesheet" href="css/preprocessing.css">
    
    <style>
        .test-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
        }
        
        .test-header {
            text-align: center;
            padding: 2rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        
        .test-section {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 3rem;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            margin-top: 1rem;
        }
        
        .upload-area:hover {
            border-color: var(--primary-color);
            background: var(--bg-tertiary);
        }
        
        .upload-area.dragover {
            border-color: var(--success-color);
            background: rgba(34, 197, 94, 0.1);
        }
        
        #fileInput {
            display: none;
        }
        
        .diagnosis-log {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 1rem;
            height: 500px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.85rem;
            margin-top: 1rem;
        }
        
        .log-entry {
            padding: 0.5rem;
            border-bottom: 1px solid var(--border-lighter);
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }
        
        .log-time {
            color: var(--text-tertiary);
            min-width: 80px;
        }
        
        .log-level {
            min-width: 60px;
            font-weight: 600;
        }
        
        .log-info { color: var(--text-secondary); }
        .log-success { color: var(--success-color); }
        .log-error { color: var(--error-color); }
        .log-warning { color: var(--warning-color); }
        
        .log-message {
            flex: 1;
            word-break: break-word;
        }
        
        .test-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .file-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .info-card {
            background: var(--bg-tertiary);
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        
        .info-card h4 {
            margin: 0 0 0.5rem 0;
            color: var(--primary-color);
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 0.25rem 0;
        }
        
        .info-label {
            color: var(--text-secondary);
        }
        
        .info-value {
            font-weight: 500;
        }
        
        .step-indicator {
            display: flex;
            gap: 1rem;
            margin: 1rem 0;
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 6px;
        }
        
        .step {
            flex: 1;
            text-align: center;
            padding: 0.5rem;
            border-radius: 4px;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            transition: all 0.3s;
        }
        
        .step.active {
            border-color: var(--primary-color);
            background: rgba(37, 99, 235, 0.1);
        }
        
        .step.completed {
            border-color: var(--success-color);
            background: rgba(34, 197, 94, 0.1);
        }
        
        .step.failed {
            border-color: var(--error-color);
            background: rgba(239, 68, 68, 0.1);
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>ğŸ” å¤§æª”æ¡ˆè™•ç†è¨ºæ–·å·¥å…·</h1>
            <p>è©³ç´°è¨ºæ–·å¤§æª”æ¡ˆè½‰è­¯æµç¨‹ï¼Œæ‰¾å‡ºå•é¡Œæ‰€åœ¨</p>
        </div>

        <!-- æª”æ¡ˆä¸Šå‚³ -->
        <div class="test-section">
            <h3>ä¸Šå‚³æ¸¬è©¦æª”æ¡ˆ</h3>
            <div class="upload-area" id="uploadArea">
                <p>ğŸµ æ‹–æ”¾æ‚¨çš„å¤§éŸ³è¨Šæª”æ¡ˆåˆ°æ­¤è™•</p>
                <p>æˆ–é»æ“Šé¸æ“‡æª”æ¡ˆï¼ˆå»ºè­°ä½¿ç”¨è¶…é 25MB çš„æª”æ¡ˆï¼‰</p>
                <input type="file" id="fileInput" accept="audio/*">
            </div>
            
            <div class="file-info-grid" id="fileInfoGrid" style="display: none;">
                <div class="info-card">
                    <h4>æª”æ¡ˆè³‡è¨Š</h4>
                    <div class="info-item">
                        <span class="info-label">åç¨±ï¼š</span>
                        <span class="info-value" id="fileName">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">å¤§å°ï¼š</span>
                        <span class="info-value" id="fileSize">-</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">é¡å‹ï¼š</span>
                        <span class="info-value" id="fileType">-</span>
                    </div>
                </div>
                <div class="info-card">
                    <h4>éŸ³è¨Šå±¬æ€§</h4>
                    <div class="info-item">
                        <span class="info-label">æ™‚é•·ï¼š</span>
                        <span class="info-value" id="duration">æª¢æ¸¬ä¸­...</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">å¯æ’­æ”¾ï¼š</span>
                        <span class="info-value" id="playable">æª¢æ¸¬ä¸­...</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">è§£ç¢¼æ”¯æ´ï¼š</span>
                        <span class="info-value" id="decodable">æª¢æ¸¬ä¸­...</span>
                    </div>
                </div>
            </div>
            
            <div class="test-buttons">
                <button class="btn btn-primary" id="testFullFlowBtn" disabled>æ¸¬è©¦å®Œæ•´æµç¨‹</button>
                <button class="btn btn-secondary" id="testSplitOnlyBtn" disabled>åªæ¸¬è©¦åˆ†å‰²</button>
                <button class="btn btn-secondary" id="testCompressOnlyBtn" disabled>åªæ¸¬è©¦å£“ç¸®</button>
                <button class="btn btn-secondary" id="clearLogBtn">æ¸…é™¤æ—¥èªŒ</button>
            </div>
        </div>

        <!-- æµç¨‹æŒ‡ç¤ºå™¨ -->
        <div class="test-section" id="stepIndicatorSection" style="display: none;">
            <h3>è™•ç†æµç¨‹</h3>
            <div class="step-indicator">
                <div class="step" id="step1">
                    <strong>1. æª”æ¡ˆæª¢æŸ¥</strong>
                    <div>æª¢æŸ¥æª”æ¡ˆå¤§å°å’Œæ ¼å¼</div>
                </div>
                <div class="step" id="step2">
                    <strong>2. é¸æ“‡æ–¹å¼</strong>
                    <div>æœ¬åœ°æˆ– API è½‰è­¯</div>
                </div>
                <div class="step" id="step3">
                    <strong>3. è™•ç†ç­–ç•¥</strong>
                    <div>åˆ†å‰²/å£“ç¸®/æ··åˆ</div>
                </div>
                <div class="step" id="step4">
                    <strong>4. åŸ·è¡Œè™•ç†</strong>
                    <div>è™•ç†éŸ³è¨Šæª”æ¡ˆ</div>
                </div>
                <div class="step" id="step5">
                    <strong>5. å®Œæˆ</strong>
                    <div>è¿”å›è™•ç†çµæœ</div>
                </div>
            </div>
        </div>

        <!-- è¨ºæ–·æ—¥èªŒ -->
        <div class="test-section">
            <h3>è¨ºæ–·æ—¥èªŒ</h3>
            <div class="diagnosis-log" id="diagnosisLog">
                <div class="log-entry">
                    <span class="log-time">00:00:00</span>
                    <span class="log-level log-info">INFO</span>
                    <span class="log-message">è¨ºæ–·å·¥å…·å°±ç·’ï¼Œè«‹ä¸Šå‚³æª”æ¡ˆé–‹å§‹æ¸¬è©¦</span>
                </div>
            </div>
        </div>

        <!-- é€šçŸ¥å®¹å™¨ -->
        <div id="notification-container"></div>
    </div>

    <script type="module">
        import { transcriptionPreprocessor } from './js/transcription-preprocessor.js';
        import { audioSplitter } from './js/audio-splitter.js';
        import { audioCompressor } from './js/audio-compressor.js';
        import { notify } from './js/notification.js';
        
        let currentFile = null;
        let startTime = null;
        
        // æ—¥èªŒåŠŸèƒ½
        function log(message, level = 'info') {
            const logEl = document.getElementById('diagnosisLog');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            
            const time = new Date().toLocaleTimeString();
            const elapsed = startTime ? ((Date.now() - startTime) / 1000).toFixed(2) + 's' : '0.00s';
            
            entry.innerHTML = `
                <span class="log-time">${time}</span>
                <span class="log-level log-${level}">${level.toUpperCase()}</span>
                <span class="log-message">[${elapsed}] ${message}</span>
            `;
            
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        // æ›´æ–°æ­¥é©Ÿç‹€æ…‹
        function updateStep(stepNum, status) {
            const step = document.getElementById(`step${stepNum}`);
            if (step) {
                step.classList.remove('active', 'completed', 'failed');
                step.classList.add(status);
            }
        }
        
        // æ ¼å¼åŒ–æª”æ¡ˆå¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // æ ¼å¼åŒ–æ™‚é–“
        function formatDuration(seconds) {
            if (!seconds || isNaN(seconds)) return 'ç„¡æ³•è®€å–';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        // åˆå§‹åŒ–
        function init() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            // ç¶å®šæª”æ¡ˆä¸Šå‚³
            uploadArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileSelect);
            
            // æ‹–æ”¾æ”¯æ´
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    analyzeFile(files[0]);
                }
            });
            
            // æ¸¬è©¦æŒ‰éˆ•
            document.getElementById('testFullFlowBtn').addEventListener('click', testFullFlow);
            document.getElementById('testSplitOnlyBtn').addEventListener('click', testSplitOnly);
            document.getElementById('testCompressOnlyBtn').addEventListener('click', testCompressOnly);
            document.getElementById('clearLogBtn').addEventListener('click', clearLog);
            
            log('è¨ºæ–·å·¥å…·åˆå§‹åŒ–å®Œæˆ', 'success');
        }
        
        // è™•ç†æª”æ¡ˆé¸æ“‡
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                analyzeFile(file);
            }
        }
        
        // åˆ†ææª”æ¡ˆ
        async function analyzeFile(file) {
            currentFile = file;
            startTime = Date.now();
            
            log(`é–‹å§‹åˆ†ææª”æ¡ˆ: ${file.name}`, 'info');
            
            // é¡¯ç¤ºæª”æ¡ˆè³‡è¨Š
            document.getElementById('fileInfoGrid').style.display = 'grid';
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('fileType').textContent = file.type || 'æœªçŸ¥';
            
            // æª¢æŸ¥æª”æ¡ˆå¤§å°
            if (file.size > 25 * 1024 * 1024) {
                log(`æª”æ¡ˆå¤§å° ${formatFileSize(file.size)} è¶…é 25MB é™åˆ¶`, 'warning');
            } else {
                log(`æª”æ¡ˆå¤§å° ${formatFileSize(file.size)} ç¬¦åˆé™åˆ¶`, 'success');
            }
            
            // æ¸¬è©¦éŸ³è¨Šæ’­æ”¾
            const audio = new Audio();
            const url = URL.createObjectURL(file);
            let canPlay = false;
            let duration = null;
            
            try {
                audio.src = url;
                await new Promise((resolve, reject) => {
                    audio.addEventListener('loadedmetadata', () => {
                        canPlay = true;
                        duration = audio.duration;
                        resolve();
                    });
                    audio.addEventListener('error', reject);
                    setTimeout(reject, 5000);
                });
                
                document.getElementById('duration').textContent = formatDuration(duration);
                document.getElementById('playable').textContent = 'âœ“ å¯ä»¥';
                document.getElementById('playable').style.color = 'var(--success-color)';
                log(`éŸ³è¨Šå¯æ’­æ”¾ï¼Œæ™‚é•·: ${formatDuration(duration)}`, 'success');
                
            } catch (error) {
                document.getElementById('duration').textContent = 'ç„¡æ³•è®€å–';
                document.getElementById('playable').textContent = 'âœ— ä¸å¯';
                document.getElementById('playable').style.color = 'var(--error-color)';
                log(`éŸ³è¨Šç„¡æ³•æ’­æ”¾: ${error.message}`, 'error');
            }
            
            URL.revokeObjectURL(url);
            
            // æ¸¬è©¦ Web Audio API è§£ç¢¼
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const arrayBuffer = await file.arrayBuffer();
                await audioContext.decodeAudioData(arrayBuffer.slice(0));
                
                document.getElementById('decodable').textContent = 'âœ“ æ”¯æ´';
                document.getElementById('decodable').style.color = 'var(--success-color)';
                log('Web Audio API å¯ä»¥è§£ç¢¼æ­¤æª”æ¡ˆ', 'success');
                
                audioContext.close();
            } catch (error) {
                document.getElementById('decodable').textContent = 'âœ— ä¸æ”¯æ´';
                document.getElementById('decodable').style.color = 'var(--error-color)';
                log(`Web Audio API è§£ç¢¼å¤±æ•—: ${error.message}`, 'error');
            }
            
            // å•Ÿç”¨æ¸¬è©¦æŒ‰éˆ•
            document.getElementById('testFullFlowBtn').disabled = false;
            document.getElementById('testSplitOnlyBtn').disabled = false;
            document.getElementById('testCompressOnlyBtn').disabled = false;
            
            // é¡¯ç¤ºæ­¥é©ŸæŒ‡ç¤ºå™¨
            document.getElementById('stepIndicatorSection').style.display = 'block';
        }
        
        // æ¸¬è©¦å®Œæ•´æµç¨‹
        async function testFullFlow() {
            if (!currentFile) return;
            
            startTime = Date.now();
            log('=== é–‹å§‹æ¸¬è©¦å®Œæ•´è½‰è­¯æµç¨‹ ===', 'info');
            
            // é‡ç½®æ­¥é©Ÿç‹€æ…‹
            for (let i = 1; i <= 5; i++) {
                updateStep(i, '');
            }
            
            try {
                // æ­¥é©Ÿ 1: æª”æ¡ˆæª¢æŸ¥
                updateStep(1, 'active');
                log('æ­¥é©Ÿ 1: æª¢æŸ¥æª”æ¡ˆ...', 'info');
                
                if (currentFile.size > 25 * 1024 * 1024) {
                    log(`æª”æ¡ˆå¤§å° ${formatFileSize(currentFile.size)} è¶…éé™åˆ¶ï¼Œéœ€è¦è™•ç†`, 'warning');
                } else {
                    log(`æª”æ¡ˆå¤§å° ${formatFileSize(currentFile.size)} ç¬¦åˆé™åˆ¶`, 'success');
                }
                updateStep(1, 'completed');
                
                // æ­¥é©Ÿ 2: æ¨¡æ“¬é¸æ“‡è½‰è­¯æ–¹å¼
                updateStep(2, 'active');
                log('æ­¥é©Ÿ 2: é¡¯ç¤ºè½‰è­¯æ–¹å¼é¸æ“‡...', 'info');
                
                // æ””æˆªå°è©±æ¡†é¡¯ç¤º
                const originalShowMethod = transcriptionPreprocessor.showTranscriptionMethodChoice;
                transcriptionPreprocessor.showTranscriptionMethodChoice = async (file) => {
                    log('é¡¯ç¤ºè½‰è­¯æ–¹å¼é¸æ“‡å°è©±æ¡†ï¼ˆæ¨¡æ“¬é¸æ“‡ APIï¼‰', 'info');
                    return 'api'; // æ¨¡æ“¬é¸æ“‡ API
                };
                
                // æ””æˆªè™•ç†é¸é …å°è©±æ¡†
                const originalShowOptions = transcriptionPreprocessor.showProcessingOptions;
                transcriptionPreprocessor.showProcessingOptions = async (fileInfo) => {
                    log(`é¡¯ç¤ºè™•ç†é¸é …å°è©±æ¡†ï¼Œæª”æ¡ˆè¶…å‡º ${fileInfo.exceedBy} MB`, 'info');
                    log('æ¨¡æ“¬é¸æ“‡ï¼šåˆ†å‰²ç­–ç•¥', 'info');
                    return 'split'; // æ¨¡æ“¬é¸æ“‡åˆ†å‰²
                };
                
                updateStep(2, 'completed');
                
                // æ­¥é©Ÿ 3-5: åŸ·è¡Œé è™•ç†
                updateStep(3, 'active');
                log('æ­¥é©Ÿ 3: æº–å‚™è½‰è­¯...', 'info');
                
                const result = await transcriptionPreprocessor.prepareForTranscription(currentFile);
                
                log(`é è™•ç†å®Œæˆï¼ç­–ç•¥: ${result.strategy}`, 'success');
                log(`è™•ç†å¾Œæª”æ¡ˆæ•¸: ${result.files ? result.files.length : 1}`, 'info');
                
                if (result.segments) {
                    log('åˆ†æ®µè³‡è¨Š:', 'info');
                    result.segments.forEach((seg, i) => {
                        log(`  æ®µè½ ${i + 1}: ${formatFileSize(seg.size)}, ${formatDuration(seg.duration)}`, 'info');
                    });
                }
                
                if (result.estimatedCost) {
                    log(`é ä¼°è²»ç”¨: $${result.estimatedCost.toFixed(3)} USD`, 'info');
                }
                
                updateStep(3, 'completed');
                updateStep(4, 'completed');
                updateStep(5, 'completed');
                
                log('=== æ¸¬è©¦å®Œæˆï¼Œæµç¨‹æ­£å¸¸ ===', 'success');
                notify.success('å®Œæ•´æµç¨‹æ¸¬è©¦æˆåŠŸï¼');
                
                // æ¢å¾©åŸå§‹æ–¹æ³•
                transcriptionPreprocessor.showTranscriptionMethodChoice = originalShowMethod;
                transcriptionPreprocessor.showProcessingOptions = originalShowOptions;
                
            } catch (error) {
                log(`éŒ¯èª¤: ${error.message}`, 'error');
                log(`å †ç–Š: ${error.stack}`, 'error');
                
                // æ¨™è¨˜å¤±æ•—çš„æ­¥é©Ÿ
                for (let i = 1; i <= 5; i++) {
                    const step = document.getElementById(`step${i}`);
                    if (step && step.classList.contains('active')) {
                        updateStep(i, 'failed');
                    }
                }
                
                notify.error(`æ¸¬è©¦å¤±æ•—: ${error.message}`);
            }
        }
        
        // åªæ¸¬è©¦åˆ†å‰²
        async function testSplitOnly() {
            if (!currentFile) return;
            
            startTime = Date.now();
            log('=== é–‹å§‹æ¸¬è©¦éŸ³è¨Šåˆ†å‰² ===', 'info');
            
            try {
                const result = await audioSplitter.splitAudioFile(currentFile, {
                    maxSize: 20 * 1024 * 1024,
                    overlap: 5,
                    onProgress: (progress) => {
                        log(`åˆ†å‰²é€²åº¦: ${progress.percentage}%`, 'info');
                    }
                });
                
                log(`åˆ†å‰²å®Œæˆï¼ç¸½æ®µæ•¸: ${result.segments.length}`, 'success');
                
                result.segments.forEach((seg, i) => {
                    log(`æ®µè½ ${i + 1}: ${formatFileSize(seg.size)}, ${formatDuration(seg.duration)}`, 'info');
                });
                
                if (result.warning) {
                    log(`è­¦å‘Š: ${result.warning}`, 'warning');
                }
                
                notify.success('éŸ³è¨Šåˆ†å‰²æ¸¬è©¦æˆåŠŸï¼');
                
            } catch (error) {
                log(`åˆ†å‰²å¤±æ•—: ${error.message}`, 'error');
                notify.error(`åˆ†å‰²å¤±æ•—: ${error.message}`);
            } finally {
                audioSplitter.cleanup();
            }
        }
        
        // åªæ¸¬è©¦å£“ç¸®
        async function testCompressOnly() {
            if (!currentFile) return;
            
            startTime = Date.now();
            log('=== é–‹å§‹æ¸¬è©¦éŸ³è¨Šå£“ç¸® ===', 'info');
            
            try {
                const result = await audioCompressor.compressAudioFile(currentFile, {
                    targetSize: 25 * 1024 * 1024,
                    profile: 'auto',
                    onProgress: (progress) => {
                        log(`å£“ç¸®é€²åº¦: ${progress.percentage}%`, 'info');
                    }
                });
                
                log(`å£“ç¸®å®Œæˆï¼`, 'success');
                log(`åŸå§‹å¤§å°: ${formatFileSize(currentFile.size)}`, 'info');
                log(`å£“ç¸®å¾Œå¤§å°: ${formatFileSize(result.compressedSize)}`, 'info');
                log(`å£“ç¸®ç‡: ${(result.compressionRatio * 100).toFixed(1)}%`, 'info');
                
                if (result.warning) {
                    log(`è­¦å‘Š: ${result.warning}`, 'warning');
                }
                
                notify.success('éŸ³è¨Šå£“ç¸®æ¸¬è©¦æˆåŠŸï¼');
                
            } catch (error) {
                log(`å£“ç¸®å¤±æ•—: ${error.message}`, 'error');
                notify.error(`å£“ç¸®å¤±æ•—: ${error.message}`);
            } finally {
                audioCompressor.cleanup();
            }
        }
        
        // æ¸…é™¤æ—¥èªŒ
        function clearLog() {
            const logEl = document.getElementById('diagnosisLog');
            logEl.innerHTML = `
                <div class="log-entry">
                    <span class="log-time">${new Date().toLocaleTimeString()}</span>
                    <span class="log-level log-info">INFO</span>
                    <span class="log-message">æ—¥èªŒå·²æ¸…é™¤</span>
                </div>
            `;
        }
        
        // å•Ÿå‹•
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>