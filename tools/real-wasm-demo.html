<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çœŸå¯¦ WASM è½‰è­¯ç¤ºç¯„</title>
    
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/notification.css">
    
    <style>
        .demo-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
        }
        
        .demo-header {
            text-align: center;
            padding: 2rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        
        .demo-section {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 3rem;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            margin: 1rem 0;
        }
        
        .upload-area:hover {
            border-color: var(--primary-color);
            background: var(--bg-tertiary);
        }
        
        .upload-area.dragover {
            border-color: var(--success-color);
            background: rgba(34, 197, 94, 0.1);
        }
        
        #fileInput {
            display: none;
        }
        
        .status-box {
            background: var(--bg-tertiary);
            padding: 1.5rem;
            border-radius: 6px;
            margin: 1rem 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: var(--bg-primary);
            border-radius: 15px;
            overflow: hidden;
            margin: 1rem 0;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 500;
        }
        
        .result-box {
            background: var(--bg-tertiary);
            padding: 1.5rem;
            border-radius: 6px;
            margin: 1rem 0;
            display: none;
        }
        
        .result-text {
            white-space: pre-wrap;
            font-family: inherit;
            line-height: 1.6;
        }
        
        .model-selector {
            margin: 1rem 0;
        }
        
        .model-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 0.5rem;
        }
        
        .model-option {
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        
        .model-option:hover {
            border-color: var(--primary-color);
            background: var(--bg-tertiary);
        }
        
        .model-option.selected {
            border-color: var(--primary-color);
            background: rgba(37, 99, 235, 0.1);
        }
        
        .model-size {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .warning-box {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 6px;
            padding: 1rem;
            margin: 1rem 0;
            color: var(--warning-color);
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <div class="demo-header">
            <h1>ğŸ™ï¸ çœŸå¯¦ WASM è½‰è­¯ç¤ºç¯„</h1>
            <p>ä½¿ç”¨ OpenAI Whisper çš„é–‹æºå¯¦ç¾é€²è¡Œæœ¬åœ°èªéŸ³è­˜åˆ¥</p>
        </div>

        <div class="warning-box">
            <strong>âš ï¸ æ³¨æ„ï¼š</strong>çœŸå¯¦çš„ Whisper WASM éœ€è¦ä¸‹è¼‰å¤§å‹æ¨¡å‹æª”æ¡ˆï¼ˆ39MB-244MBï¼‰ï¼Œ
            é¦–æ¬¡è¼‰å…¥å¯èƒ½éœ€è¦è¼ƒé•·æ™‚é–“ã€‚æ­¤ç¤ºç¯„ä½¿ç”¨æ›¿ä»£æ–¹æ¡ˆå±•ç¤ºæ¦‚å¿µã€‚
        </div>

        <!-- æ¨¡å‹é¸æ“‡ -->
        <div class="demo-section">
            <h3>é¸æ“‡æ¨¡å‹</h3>
            <div class="model-options">
                <div class="model-option selected" data-model="tiny">
                    <strong>Tiny</strong>
                    <div class="model-size">39 MB</div>
                    <div>æœ€å¿«é€Ÿåº¦</div>
                </div>
                <div class="model-option" data-model="base">
                    <strong>Base</strong>
                    <div class="model-size">74 MB</div>
                    <div>å¹³è¡¡é¸æ“‡</div>
                </div>
                <div class="model-option" data-model="small">
                    <strong>Small</strong>
                    <div class="model-size">244 MB</div>
                    <div>æœ€ä½³å“è³ª</div>
                </div>
            </div>
        </div>

        <!-- æª”æ¡ˆä¸Šå‚³ -->
        <div class="demo-section">
            <h3>ä¸Šå‚³éŸ³è¨Šæª”æ¡ˆ</h3>
            <div class="upload-area" id="uploadArea">
                <p>ğŸµ æ‹–æ”¾éŸ³è¨Šæª”æ¡ˆåˆ°æ­¤è™•</p>
                <p>æˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ</p>
                <input type="file" id="fileInput" accept="audio/*">
            </div>
            
            <button class="btn btn-primary" id="transcribeBtn" style="display: none;">
                é–‹å§‹è½‰è­¯
            </button>
        </div>

        <!-- ç‹€æ…‹é¡¯ç¤º -->
        <div class="demo-section" id="statusSection" style="display: none;">
            <h3>è™•ç†ç‹€æ…‹</h3>
            <div class="status-box">
                <div id="statusText">æº–å‚™ä¸­...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar">0%</div>
                </div>
            </div>
        </div>

        <!-- çµæœé¡¯ç¤º -->
        <div class="demo-section">
            <h3>è½‰è­¯çµæœ</h3>
            <div class="result-box" id="resultBox">
                <div class="result-text" id="resultText"></div>
            </div>
        </div>

        <!-- å¯¦ç¾èªªæ˜ -->
        <div class="demo-section">
            <h3>ğŸ“– å¯¦ç¾èªªæ˜</h3>
            <p>çœŸå¯¦çš„ Whisper WASM å¯¦ç¾éœ€è¦ï¼š</p>
            <ol>
                <li><strong>whisper.cpp WASM ç‰ˆæœ¬</strong> - C++ å¯¦ç¾çš„ WebAssembly ç·¨è­¯ç‰ˆ</li>
                <li><strong>GGML æ¨¡å‹æª”æ¡ˆ</strong> - é‡åŒ–å¾Œçš„æ¨¡å‹æ¬Šé‡</li>
                <li><strong>éŸ³è¨Šé è™•ç†</strong> - è½‰æ›ç‚º 16kHz å–®è²é“ PCM</li>
                <li><strong>Web Worker</strong> - é¿å…é˜»å¡ä¸»åŸ·è¡Œç·’</li>
            </ol>
            
            <h4>å¯ç”¨çš„å¯¦ç¾æ–¹æ¡ˆï¼š</h4>
            <ul>
                <li><a href="https://github.com/ggerganov/whisper.cpp" target="_blank">whisper.cpp</a> - åŸå§‹ C++ å¯¦ç¾</li>
                <li><a href="https://github.com/xenova/whisper-web" target="_blank">whisper-web</a> - ç€è¦½å™¨å„ªåŒ–ç‰ˆ</li>
                <li><a href="https://huggingface.co/spaces/Xenova/whisper-web" target="_blank">HuggingFace ç·šä¸Šç¤ºç¯„</a></li>
            </ul>
        </div>

        <!-- é€šçŸ¥å®¹å™¨ -->
        <div id="notification-container"></div>
    </div>

    <script type="module">
        import { notify } from './js/notification.js';
        
        let currentFile = null;
        let selectedModel = 'tiny';
        
        // æ¨¡æ“¬çš„è½‰è­¯å¯¦ç¾ï¼ˆå±•ç¤ºæ¦‚å¿µï¼‰
        class WhisperWASMDemo {
            async initialize(model) {
                notify.info(`æ­£åœ¨è¼‰å…¥ ${model} æ¨¡å‹...`);
                
                // æ¨¡æ“¬è¼‰å…¥æ™‚é–“
                await this.simulateProgress('è¼‰å…¥æ¨¡å‹', 3000);
                
                notify.success('æ¨¡å‹è¼‰å…¥å®Œæˆï¼');
            }
            
            async transcribe(audioFile) {
                const steps = [
                    { name: 'è®€å–éŸ³è¨Šæª”æ¡ˆ', duration: 1000 },
                    { name: 'è½‰æ›éŸ³è¨Šæ ¼å¼', duration: 1500 },
                    { name: 'åŸ·è¡ŒèªéŸ³è­˜åˆ¥', duration: 5000 },
                    { name: 'å¾Œè™•ç†çµæœ', duration: 500 }
                ];
                
                let totalProgress = 0;
                const totalDuration = steps.reduce((sum, step) => sum + step.duration, 0);
                
                for (const step of steps) {
                    await this.simulateProgress(step.name, step.duration, totalProgress / totalDuration);
                    totalProgress += step.duration;
                }
                
                // ç”Ÿæˆç¤ºç¯„çµæœ
                return {
                    text: this.generateDemoText(),
                    segments: this.generateDemoSegments(),
                    language: 'zh',
                    duration: 60
                };
            }
            
            async simulateProgress(message, duration, startProgress = 0) {
                const statusEl = document.getElementById('statusText');
                const progressBar = document.getElementById('progressBar');
                const steps = 20;
                const stepDuration = duration / steps;
                
                for (let i = 0; i <= steps; i++) {
                    const progress = startProgress + (i / steps) * (1 - startProgress);
                    const percentage = Math.round(progress * 100);
                    
                    statusEl.textContent = `${message}... ${percentage}%`;
                    progressBar.style.width = percentage + '%';
                    progressBar.textContent = percentage + '%';
                    
                    await new Promise(resolve => setTimeout(resolve, stepDuration));
                }
            }
            
            generateDemoText() {
                return `é€™æ˜¯ä¸€å€‹çœŸå¯¦ WASM è½‰è­¯çš„ç¤ºç¯„å¯¦ç¾ã€‚

åœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œé€™è£¡æœƒé¡¯ç¤ºæ‚¨éŸ³è¨Šæª”æ¡ˆçš„çœŸå¯¦è½‰è­¯çµæœã€‚
Whisper æ¨¡å‹èƒ½å¤ è­˜åˆ¥å¤šç¨®èªè¨€ï¼ŒåŒ…æ‹¬ä¸­æ–‡ã€è‹±æ–‡ã€æ—¥æ–‡ç­‰ã€‚

è½‰è­¯çš„æº–ç¢ºåº¦å–æ±ºæ–¼ï¼š
1. é¸æ“‡çš„æ¨¡å‹å¤§å°ï¼ˆtinyã€baseã€smallï¼‰
2. éŸ³è¨Šçš„å“è³ªå’Œæ¸…æ™°åº¦
3. èƒŒæ™¯å™ªéŸ³çš„ç¨‹åº¦

ä½¿ç”¨æœ¬åœ° WASM çš„å„ªé»æ˜¯ï¼š
- å®Œå…¨é›¢ç·šé‹è¡Œï¼Œä¿è­·éš±ç§
- ç„¡éœ€ API è²»ç”¨
- ä¸å—ç¶²è·¯é™åˆ¶

ç¼ºé»æ˜¯ï¼š
- éœ€è¦ä¸‹è¼‰æ¨¡å‹æª”æ¡ˆ
- è™•ç†é€Ÿåº¦è¼ƒ API æ…¢
- ä½”ç”¨è¼ƒå¤šè¨˜æ†¶é«”`;
            }
            
            generateDemoSegments() {
                const segments = [
                    { start: 0, end: 5, text: "é€™æ˜¯ä¸€å€‹çœŸå¯¦ WASM è½‰è­¯çš„ç¤ºç¯„å¯¦ç¾ã€‚" },
                    { start: 5, end: 10, text: "åœ¨å¯¦éš›æ‡‰ç”¨ä¸­ï¼Œé€™è£¡æœƒé¡¯ç¤ºæ‚¨éŸ³è¨Šæª”æ¡ˆçš„çœŸå¯¦è½‰è­¯çµæœã€‚" },
                    { start: 10, end: 15, text: "Whisper æ¨¡å‹èƒ½å¤ è­˜åˆ¥å¤šç¨®èªè¨€ï¼ŒåŒ…æ‹¬ä¸­æ–‡ã€è‹±æ–‡ã€æ—¥æ–‡ç­‰ã€‚" }
                ];
                return segments;
            }
        }
        
        const whisperDemo = new WhisperWASMDemo();
        
        // åˆå§‹åŒ–
        function init() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            
            // æ¨¡å‹é¸æ“‡
            document.querySelectorAll('.model-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.model-option').forEach(o => o.classList.remove('selected'));
                    option.classList.add('selected');
                    selectedModel = option.dataset.model;
                });
            });
            
            // æª”æ¡ˆä¸Šå‚³
            uploadArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', handleFileSelect);
            
            // æ‹–æ”¾
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                if (e.dataTransfer.files[0]) {
                    handleFile(e.dataTransfer.files[0]);
                }
            });
            
            // è½‰è­¯æŒ‰éˆ•
            document.getElementById('transcribeBtn').addEventListener('click', startTranscription);
        }
        
        function handleFileSelect(event) {
            if (event.target.files[0]) {
                handleFile(event.target.files[0]);
            }
        }
        
        function handleFile(file) {
            currentFile = file;
            document.getElementById('transcribeBtn').style.display = 'block';
            notify.success(`å·²é¸æ“‡æª”æ¡ˆ: ${file.name}`);
        }
        
        async function startTranscription() {
            if (!currentFile) return;
            
            const statusSection = document.getElementById('statusSection');
            const resultBox = document.getElementById('resultBox');
            const resultText = document.getElementById('resultText');
            const transcribeBtn = document.getElementById('transcribeBtn');
            
            try {
                // é¡¯ç¤ºç‹€æ…‹
                statusSection.style.display = 'block';
                resultBox.style.display = 'none';
                transcribeBtn.disabled = true;
                
                // åˆå§‹åŒ–æ¨¡å‹
                await whisperDemo.initialize(selectedModel);
                
                // åŸ·è¡Œè½‰è­¯
                const result = await whisperDemo.transcribe(currentFile);
                
                // é¡¯ç¤ºçµæœ
                resultText.textContent = result.text;
                resultBox.style.display = 'block';
                
                notify.success('è½‰è­¯å®Œæˆï¼');
                
            } catch (error) {
                notify.error(`è½‰è­¯å¤±æ•—: ${error.message}`);
            } finally {
                transcribeBtn.disabled = false;
                statusSection.style.display = 'none';
            }
        }
        
        // å•Ÿå‹•
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>