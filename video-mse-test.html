<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSE ä¸²æµæ¸¬è©¦ - Whisper è¦–è¨Šå·¥å…·</title>
    <link rel="stylesheet" href="css/shared.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/video.css">
    <style>
        .test-info {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .test-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .status-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
        
        .status-icon.success {
            background: #10b981;
        }
        
        .status-icon.error {
            background: #ef4444;
        }
        
        .status-icon.warning {
            background: #f59e0b;
        }
        
        .status-icon.info {
            background: #3b82f6;
        }
        
        .streaming-info {
            font-family: monospace;
            background: #f3f4f6;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .progress-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .progress-item {
            background: var(--surface-color);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .progress-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .progress-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .streaming-log {
            max-height: 300px;
            overflow-y: auto;
            background: #1f2937;
            color: #f3f4f6;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.875rem;
            line-height: 1.5;
        }
        
        .log-entry {
            margin: 2px 0;
        }
        
        .log-time {
            color: #9ca3af;
        }
        
        .log-info {
            color: #60a5fa;
        }
        
        .log-success {
            color: #34d399;
        }
        
        .log-error {
            color: #f87171;
        }
        
        .log-warning {
            color: #fbbf24;
        }
    </style>
</head>
<body>
    <!-- å°èˆªåˆ— -->
    <nav class="app-navigation">
        <div class="nav-container">
            <div class="nav-brand">
                <h1 class="nav-title">Whisper å·¥å…·</h1>
            </div>
            <div class="nav-links">
                <a href="index.html" class="nav-link">
                    <span class="nav-icon">ğŸµ</span>
                    <span>éŸ³è¨Šå·¥å…·</span>
                </a>
                <a href="video.html" class="nav-link">
                    <span class="nav-icon">ğŸ¬</span>
                    <span>è¦–è¨Šå·¥å…·</span>
                </a>
                <a href="video-mse-test.html" class="nav-link active">
                    <span class="nav-icon">ğŸ§ª</span>
                    <span>MSE æ¸¬è©¦</span>
                </a>
            </div>
        </div>
    </nav>

    <div id="video-app">
        <header class="app-header">
            <div class="container">
                <h1 class="app-title">MSE ä¸²æµæ¸¬è©¦</h1>
                <nav class="app-nav">
                    <button class="nav-btn" id="themeToggleBtn" title="åˆ‡æ›æ·±è‰²/æ·ºè‰²æ¨¡å¼">
                        <span class="icon icon-light">ğŸŒ</span>
                        <span class="icon icon-dark">ğŸŒ™</span>
                    </button>
                </nav>
            </div>
        </header>

        <main class="video-main">
            <div class="container">
                <!-- MSE æ”¯æ´æª¢æ¸¬ -->
                <div class="test-info">
                    <h2>ç€è¦½å™¨æ”¯æ´æª¢æ¸¬</h2>
                    <div id="supportStatus"></div>
                </div>

                <!-- è¦–è¨Šè¼‰å…¥å€ -->
                <div class="video-layout">
                    <section class="video-section">
                        <!-- ä¸Šå‚³å€åŸŸ -->
                        <div class="video-upload-area" id="videoUploadArea">
                            <div class="upload-content">
                                <span class="upload-icon">ğŸ¬</span>
                                <h2>ä¸Šå‚³å¤§å‹å½±ç‰‡æª”æ¡ˆæ¸¬è©¦ MSE</h2>
                                <p>æ‹–æ”¾æª”æ¡ˆåˆ°æ­¤è™•ï¼Œæˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ</p>
                                <p class="upload-hint">å»ºè­°ä½¿ç”¨ 100MB ä»¥ä¸Šçš„æª”æ¡ˆæ¸¬è©¦ä¸²æµåŠŸèƒ½</p>
                                <input type="file" id="videoInput" accept="video/*" hidden>
                                <button class="btn btn-primary" id="selectVideoBtn">é¸æ“‡æª”æ¡ˆ</button>
                            </div>
                        </div>

                        <!-- è¦–è¨Šæ’­æ”¾å™¨å®¹å™¨ -->
                        <div class="video-player-container hidden" id="videoPlayerContainer">
                            <div class="video-wrapper" id="videoWrapper">
                                <video id="videoPlayer" controls preload="metadata"></video>
                                
                                <!-- è¼‰å…¥æŒ‡ç¤ºå™¨ -->
                                <div class="video-loading hidden" id="videoLoading">
                                    <div class="loading-spinner"></div>
                                    <p class="loading-text">è¼‰å…¥ä¸­...</p>
                                </div>
                            </div>
                            
                            <!-- ä¸²æµè³‡è¨Š -->
                            <div class="streaming-info" id="streamingInfo">
                                è¼‰å…¥æ¨¡å¼ï¼š<span id="loadingMode">-</span>
                            </div>
                        </div>
                    </section>

                    <!-- å³å´ï¼šä¸²æµè³‡è¨Šé¢æ¿ -->
                    <aside class="side-panel">
                        <div class="panel-tabs">
                            <button class="tab-btn active" data-tab="progress">ä¸²æµé€²åº¦</button>
                            <button class="tab-btn" data-tab="log">é™¤éŒ¯æ—¥èªŒ</button>
                        </div>

                        <!-- é€²åº¦é¢æ¿ -->
                        <div class="panel-content active" id="progressPanel">
                            <div class="progress-info">
                                <div class="progress-item">
                                    <div class="progress-label">æª”æ¡ˆå¤§å°</div>
                                    <div class="progress-value" id="fileSize">-</div>
                                </div>
                                <div class="progress-item">
                                    <div class="progress-label">è¼‰å…¥é€²åº¦</div>
                                    <div class="progress-value" id="loadProgress">-</div>
                                </div>
                                <div class="progress-item">
                                    <div class="progress-label">åˆ†å¡Šæ•¸é‡</div>
                                    <div class="progress-value" id="chunkCount">-</div>
                                </div>
                                <div class="progress-item">
                                    <div class="progress-label">ç·©è¡æ™‚é–“</div>
                                    <div class="progress-value" id="bufferedTime">-</div>
                                </div>
                            </div>
                        </div>

                        <!-- æ—¥èªŒé¢æ¿ -->
                        <div class="panel-content hidden" id="logPanel">
                            <div class="streaming-log" id="streamingLog"></div>
                        </div>
                    </aside>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import VideoConfig from './js/video/video-config.js';
        import { VideoPlayer } from './js/video/video-player.js';
        import { VideoUI } from './js/video/video-ui.js';
        import { isMSESupported, getMSESupport } from './js/video/video-streaming.js';
        
        class MSETestApp {
            constructor() {
                this.player = null;
                this.ui = null;
                this.logEntries = [];
                
                this.init();
            }
            
            async init() {
                // ç­‰å¾… DOM è¼‰å…¥
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => this.setup());
                } else {
                    await this.setup();
                }
            }
            
            async setup() {
                try {
                    // æª¢æ¸¬ MSE æ”¯æ´
                    this.checkMSESupport();
                    
                    // åˆå§‹åŒ–æ’­æ”¾å™¨
                    const videoElement = document.getElementById('videoPlayer');
                    this.player = new VideoPlayer(videoElement);
                    this.ui = new VideoUI(this.player);
                    
                    // ç¶å®šäº‹ä»¶
                    this.bindEvents();
                    
                    // è¨­å®šä¸»é¡Œ
                    this.setupTheme();
                    
                    this.log('MSE æ¸¬è©¦æ‡‰ç”¨åˆå§‹åŒ–å®Œæˆ', 'success');
                    
                } catch (error) {
                    console.error('åˆå§‹åŒ–å¤±æ•—:', error);
                    this.log(`åˆå§‹åŒ–å¤±æ•—: ${error.message}`, 'error');
                }
            }
            
            checkMSESupport() {
                const supportStatus = document.getElementById('supportStatus');
                const support = getMSESupport();
                
                if (!support.supported) {
                    supportStatus.innerHTML = `
                        <div class="test-status">
                            <div class="status-icon error"></div>
                            <span>æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ Media Source Extensions</span>
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <div class="test-status">
                        <div class="status-icon success"></div>
                        <span>æ”¯æ´ Media Source Extensions</span>
                    </div>
                `;
                
                // æª¢æŸ¥æ ¼å¼æ”¯æ´
                const formats = support.formats;
                
                if (formats.mp4.h264) {
                    html += `
                        <div class="test-status">
                            <div class="status-icon success"></div>
                            <span>æ”¯æ´ MP4 (H.264)</span>
                        </div>
                    `;
                }
                
                if (formats.webm.vp8 || formats.webm.vp9) {
                    html += `
                        <div class="test-status">
                            <div class="status-icon success"></div>
                            <span>æ”¯æ´ WebM (VP8/VP9)</span>
                        </div>
                    `;
                }
                
                supportStatus.innerHTML = html;
            }
            
            bindEvents() {
                // æª”æ¡ˆé¸æ“‡
                const fileInput = document.getElementById('videoInput');
                const selectBtn = document.getElementById('selectVideoBtn');
                const uploadArea = document.getElementById('videoUploadArea');
                
                selectBtn.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', (e) => this.handleFileSelect(e.target.files));
                
                // æ‹–æ”¾
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('drag-over');
                });
                
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('drag-over');
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('drag-over');
                    this.handleFileSelect(e.dataTransfer.files);
                });
                
                // è¦–è¨Šäº‹ä»¶
                const video = this.player.video;
                video.addEventListener('video:loadeddata', (e) => this.handleVideoLoaded(e.detail));
                video.addEventListener('video:error', (e) => this.handleVideoError(e.detail));
                video.addEventListener('video:streamingprogress', (e) => this.handleStreamingProgress(e.detail));
                video.addEventListener('streaming:progress', (e) => this.handleStreamingProgress(e.detail));
                
                // æ¨™ç±¤åˆ‡æ›
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.switchTab(btn.dataset.tab));
                });
                
                // ä¸»é¡Œåˆ‡æ›
                const themeToggleBtn = document.getElementById('themeToggleBtn');
                if (themeToggleBtn) {
                    themeToggleBtn.addEventListener('click', () => this.toggleTheme());
                }
            }
            
            async handleFileSelect(files) {
                if (!files || files.length === 0) return;
                
                const file = files[0];
                
                this.log(`é¸æ“‡æª”æ¡ˆ: ${file.name} (${this.formatFileSize(file.size)})`, 'info');
                
                // æ›´æ–°æª”æ¡ˆè³‡è¨Š
                document.getElementById('fileSize').textContent = this.formatFileSize(file.size);
                
                try {
                    // é¡¯ç¤ºè¼‰å…¥ä¸­
                    document.getElementById('videoLoading').classList.remove('hidden');
                    
                    // è¼‰å…¥è¦–è¨Š
                    const info = await this.player.loadFile(file);
                    
                    // é¡¯ç¤ºæ’­æ”¾å™¨
                    document.getElementById('videoUploadArea').classList.add('hidden');
                    document.getElementById('videoPlayerContainer').classList.remove('hidden');
                    
                    // æ›´æ–°è¼‰å…¥æ¨¡å¼
                    const loadingMode = this.player.state.isStreaming ? 'ä¸²æµè¼‰å…¥ (MSE)' : 'ç›´æ¥è¼‰å…¥';
                    document.getElementById('loadingMode').textContent = loadingMode;
                    
                    if (this.player.state.isStreaming) {
                        const totalChunks = Math.ceil(file.size / VideoConfig.streaming.chunkSize);
                        document.getElementById('chunkCount').textContent = `0 / ${totalChunks}`;
                        this.log(`ä½¿ç”¨ MSE ä¸²æµè¼‰å…¥ï¼Œå…± ${totalChunks} å€‹åˆ†å¡Š`, 'success');
                    } else {
                        this.log('æª”æ¡ˆå¤§å°æœªé”ä¸²æµé–€æª»ï¼Œä½¿ç”¨ç›´æ¥è¼‰å…¥', 'warning');
                    }
                    
                    // éš±è—è¼‰å…¥ä¸­
                    document.getElementById('videoLoading').classList.add('hidden');
                    
                } catch (error) {
                    console.error('è¼‰å…¥å¤±æ•—:', error);
                    this.log(`è¼‰å…¥å¤±æ•—: ${error.message}`, 'error');
                    document.getElementById('videoLoading').classList.add('hidden');
                }
            }
            
            handleVideoLoaded(detail) {
                const { file, info } = detail;
                this.log(`è¦–è¨Šè¼‰å…¥å®Œæˆ: ${info.width}Ã—${info.height}`, 'success');
            }
            
            handleVideoError(detail) {
                this.log(`è¦–è¨ŠéŒ¯èª¤: ${detail.error}`, 'error');
            }
            
            handleStreamingProgress(detail) {
                const { loaded, total, percentage } = detail;
                
                // æ›´æ–°é€²åº¦
                document.getElementById('loadProgress').textContent = `${percentage.toFixed(1)}%`;
                document.getElementById('chunkCount').textContent = `${loaded} / ${total}`;
                
                // æ›´æ–°ç·©è¡æ™‚é–“
                const video = this.player.video;
                if (video.buffered.length > 0) {
                    const bufferedEnd = video.buffered.end(video.buffered.length - 1);
                    const bufferedTime = bufferedEnd - video.currentTime;
                    document.getElementById('bufferedTime').textContent = `${bufferedTime.toFixed(1)}s`;
                }
            }
            
            switchTab(tabName) {
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tab === tabName);
                });
                
                document.querySelectorAll('.panel-content').forEach(panel => {
                    panel.classList.add('hidden');
                });
                
                const targetPanel = document.getElementById(`${tabName}Panel`);
                if (targetPanel) {
                    targetPanel.classList.remove('hidden');
                }
            }
            
            setupTheme() {
                const savedTheme = localStorage.getItem('whisper_theme') || 'light';
                document.documentElement.setAttribute('data-theme', savedTheme);
            }
            
            toggleTheme() {
                const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('whisper_theme', newTheme);
            }
            
            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = `<div class="log-entry"><span class="log-time">${timestamp}</span> <span class="log-${type}">${message}</span></div>`;
                
                this.logEntries.push(logEntry);
                if (this.logEntries.length > 100) {
                    this.logEntries.shift();
                }
                
                const logContainer = document.getElementById('streamingLog');
                logContainer.innerHTML = this.logEntries.join('');
                logContainer.scrollTop = logContainer.scrollHeight;
            }
            
            formatFileSize(bytes) {
                const sizes = ['B', 'KB', 'MB', 'GB'];
                if (bytes === 0) return '0 B';
                const i = Math.floor(Math.log(bytes) / Math.log(1024));
                return (bytes / Math.pow(1024, i)).toFixed(2) + ' ' + sizes[i];
            }
        }
        
        // åˆå§‹åŒ–æ‡‰ç”¨
        const app = new MSETestApp();
        window.mseTestApp = app;
    </script>
</body>
</html>