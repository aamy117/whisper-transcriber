<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MSE 串流測試 - Whisper 視訊工具</title>
    <link rel="stylesheet" href="css/shared.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/video.css">
    <style>
        .test-info {
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .test-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .status-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }
        
        .status-icon.success {
            background: #10b981;
        }
        
        .status-icon.error {
            background: #ef4444;
        }
        
        .status-icon.warning {
            background: #f59e0b;
        }
        
        .status-icon.info {
            background: #3b82f6;
        }
        
        .streaming-info {
            font-family: monospace;
            background: #f3f4f6;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .progress-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .progress-item {
            background: var(--surface-color);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .progress-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .progress-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .streaming-log {
            max-height: 300px;
            overflow-y: auto;
            background: #1f2937;
            color: #f3f4f6;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.875rem;
            line-height: 1.5;
        }
        
        .log-entry {
            margin: 2px 0;
        }
        
        .log-time {
            color: #9ca3af;
        }
        
        .log-info {
            color: #60a5fa;
        }
        
        .log-success {
            color: #34d399;
        }
        
        .log-error {
            color: #f87171;
        }
        
        .log-warning {
            color: #fbbf24;
        }
    </style>
</head>
<body>
    <!-- 導航列 -->
    <nav class="app-navigation">
        <div class="nav-container">
            <div class="nav-brand">
                <h1 class="nav-title">Whisper 工具</h1>
            </div>
            <div class="nav-links">
                <a href="index.html" class="nav-link">
                    <span class="nav-icon">🎵</span>
                    <span>音訊工具</span>
                </a>
                <a href="video.html" class="nav-link">
                    <span class="nav-icon">🎬</span>
                    <span>視訊工具</span>
                </a>
                <a href="video-mse-test.html" class="nav-link active">
                    <span class="nav-icon">🧪</span>
                    <span>MSE 測試</span>
                </a>
            </div>
        </div>
    </nav>

    <div id="video-app">
        <header class="app-header">
            <div class="container">
                <h1 class="app-title">MSE 串流測試</h1>
                <nav class="app-nav">
                    <button class="nav-btn" id="themeToggleBtn" title="切換深色/淺色模式">
                        <span class="icon icon-light">🌞</span>
                        <span class="icon icon-dark">🌙</span>
                    </button>
                </nav>
            </div>
        </header>

        <main class="video-main">
            <div class="container">
                <!-- MSE 支援檢測 -->
                <div class="test-info">
                    <h2>瀏覽器支援檢測</h2>
                    <div id="supportStatus"></div>
                </div>

                <!-- 視訊載入區 -->
                <div class="video-layout">
                    <section class="video-section">
                        <!-- 上傳區域 -->
                        <div class="video-upload-area" id="videoUploadArea">
                            <div class="upload-content">
                                <span class="upload-icon">🎬</span>
                                <h2>上傳大型影片檔案測試 MSE</h2>
                                <p>拖放檔案到此處，或點擊選擇檔案</p>
                                <p class="upload-hint">建議使用 100MB 以上的檔案測試串流功能</p>
                                <input type="file" id="videoInput" accept="video/*" hidden>
                                <button class="btn btn-primary" id="selectVideoBtn">選擇檔案</button>
                            </div>
                        </div>

                        <!-- 視訊播放器容器 -->
                        <div class="video-player-container hidden" id="videoPlayerContainer">
                            <div class="video-wrapper" id="videoWrapper">
                                <video id="videoPlayer" controls preload="metadata"></video>
                                
                                <!-- 載入指示器 -->
                                <div class="video-loading hidden" id="videoLoading">
                                    <div class="loading-spinner"></div>
                                    <p class="loading-text">載入中...</p>
                                </div>
                            </div>
                            
                            <!-- 串流資訊 -->
                            <div class="streaming-info" id="streamingInfo">
                                載入模式：<span id="loadingMode">-</span>
                            </div>
                        </div>
                    </section>

                    <!-- 右側：串流資訊面板 -->
                    <aside class="side-panel">
                        <div class="panel-tabs">
                            <button class="tab-btn active" data-tab="progress">串流進度</button>
                            <button class="tab-btn" data-tab="log">除錯日誌</button>
                        </div>

                        <!-- 進度面板 -->
                        <div class="panel-content active" id="progressPanel">
                            <div class="progress-info">
                                <div class="progress-item">
                                    <div class="progress-label">檔案大小</div>
                                    <div class="progress-value" id="fileSize">-</div>
                                </div>
                                <div class="progress-item">
                                    <div class="progress-label">載入進度</div>
                                    <div class="progress-value" id="loadProgress">-</div>
                                </div>
                                <div class="progress-item">
                                    <div class="progress-label">分塊數量</div>
                                    <div class="progress-value" id="chunkCount">-</div>
                                </div>
                                <div class="progress-item">
                                    <div class="progress-label">緩衝時間</div>
                                    <div class="progress-value" id="bufferedTime">-</div>
                                </div>
                            </div>
                        </div>

                        <!-- 日誌面板 -->
                        <div class="panel-content hidden" id="logPanel">
                            <div class="streaming-log" id="streamingLog"></div>
                        </div>
                    </aside>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import VideoConfig from './js/video/video-config.js';
        import { VideoPlayer } from './js/video/video-player.js';
        import { VideoUI } from './js/video/video-ui.js';
        import { isMSESupported, getMSESupport } from './js/video/video-streaming.js';
        
        class MSETestApp {
            constructor() {
                this.player = null;
                this.ui = null;
                this.logEntries = [];
                
                this.init();
            }
            
            async init() {
                // 等待 DOM 載入
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => this.setup());
                } else {
                    await this.setup();
                }
            }
            
            async setup() {
                try {
                    // 檢測 MSE 支援
                    this.checkMSESupport();
                    
                    // 初始化播放器
                    const videoElement = document.getElementById('videoPlayer');
                    this.player = new VideoPlayer(videoElement);
                    this.ui = new VideoUI(this.player);
                    
                    // 綁定事件
                    this.bindEvents();
                    
                    // 設定主題
                    this.setupTheme();
                    
                    this.log('MSE 測試應用初始化完成', 'success');
                    
                } catch (error) {
                    console.error('初始化失敗:', error);
                    this.log(`初始化失敗: ${error.message}`, 'error');
                }
            }
            
            checkMSESupport() {
                const supportStatus = document.getElementById('supportStatus');
                const support = getMSESupport();
                
                if (!support.supported) {
                    supportStatus.innerHTML = `
                        <div class="test-status">
                            <div class="status-icon error"></div>
                            <span>您的瀏覽器不支援 Media Source Extensions</span>
                        </div>
                    `;
                    return;
                }
                
                let html = `
                    <div class="test-status">
                        <div class="status-icon success"></div>
                        <span>支援 Media Source Extensions</span>
                    </div>
                `;
                
                // 檢查格式支援
                const formats = support.formats;
                
                if (formats.mp4.h264) {
                    html += `
                        <div class="test-status">
                            <div class="status-icon success"></div>
                            <span>支援 MP4 (H.264)</span>
                        </div>
                    `;
                }
                
                if (formats.webm.vp8 || formats.webm.vp9) {
                    html += `
                        <div class="test-status">
                            <div class="status-icon success"></div>
                            <span>支援 WebM (VP8/VP9)</span>
                        </div>
                    `;
                }
                
                supportStatus.innerHTML = html;
            }
            
            bindEvents() {
                // 檔案選擇
                const fileInput = document.getElementById('videoInput');
                const selectBtn = document.getElementById('selectVideoBtn');
                const uploadArea = document.getElementById('videoUploadArea');
                
                selectBtn.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', (e) => this.handleFileSelect(e.target.files));
                
                // 拖放
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('drag-over');
                });
                
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('drag-over');
                });
                
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('drag-over');
                    this.handleFileSelect(e.dataTransfer.files);
                });
                
                // 視訊事件
                const video = this.player.video;
                video.addEventListener('video:loadeddata', (e) => this.handleVideoLoaded(e.detail));
                video.addEventListener('video:error', (e) => this.handleVideoError(e.detail));
                video.addEventListener('video:streamingprogress', (e) => this.handleStreamingProgress(e.detail));
                video.addEventListener('streaming:progress', (e) => this.handleStreamingProgress(e.detail));
                
                // 標籤切換
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', () => this.switchTab(btn.dataset.tab));
                });
                
                // 主題切換
                const themeToggleBtn = document.getElementById('themeToggleBtn');
                if (themeToggleBtn) {
                    themeToggleBtn.addEventListener('click', () => this.toggleTheme());
                }
            }
            
            async handleFileSelect(files) {
                if (!files || files.length === 0) return;
                
                const file = files[0];
                
                this.log(`選擇檔案: ${file.name} (${this.formatFileSize(file.size)})`, 'info');
                
                // 更新檔案資訊
                document.getElementById('fileSize').textContent = this.formatFileSize(file.size);
                
                try {
                    // 顯示載入中
                    document.getElementById('videoLoading').classList.remove('hidden');
                    
                    // 載入視訊
                    const info = await this.player.loadFile(file);
                    
                    // 顯示播放器
                    document.getElementById('videoUploadArea').classList.add('hidden');
                    document.getElementById('videoPlayerContainer').classList.remove('hidden');
                    
                    // 更新載入模式
                    const loadingMode = this.player.state.isStreaming ? '串流載入 (MSE)' : '直接載入';
                    document.getElementById('loadingMode').textContent = loadingMode;
                    
                    if (this.player.state.isStreaming) {
                        const totalChunks = Math.ceil(file.size / VideoConfig.streaming.chunkSize);
                        document.getElementById('chunkCount').textContent = `0 / ${totalChunks}`;
                        this.log(`使用 MSE 串流載入，共 ${totalChunks} 個分塊`, 'success');
                    } else {
                        this.log('檔案大小未達串流門檻，使用直接載入', 'warning');
                    }
                    
                    // 隱藏載入中
                    document.getElementById('videoLoading').classList.add('hidden');
                    
                } catch (error) {
                    console.error('載入失敗:', error);
                    this.log(`載入失敗: ${error.message}`, 'error');
                    document.getElementById('videoLoading').classList.add('hidden');
                }
            }
            
            handleVideoLoaded(detail) {
                const { file, info } = detail;
                this.log(`視訊載入完成: ${info.width}×${info.height}`, 'success');
            }
            
            handleVideoError(detail) {
                this.log(`視訊錯誤: ${detail.error}`, 'error');
            }
            
            handleStreamingProgress(detail) {
                const { loaded, total, percentage } = detail;
                
                // 更新進度
                document.getElementById('loadProgress').textContent = `${percentage.toFixed(1)}%`;
                document.getElementById('chunkCount').textContent = `${loaded} / ${total}`;
                
                // 更新緩衝時間
                const video = this.player.video;
                if (video.buffered.length > 0) {
                    const bufferedEnd = video.buffered.end(video.buffered.length - 1);
                    const bufferedTime = bufferedEnd - video.currentTime;
                    document.getElementById('bufferedTime').textContent = `${bufferedTime.toFixed(1)}s`;
                }
            }
            
            switchTab(tabName) {
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tab === tabName);
                });
                
                document.querySelectorAll('.panel-content').forEach(panel => {
                    panel.classList.add('hidden');
                });
                
                const targetPanel = document.getElementById(`${tabName}Panel`);
                if (targetPanel) {
                    targetPanel.classList.remove('hidden');
                }
            }
            
            setupTheme() {
                const savedTheme = localStorage.getItem('whisper_theme') || 'light';
                document.documentElement.setAttribute('data-theme', savedTheme);
            }
            
            toggleTheme() {
                const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('whisper_theme', newTheme);
            }
            
            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = `<div class="log-entry"><span class="log-time">${timestamp}</span> <span class="log-${type}">${message}</span></div>`;
                
                this.logEntries.push(logEntry);
                if (this.logEntries.length > 100) {
                    this.logEntries.shift();
                }
                
                const logContainer = document.getElementById('streamingLog');
                logContainer.innerHTML = this.logEntries.join('');
                logContainer.scrollTop = logContainer.scrollHeight;
            }
            
            formatFileSize(bytes) {
                const sizes = ['B', 'KB', 'MB', 'GB'];
                if (bytes === 0) return '0 B';
                const i = Math.floor(Math.log(bytes) / Math.log(1024));
                return (bytes / Math.pow(1024, i)).toFixed(2) + ' ' + sizes[i];
            }
        }
        
        // 初始化應用
        const app = new MSETestApp();
        window.mseTestApp = app;
    </script>
</body>
</html>