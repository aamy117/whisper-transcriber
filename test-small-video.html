<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°æª”æ¡ˆè¦–è¨Šæ¸¬è©¦</title>
    <link rel="stylesheet" href="css/shared.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h2 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-top: 0;
        }
        
        .video-container {
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        #videoPlayer {
            width: 100%;
            height: auto;
            display: block;
        }
        
        .file-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            font-family: monospace;
        }
        
        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 20px 0;
        }
        
        #fileInput {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .test-results {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .test-results h3 {
            margin-top: 0;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <h1>ğŸ¬ å°æª”æ¡ˆè¦–è¨Šæ¸¬è©¦</h1>
    
    <div class="test-section">
        <h2>æ¸¬è©¦èªªæ˜</h2>
        <p>é€™å€‹é é¢å°ˆé–€æ¸¬è©¦å°æª”æ¡ˆï¼ˆ< 10MBï¼‰çš„è¦–è¨Šæ’­æ”¾ï¼Œä½¿ç”¨å‚³çµ±è¼‰å…¥æ–¹å¼è€Œéä¸²æµè¼‰å…¥ã€‚</p>
        <ul>
            <li>æ”¯æ´æ ¼å¼ï¼šMP4, WebM, Ogg</li>
            <li>æª”æ¡ˆå¤§å°ï¼šå»ºè­°å°æ–¼ 10MB</li>
            <li>è¼‰å…¥æ–¹å¼ï¼šç›´æ¥è¼‰å…¥æ•´å€‹æª”æ¡ˆåˆ°è¨˜æ†¶é«”</li>
        </ul>
    </div>
    
    <div class="test-section">
        <h2>é¸æ“‡è¦–è¨Šæª”æ¡ˆ</h2>
        <div class="controls">
            <input type="file" id="fileInput" accept="video/*">
            <button onclick="loadSampleVideo()">è¼‰å…¥ç¯„ä¾‹è¦–è¨Š</button>
        </div>
        <div id="status"></div>
    </div>
    
    <div class="test-section">
        <h2>è¦–è¨Šæ’­æ”¾å™¨</h2>
        <div id="videoWrapper">
            <div id="videoUploadArea">
                <p style="text-align: center; color: #666;">è«‹é¸æ“‡è¦–è¨Šæª”æ¡ˆ</p>
            </div>
            <div id="videoPlayerContainer" style="display: none;">
                <div class="video-container">
                    <video id="videoPlayer" controls></video>
                </div>
                <div class="file-info" id="fileInfo"></div>
                <div id="videoControls" style="display: flex; gap: 10px; justify-content: center;">
                    <button id="playPauseBtn">æ’­æ”¾/æš«åœ</button>
                    <button onclick="testSeek()">æ¸¬è©¦è·³è½‰</button>
                    <button onclick="testSpeed()">æ¸¬è©¦é€Ÿåº¦</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="test-section">
        <h2>æ¸¬è©¦çµæœ</h2>
        <div class="test-results" id="testResults">
            <h3>è¼‰å…¥è³‡è¨Š</h3>
            <div id="loadInfo">ç­‰å¾…è¼‰å…¥è¦–è¨Š...</div>
        </div>
    </div>
    
    <!-- éš±è—çš„å¿…è¦å…ƒç´ ï¼ˆç‚ºäº†ç›¸å®¹ VideoUIï¼‰ -->
    <div style="display: none;">
        <button id="skipBackBtn"></button>
        <button id="skipForwardBtn"></button>
        <div id="progressContainer"></div>
        <input id="progressSlider" type="range">
        <div id="progressPlayed"></div>
        <div id="progressBuffered"></div>
        <span id="currentTime">00:00</span>
        <span id="totalTime">00:00</span>
        <button id="muteBtn"></button>
        <input id="volumeSlider" type="range">
        <button id="speedBtn"><span class="speed-text">1x</span></button>
        <div id="speedMenu"></div>
        <button id="fullscreenBtn"></button>
    </div>
    
    <script type="module">
        import domReadyManager from './js/video/dom-ready-manager.js';
        import { VideoPlayer } from './js/video/video-player.js';
        import { VideoUI } from './js/video/video-ui.js';
        
        let player = null;
        let ui = null;
        let startTime = 0;
        
        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.className = `status-message status-${type}`;
            status.textContent = message;
        }
        
        function updateLoadInfo(info) {
            const loadInfo = document.getElementById('loadInfo');
            const items = Object.entries(info).map(([key, value]) => 
                `<div class="result-item">
                    <span>${key}:</span>
                    <span><strong>${value}</strong></span>
                </div>`
            ).join('');
            loadInfo.innerHTML = items;
        }
        
        async function loadVideo(file) {
            startTime = performance.now();
            
            try {
                showStatus(`æ­£åœ¨è¼‰å…¥ ${file.name}...`, 'info');
                
                const videoElement = document.getElementById('videoPlayer');
                
                if (!player) {
                    // ç­‰å¾… DOM å°±ç·’
                    await domReadyManager.waitForReady();
                    
                    player = new VideoPlayer(videoElement);
                    ui = new VideoUI(player);
                    
                    // åˆå§‹åŒ– UI
                    await ui.initialize();
                    
                    // ç›£è½äº‹ä»¶
                    videoElement.addEventListener('video:loadeddata', (e) => {
                        const loadTime = ((performance.now() - startTime) / 1000).toFixed(2);
                        showStatus('è¦–è¨Šè¼‰å…¥æˆåŠŸï¼', 'success');
                        
                        const info = e.detail.info;
                        updateLoadInfo({
                            'æª”æ¡ˆåç¨±': info.fileName,
                            'æª”æ¡ˆå¤§å°': formatFileSize(info.fileSize),
                            'æª”æ¡ˆé¡å‹': info.fileType,
                            'è¦–è¨Šå°ºå¯¸': `${info.width} Ã— ${info.height}`,
                            'è¦–è¨Šé•·åº¦': formatTime(info.duration),
                            'è¼‰å…¥æ™‚é–“': `${loadTime} ç§’`,
                            'è¼‰å…¥æ–¹å¼': player.useStreaming ? 'ä¸²æµè¼‰å…¥' : 'å‚³çµ±è¼‰å…¥'
                        });
                        
                        // æ›´æ–°æª”æ¡ˆè³‡è¨Š
                        document.getElementById('fileInfo').innerHTML = `
                            <strong>${info.fileName}</strong> | 
                            ${formatFileSize(info.fileSize)} | 
                            ${info.width}Ã—${info.height} | 
                            ${formatTime(info.duration)}
                        `;
                    });
                    
                    videoElement.addEventListener('video:error', (e) => {
                        showStatus(`éŒ¯èª¤: ${e.detail.error}`, 'error');
                    });
                    
                    videoElement.addEventListener('video:warning', (e) => {
                        showStatus(`è­¦å‘Š: ${e.detail.message}`, 'info');
                    });
                }
                
                await player.loadFile(file);
                
                document.getElementById('videoUploadArea').style.display = 'none';
                document.getElementById('videoPlayerContainer').style.display = 'block';
                
            } catch (error) {
                showStatus(`è¼‰å…¥å¤±æ•—: ${error.message}`, 'error');
                console.error('è¼‰å…¥éŒ¯èª¤:', error);
            }
        }
        
        // æª”æ¡ˆé¸æ“‡
        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                loadVideo(file);
            }
        });
        
        // æ’­æ”¾æ§åˆ¶
        document.getElementById('playPauseBtn').addEventListener('click', () => {
            if (player) {
                player.togglePlayPause();
            }
        });
        
        // è¼‰å…¥ç¯„ä¾‹è¦–è¨Š
        window.loadSampleVideo = async function() {
            try {
                showStatus('æ­£åœ¨è¼‰å…¥ç¯„ä¾‹è¦–è¨Š...', 'info');
                const response = await fetch('https://www.w3schools.com/html/mov_bbb.mp4');
                const blob = await response.blob();
                const file = new File([blob], 'big_buck_bunny.mp4', { type: 'video/mp4' });
                loadVideo(file);
            } catch (error) {
                showStatus(`è¼‰å…¥ç¯„ä¾‹å¤±æ•—: ${error.message}`, 'error');
            }
        };
        
        // æ¸¬è©¦åŠŸèƒ½
        window.testSeek = function() {
            if (player && player.video.duration) {
                const randomTime = Math.random() * player.video.duration;
                player.seek(randomTime);
                showStatus(`è·³è½‰åˆ° ${formatTime(randomTime)}`, 'info');
            }
        };
        
        window.testSpeed = function() {
            if (player) {
                const speeds = [0.5, 0.75, 1, 1.25, 1.5, 2];
                const currentIndex = speeds.indexOf(player.video.playbackRate);
                const nextIndex = (currentIndex + 1) % speeds.length;
                player.setPlaybackRate(speeds[nextIndex]);
                showStatus(`æ’­æ”¾é€Ÿåº¦: ${speeds[nextIndex]}x`, 'info');
            }
        };
        
        function formatFileSize(bytes) {
            const sizes = ['B', 'KB', 'MB', 'GB'];
            if (bytes === 0) return '0 B';
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return (bytes / Math.pow(1024, i)).toFixed(2) + ' ' + sizes[i];
        }
        
        function formatTime(seconds) {
            if (!seconds || !isFinite(seconds)) return '00:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
    </script>
</body>
</html>